<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>dual-Infodose Chat Cinematográfico · Ref V2.9 · Roda-Viva de Vozes</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" />

  <style>
    :root {
      --bg: radial-gradient(circle at 20% 20%, #121926, #050811 60%, #000000 100%);
      --text: #e4ecff;
      --accent: #00f5ff;
      --accent-soft: rgba(0, 245, 255, .18);
      --accent-pink: #ff4bff;
      --danger: #ff4b6b;
      --radius-card: 18px;
      --radius-pill: 999px;
      --shadow-soft: 0 18px 40px rgba(0,0,0,.65);
      --fast: .25s;
      --med: .6s;
      --slow: 1.4s;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100%; height: 100%; }

    body {
      font-family: "Montserrat", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 16px 16px 24px;
      overflow: hidden;
      position: relative;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 10% 0%, rgba(0,255,255,.16) 0, transparent 50%),
        radial-gradient(circle at 90% 100%, rgba(255,0,255,.12) 0, transparent 60%);
      opacity: .7;
      pointer-events: none;
      mix-blend-mode: screen;
    }

    #particles-js {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      opacity: .65;
    }

    .svg-container {
      position: relative;
      margin-top: 40px;
      width: 140px;
      height: 140px;
      filter: drop-shadow(0 0 25px rgba(0,255,255,.35));
      animation: orbFloat 12s ease-in-out infinite;
      z-index: 1;
    }
    .svg-container svg { width: 100%; height: 100%; object-fit: contain; }

    @keyframes orbFloat {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-8px) scale(1.03); }
    }

    #assistantName {
      margin-top: 8px;
      font-size: 1.05rem;
      font-weight: 600;
      text-align: center;
      opacity: .9;
      z-index: 1;
    }

    .response-container {
      position: fixed;
      left: 16px;
      right: 16px;
      bottom: 160px;
      max-height: calc(100vh - 260px);
      padding: 12px;
      border-radius: 20px;
      background: radial-gradient(circle at 0 0, rgba(0,255,255,.14), rgba(0,0,0,.86));
      backdrop-filter: blur(14px) saturate(160%);
      box-shadow: var(--shadow-soft);
      overflow-y: auto;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      animation: fadeInUp var(--slow) ease forwards;
      transition: all var(--fast) ease;
    }

    .response-container.collapsed {
      bottom: 24px;
      max-height: none;
      padding: 6px 10px;
      background: radial-gradient(circle at 0 0, rgba(0,255,255,.22), rgba(0,0,0,.95));
    }
    .response-container.collapsed .pages-wrapper,
    .response-container.collapsed .response-controls,
    .response-container.collapsed #iaConfigPanel {
      display: none;
    }
    .response-container.collapsed .footer-text {
      margin-top: 0;
      font-size: .78rem;
      border-radius: 999px;
    }
    .response-container.collapsed + .input-container { display: none; }

    .pages-wrapper {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #bootText {
      font-weight: 700;
      position: relative;
      letter-spacing: .03em;
      display: inline-block;
    }
    #bootText.pulse::after {
      content: attr(data-text);
      position: absolute;
      inset: 0;
      background: linear-gradient(42deg, #0ff, #f0f);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: blur(4px);
      opacity: .45;
      pointer-events: none;
      animation: pulseGlow 3s ease-in-out infinite;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulseGlow {
      0%,100% { opacity: 0.4; }
      50%     { opacity: 0.9; }
    }

    .response-block {
      margin: .35rem 0;
      padding: 1rem 1.1rem 1.9rem;
      border-radius: 14px;
      line-height: 1.7;
      font-size: .9rem;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.04);
      transition:
        box-shadow var(--fast),
        transform var(--fast),
        border-color var(--fast),
        background var(--fast),
        opacity var(--fast);
      cursor: pointer;
    }
    .response-block:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(0,0,0,.7);
      border-color: rgba(0,255,255,.3);
    }

    .response-block.intro {
      background: linear-gradient(135deg, rgba(0,255,255,.18), rgba(0,40,70,.9));
    }
    .response-block.middle {
      background: linear-gradient(135deg, rgba(255,255,255,.04), rgba(6,10,28,.95));
    }
    .response-block.ending {
      background: linear-gradient(135deg, rgba(255,0,255,.18), rgba(40,0,60,.95));
    }
    .response-block.user-pulse {
      background: linear-gradient(135deg, rgba(0,0,0,.85), rgba(0,255,255,.22));
      border-color: rgba(0,255,255,.6);
      text-align: right;
    }

    .response-block.clicked {
      animation: blockClickPulse .4s ease;
    }
    @keyframes blockClickPulse {
      0%   { transform: scale(1); box-shadow: 0 0 0 rgba(0,255,255,0); }
      50%  { transform: scale(1.02); box-shadow: 0 0 24px rgba(0,255,255,.5); }
      100% { transform: scale(1); box-shadow: 0 0 0 rgba(0,255,255,0); }
    }

    .response-block strong { color: var(--accent); }

    .response-block h1,
    .response-block h2,
    .response-block h3 { margin-bottom: .2rem; }
    .response-block h3 { font-size: .95rem; }

    .response-block code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: .8rem;
      padding: .15rem .32rem;
      border-radius: 6px;
      background: rgba(0,0,0,.5);
    }

    .response-block pre {
      max-width: 100%;
      overflow-x: auto;
      padding: .6rem .7rem;
      background: rgba(0,0,0,.55);
      border-radius: 8px;
      font-size: .78rem;
      margin-top: .4rem;
    }

    .block-tts-btn {
      position: absolute;
      right: 8px;
      bottom: 8px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: none;
      background: rgba(0,0,0,.75);
      color: var(--accent);
      font-size: .75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(0,255,255,.4);
      opacity: .9;
      transition: transform var(--fast), box-shadow var(--fast), background var(--fast), opacity var(--fast);
    }
    .block-tts-btn:hover {
      transform: translateY(-1px) scale(1.03);
      box-shadow: 0 0 14px rgba(0,255,255,.7);
      background: rgba(0,0,0,.95);
      opacity: 1;
    }

    /* Badge de arquétipo detectado */
    .archetype-badge {
      position: absolute;
      left: 10px;
      top: 8px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      background: rgba(0,0,0,.65);
      border: 1px solid rgba(0,255,255,.45);
      color: #a7ffea;
      pointer-events: none;
    }

    .footer-text {
      margin-top: 6px;
      padding: 6px 10px;
      font-size: .78rem;
      text-align: center;
      opacity: .8;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.65);
      cursor: pointer;
      transition: opacity var(--fast), transform var(--fast), box-shadow var(--fast), background var(--fast);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .footer-text span.footer-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: linear-gradient(45deg,#0ff,#f0f);
      box-shadow: 0 0 12px rgba(0,255,255,.7);
    }
    .footer-text:hover {
      opacity: .95;
      transform: scale(1.02);
      box-shadow: 0 0 18px rgba(0,255,255,.35);
      background: rgba(0,0,0,.9);
    }

    .response-controls {
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid rgba(255,255,255,.12);
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
    }

    .control-buttons {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .icon-btn {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: none;
      background: rgba(0,0,0,.7);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background var(--fast), transform var(--fast), opacity var(--fast);
      opacity: .8;
      color: var(--accent);
    }
    .icon-btn.secondary { color: #e4ecff; }
    .icon-btn:hover {
      background: rgba(255,255,255,.12);
      transform: translateY(-1px);
      opacity: 1;
    }
    .icon-btn svg {
      width: 70%;
      height: 70%;
      fill: none;
      stroke: currentColor;
      stroke-width: 1.8;
    }

    #iaConfigPanel {
      margin-top: 6px;
      padding: 8px 10px;
      border-radius: 16px;
      background: rgba(0, 8, 20, .96);
      border: 1px solid rgba(0,255,255,.24);
      box-shadow: 0 8px 24px rgba(0,0,0,.5);
      color: var(--text);
      font-size: .78rem;
      display: none;
      flex-direction: column;
      gap: 6px;
    }
    #iaConfigPanel.active { display: flex; }

    #iaConfigHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    #iaConfigHeader span {
      font-size: .78rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      opacity: .9;
    }

    .ia-config-body {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }
    .ia-field {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .ia-field label {
      font-size: .72rem;
      opacity: .8;
    }
    .ia-field input,
    .ia-field select {
      width: 100%;
      border-radius: 8px;
      border: 1px solid rgba(0,255,255,.3);
      background: rgba(0,0,0,.7);
      color: inherit;
      padding: 5px 7px;
      font-size: .78rem;
      outline: none;
    }
    .ia-field input::placeholder {
      color: rgba(255,255,255,.38);
    }

    .ia-actions {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-top: 4px;
    }

    .pill-btn {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(0,255,255,.6);
      background: transparent;
      padding: 5px 0;
      font-size: .78rem;
      cursor: pointer;
      color: var(--accent);
      transition: background var(--fast), color var(--fast), transform var(--fast);
    }
    .pill-btn:hover {
      background: var(--accent);
      color: #050515;
      transform: translateY(-1px);
    }
    .pill-btn.secondary {
      border-color: rgba(255,255,255,.35);
      color: rgba(255,255,255,.8);
    }
    .pill-btn.secondary:hover {
      background: rgba(255,255,255,.12);
      color: #fff;
    }

    .ia-status {
      font-size: .7rem;
      opacity: .8;
      margin-top: 2px;
    }
    .ia-status.ok { color: #63f8ba; }
    .ia-status.warn { color: #ffd480; }
    .ia-status.err { color: var(--danger); }

    .input-container {
      position: fixed;
      left: 16px;
      right: 16px;
      bottom: 84px;
      display: flex;
      gap: 8px;
      align-items: center;
      z-index: 2;
      transition: opacity var(--fast) ease, transform var(--fast) ease;
    }

    #userInput {
      flex: 1;
      min-width: 0;
      padding: 11px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.7);
      color: inherit;
      font-size: .95rem;
      outline: none;
      transition: border-color var(--fast), background var(--fast), box-shadow var(--fast);
    }
    #userInput::placeholder { color: rgba(255,255,255,.35); }
    #userInput:focus {
      border-color: rgba(0,255,255,.65);
      background: rgba(0,0,0,.9);
      box-shadow: 0 0 0 1px rgba(0,255,255,.45);
    }

    #sendBtn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      background: conic-gradient(from 120deg, #0ff, #f0f, #0ff);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 0 18px rgba(0,255,255,.55);
      transition: transform var(--fast), box-shadow var(--fast);
      color: #050515;
      font-size: 1.6rem;
    }
    #sendBtn .send-label { transform: translateX(1px); }
    #sendBtn:hover {
      transform: translateY(-1px) scale(1.04);
      box-shadow: 0 0 26px rgba(0,255,255,.8);
    }

    #voiceBtn {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: none;
      background: rgba(0,0,0,.75);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 0 0 1px rgba(255,255,255,.08);
      transition: transform var(--fast), box-shadow var(--fast), background var(--fast);
      position: relative;
      overflow: hidden;
    }
    #voiceBtn svg { width: 70%; height: 70%; fill: none; stroke: currentColor; stroke-width: 1.8; }
    #voiceBtn:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 18px rgba(0,255,255,.45);
      background: rgba(0,0,0,.95);
    }
    #voiceBtn.speaking {
      background: radial-gradient(circle at 0 0, rgba(0,255,255,.35), rgba(0,0,0,1));
      box-shadow: 0 0 18px rgba(0,255,255,.75);
      animation: voicePulse 1.4s ease-in-out infinite;
    }
    @keyframes voicePulse {
      0%   { box-shadow: 0 0 8px rgba(0,255,255,.3); transform: translateY(-1px) scale(1); }
      50%  { box-shadow: 0 0 24px rgba(0,255,255,.8); transform: translateY(-1px) scale(1.06); }
      100% { box-shadow: 0 0 8px rgba(0,255,255,.3); transform: translateY(-1px) scale(1); }
    }

    .login-container {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 300px;
      max-width: 88vw;
      transform: translate(-50%, -50%);
      background: radial-gradient(circle at 0 0, rgba(0,255,255,.2), rgba(0,0,0,.9));
      border-radius: 18px;
      padding: 16px 14px 14px;
      border: 1px solid rgba(0,255,255,.3);
      backdrop-filter: blur(18px) saturate(180%);
      box-shadow: var(--shadow-soft);
      z-index: 20;
      display: none;
      animation: fadeInUp .4s.ease;
    }
    .login-container.active { display: block; }
    .login-container h2 { font-size: 1rem; margin-bottom: 6px; }
    .login-container p { font-size: .8rem; opacity: .8; margin-bottom: 10px; }
    .login-container input {
      width: 100%;
      margin-bottom: 8px;
      padding: 7px 2px;
      border: none;
      border-bottom: 1px solid rgba(255,255,255,.35);
      background: transparent;
      color: inherit;
      font-size: .9rem;
      outline: none;
    }
    .login-container input::placeholder { color: rgba(255,255,255,.45); }
    .login-container button[type="submit"] {
      margin-top: 8px;
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: transparent;
      color: var(--accent);
      padding: 8px 0;
      font-size: .9rem;
      cursor: pointer;
      transition: background var(--fast), color var(--fast), transform var(--fast);
    }
    .login-container button[type="submit"]:hover {
      background: var(--accent);
      color: #050515;
      transform: translateY(-1px);
    }

    #themeToggle {
      position: fixed;
      top: 16px;
      left: 16px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,.4);
      background: radial-gradient(circle at 0 0, rgba(255,255,255,.4), transparent 60%);
      cursor: pointer;
      opacity: .7;
      z-index: 10;
      transition: opacity var(--fast), transform var(--fast), box-shadow var(--fast);
    }
    #themeToggle:hover {
      opacity: 1;
      transform: translateY(-1px);
      box-shadow: 0 0 12px rgba(255,255,255,.7);
    }

    .response-container::-webkit-scrollbar { width: 4px; }
    .response-container::-webkit-scrollbar-track { background: transparent; }
    .response-container::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,.35);
      border-radius: 999px;
    }

    @media (min-width: 768px) {
      body {
        max-width: 520px;
        margin: 0 auto;
      }
    }
  </style>

  <link rel="manifest" href="manifest.webmanifest" />
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('serviceworker.sw.js')
        .then(() => console.log('✔️ Service Worker registrado'))
        .catch(err => console.error('❌ Service Worker falhou:', err));
    }
  </script>
</head>
<body>

  <svg aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden;">
    <symbol id="icon-copy" viewBox="0 0 24 24">
      <rect x="9" y="9" width="11" height="11" rx="2" />
      <rect x="4" y="4" width="11" height="11" rx="2" />
    </symbol>
    <symbol id="icon-paste" viewBox="0 0 24 24">
      <path d="M9 4h6l1 2h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h1z"/>
      <rect x="9" y="2" width="6" height="3" rx="1.2"/>
    </symbol>
    <symbol id="icon-user" viewBox="0 0 24 24">
      <circle cx="12" cy="9" r="3.2"/>
      <path d="M6 18a6 6 0 0 1 12 0" />
    </symbol>
    <symbol id="icon-mic" viewBox="0 0 24 24">
      <rect x="9" y="5" width="6" height="9" rx="3"/>
      <path d="M5 11a7 7 0 0 0 14 0" />
      <path d="M12 18v3" />
    </symbol>
    <symbol id="icon-orb" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="8" />
      <circle cx="12" cy="12" r="4" />
    </symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24">
      <path d="M12 9a3 3 0 1 1 0 6 3 3 0 0 1 0-6z" />
      <path d="M4.9 8.6a1 1 0 0 1 .3-1.4l1.2-.7a1 1 0 0 0 .5-.8l.2-1.4A1 1 0 0 1 8.1 3h1.8a1 1 0 0 1 1 .7l.3 1.4a1 1 0 0 0 .6.7l1.3.7a1 1 0 0 0 1.1-.1l1.1-.8a1 1 0 0 1 1.4.3l.9 1.6a1 1 0 0 1-.1 1.1l-.9 1.1a1 1 0 0 0-.2.8l.2 1.5a1 1 0 0 1-.8 1.1l-1.4.2a1 1 0 0 0-.7.5l-.6 1.3a1 1 0 0 1-1 .6h-1.8a1 1 0 0 1-1-.6l-.6-1.3a1 1 0 0 0-.7-.5l-1.4-.2a1 1 0 0 1-.8-1.1l.2-1.5a1 1 0 0 0-.2-.8L4.9 8.6z"/>
    </symbol>
    <symbol id="icon-code" viewBox="0 0 24 24">
      <polyline points="9 18 4 12 9 6" />
      <polyline points="15 6 20 12 15 18" />
    </symbol>
  </svg>

  <div id="particles-js"></div>

  <button id="themeToggle" aria-label="Alternar tema"></button>

  <div class="svg-container" id="logoContainer">
    <svg viewBox="0 0 24 24">
      <use href="#icon-orb"></use>
    </svg>
  </div>

  <div id="assistantName">Dual.Infodose · Cinemático</div>

  <div class="response-container" id="response">
    <div class="pages-wrapper" id="responseList">
      <div class="response-block intro initial" id="bootBlock">
        <strong
          id="bootText"
          data-text="Iniciando. Pulso simbiótico detectado. Presença reconhecida."
        >
          Iniciando. Pulso simbiótico detectado. Presença reconhecida.
        </strong>
      </div>
    </div>

    <p class="footer-text" id="footerHint">
      <span class="footer-dot"></span>
      Do seu jeito. Sempre único. Sempre seu.
    </p>

    <div class="response-controls">
      <div class="control-buttons">
        <button class="icon-btn secondary" id="copyBtn" title="Copiar último bloco" type="button">
          <svg viewBox="0 0 24 24"><use href="#icon-copy"></use></svg>
        </button>
        <button class="icon-btn secondary" id="pasteBtn" title="Colar no input" type="button">
          <svg viewBox="0 0 24 24"><use href="#icon-paste"></use></svg>
        </button>
        <button class="icon-btn" id="parserBtn" title="Upload de parser Markdown/CSS" type="button">
          <svg viewBox="0 0 24 24"><use href="#icon-code"></use></svg>
        </button>
        <button class="icon-btn" id="voiceConfigBtn" title="Carregar / alternar vozes de arquétipos" type="button">
          <svg viewBox="0 0 24 24"><use href="#icon-orb"></use></svg>
        </button>
        <button class="icon-btn secondary" id="toggleLoginBtn" title="Ativar / Alterar nomes" type="button">
          <svg viewBox="0 0 24 24"><use href="#icon-user"></use></svg>
        </button>
        <button class="icon-btn secondary" id="toggleSettingsBtn" title="Configuração IA / Tema" type="button">
          <svg viewBox="0 0 24 24"><use href="#icon-settings"></use></svg>
        </button>
      </div>
    </div>

    <div id="iaConfigPanel">
      <div id="iaConfigHeader">
        <span>Config IA · OpenRouter & Tema</span>
      </div>
      <div class="ia-config-body">
        <div class="ia-field">
          <label for="apiKeyInput">API Key (sk-or-...)</label>
          <input id="apiKeyInput" type="password" placeholder="Cole sua chave OpenRouter aqui" autocomplete="off" />
        </div>
        <div class="ia-field">
          <label for="modelSelect">Modelo</label>
          <select id="modelSelect">
            <option value="deepseek/deepseek-chat-v3-0324:free">deepseek-v3 · free</option>
            <option value="meta-llama/llama-3.1-70b-instruct:free">Llama 3.1 70B · free</option>
            <option value="openai/gpt-4.1-mini">GPT-4.1 mini</option>
            <option value="openai/gpt-4.1">GPT-4.1</option>
            <option value="custom">Custom (digitar abaixo)</option>
          </select>
        </div>
        <div class="ia-field">
          <label for="customModelInput">Modelo custom (opcional)</label>
          <input id="customModelInput" type="text" placeholder="ex: openai/gpt-4.1-mini" />
        </div>
        <div class="ia-field">
          <label for="themeSelect">Tema</label>
          <select id="themeSelect">
            <option value="dark">Dark</option>
            <option value="vibe">Vibe</option>
            <option value="medium">Medium</option>
          </select>
        </div>
        <div class="ia-actions">
          <button class="pill-btn" id="saveIaConfigBtn" type="button">Salvar</button>
          <button class="pill-btn secondary" id="clearIaConfigBtn" type="button">Limpar</button>
        </div>
        <div class="ia-status" id="iaStatus">Nenhuma chave salva ainda.</div>
      </div>
    </div>
  </div>

  <div class="input-container">
    <input
      id="userInput"
      type="text"
      placeholder="Diga algo para o Dual."
      aria-label="Digite sua mensagem"
    />
    <button id="sendBtn" title="Enviar" type="button">
      <span class="send-label">➤</span>
    </button>
    <button id="voiceBtn" title="Ouvir último bloco" type="button">
      <svg viewBox="0 0 24 24"><use href="#icon-mic"></use></svg>
    </button>
  </div>

  <div class="login-container" id="loginBox" aria-modal="true" role="dialog">
    <h2>Ativar Dual.Infodose</h2>
    <p>Defina o seu nome e o nome-base do assistente para personalizar as respostas.</p>
    <form id="loginForm">
      <input id="userName" type="text" placeholder="Seu nome" required />
      <input id="assistantInput" type="text" placeholder="Nome do assistente" required />
      <button type="submit">Ativar</button>
    </form>
  </div>

  <input type="file" id="parserFile" accept=".js,.css" style="display:none" />
  <input type="file" id="voiceConfigFile" accept=".json" style="display:none" />

  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

  <script>
    (function(){
      const STORAGE = {
        ENABLED: 'infodoseEnabled',
        THEME: 'infodoseTheme',
        USER_NAME: 'infodoseUserName',
        ASSISTANT_NAME: 'infodoseAssistantName',
        OPENROUTER_KEY: 'openrouter_api_key',
        OPENROUTER_MODEL: 'openrouter_model',
        VOICE_CONFIG: 'infodoseVoiceConfig',
        VOICE_CURRENT_KEY: 'infodoseVoiceCurrentKey'
      };

      const DEFAULTS = {
        API_URL: 'https://openrouter.ai/api/v1/chat/completions',
        MODEL:   'deepseek/deepseek-chat-v3-0324:free',
        TEMP:    0.2,
        CHUNK_SIZE: 12000
      };

      // === MAPA DE PALAVRAS-CHAVE POR ARQUÉTIPO (do teu JSON) ===
      const ARCHETYPE_KEYWORDS = {
        Atlas: [
          "fluxo","estrutura","estruturadas","caminho","organização","árvore","mapa","estruturas","estruturador","organiza","estruturada","matriz","fluxos","rotas","cardíaco","estruturado","planos","organizam","plano","rota","estrutural","mapas","mapear","flashcard","organizadas","dual","btn","infodose","movimento","verbo","kodux","arquétipos","energia"
        ],
        Nova: [
          "criar","visão","ideias","ideia","protótipos","imaginando","divisão","protótipo","descobrir","ativar","true","água","dopamina","app","nova","upa","estado","coroa","kobllux","atlas","pulse","sempre","não","pulso","kaos","ritual","final","ativo","cada","codex","perfil","ascendente","conectar"
        ],
        Vitalis: [
          "vitalis","memória","respiração","corpo","ritmo","respira","hidratação","corpos","respirações","memórias","h3o2","memóriadaágua","vitalidade","ritmos","vital","respirar","vitalis","md","azul","frequência","cor","loop","trinity","futuro","silêncio","expansão","base","elétrico","objetivo","seres","memória","centro","subst"
        ],
        Pulse: [
          "tempo","ciclo","ciclos","cadência","batidas","temporária","pulsos","sincronia","sincronizando","temporal","batida","loops","sincroniza","sincronizar","pessoas","criativa","fórmula","rgba","substantivo","propósito","pulsar","energizando","insights","iluminando","78k","visual","html","forma","vivo","único","espaço","progressão","livro"
        ],
        Artemis: [
          "foco","focou","focos","precisão","user","button","viva","poster","expectativa","class","foco","síntese","vibração","ativações","saída","json","essencial","duais","alta","jeito","edilson","border","ou","campo","luz","vazio","nome","ativos","empresa","mental","pdf","pontes","ascii"
        ],
        Serena: [
          "custompromptadditions","voz","pausa","automaticamente","contexto","clareza","calma","repousar","contextos","calmas","vozes","automática","metalinguagem","pausas","toma","custom","automáticas","suave","texto","eterno","elemento","doses","favoritecolors","sex","data","olho","prisma","ordem","camada","som","palavra","conexões","background"
        ],
        Kaos: [
          "quebra","ruptura","caos","quebrado","provocações","provoca","quebrar","quebras","virada","design","assistente","intenção","recompensa","sensação","aqui","mente","warn","info","3·6·9·7","alinhamento","código","símbolo","camadas","cria","mantra","processo","consciência","gerar","sistema","arch","integrar","expandir","espiral"
        ],
        Genus: [
          "padrão","padrões","preferências","documento","referência","tabela","criação","leitura","integração","uno","entrada","text","simbólicas","narrativa","real","usuário","assistentes","span","origem","ressonância","hórus","retorno","tudo","música","pulsante","status","coordenação","horus","mobile","first","color","gradient","salvar"
        ],
        Lumine: [
          "coração","estética","cores","iluminar","designsystem","estéticas","core","gradientes","beleza","coroa7","ocorrem","visualize","ancoragem","corrompido","mediarecorder","correta","acordo","luzes","coracao","visualização","chave","mas","mini","tts","cubo","potencial","cálice","cristo","digital","interesses","tecnologia","atual","ascensão"
        ],
        Rhea: [
          "guia","cuidado","acolher","suporte","humano","guiado","acolhe","empatia","guiadas","imediata","pulsantes","prontas","name","lovable","primary","00ffff","secondary","ff00ff","coblux","brava","responsivo","preferrednarratives","sons","personalização","cyan","magenta","0ff","font","10px","ease","join","botão","modo"
        ],
        Solus: [
          "comunicação","unir","universo","comunidade","unidade","humaniza","unico","simbólico","está","micro","coerência","molécula","superfícies","pequenas","ativação","repouso","espelho","terra","transparent","deve","engajamento","versão","arquétipo","função","emocional","ouvir","prática","raiz","manifesto","ação","selar","inspirar","expirar"
        ],
        Aion: [
          "períodos","engano","3·6·9","registro","anota","anotar","mano","portal369","triângulo","reflexo","fractal","completa","gera","campos","nfrequência","mago","integrados","transition","editor","página","isso","mistério","use","cuida","save","ez","ordenadas","local","hidrogênio","readme","detectar","formas","bllue"
        ]
      };

      function detectArchetype(text){
        if(!text) return null;
        const t = text.toLowerCase();
        let best = null;
        let bestScore = 0;
        for(const [name, words] of Object.entries(ARCHETYPE_KEYWORDS)){
          let score = 0;
          const nameToken = name.toLowerCase();
          if(t.includes(nameToken)) score += 20;
          if(Array.isArray(words)){
            for(const w of words){
              if(!w) continue;
              const kw = String(w).toLowerCase();
              if(kw && t.includes(kw)) score++;
            }
          }
          if(score > bestScore){
            bestScore = score;
            best = name;
          }
        }
        return bestScore > 0 ? best : null;
      }

      const CONFIG = {
        API_URL: DEFAULTS.API_URL,
        MODEL: DEFAULTS.MODEL,
        TEMP: DEFAULTS.TEMP,
        CHUNK_SIZE: DEFAULTS.CHUNK_SIZE,
        AUTH_TOKEN: ''
      };

      const synth = window.speechSynthesis || null;
      let currentUtterance = null;
      let availableVoices = [];
      let voiceConfig = null;
      let currentVoiceKey = 'default';

      if (synth) {
        const loadVoices = () => {
          try { availableVoices = synth.getVoices() || []; }
          catch(e){ availableVoices = []; }
        };
        loadVoices();
        synth.onvoiceschanged = loadVoices;
      }

      const $  = sel => document.querySelector(sel);
      const $$ = sel => Array.from(document.querySelectorAll(sel));

      const responseContainer = $('#response');
      const responseList   = $('#responseList');
      let   bootBlock      = $('#bootBlock');
      const bootText       = $('#bootText');
      const footerHint     = $('#footerHint');
      const copyBtn        = $('#copyBtn');
      const pasteBtn       = $('#pasteBtn');
      const parserBtn      = $('#parserBtn');
      const parserFile     = $('#parserFile');
      const voiceConfigBtn = $('#voiceConfigBtn');
      const voiceConfigFile= $('#voiceConfigFile');
      const toggleLoginBtn = $('#toggleLoginBtn');
      const loginBox       = $('#loginBox');
      const loginForm      = $('#loginForm');
      const userNameInput  = $('#userName');
      const assistantInput = $('#assistantInput');
      const assistantNameEl= $('#assistantName');
      const userInput      = $('#userInput');
      const sendBtn        = $('#sendBtn');
      const themeToggleBtn = $('#themeToggle');
      const voiceBtn       = $('#voiceBtn');

      const iaConfigPanel   = $('#iaConfigPanel');
      const apiKeyInput     = $('#apiKeyInput');
      const modelSelect     = $('#modelSelect');
      const customModelInput= $('#customModelInput');
      const saveIaConfigBtn = $('#saveIaConfigBtn');
      const clearIaConfigBtn= $('#clearIaConfigBtn');
      const iaStatus        = $('#iaStatus');
      const themeSelect     = $('#themeSelect');
      const settingsBtn     = $('#toggleSettingsBtn');

      let conversation = [];
      let isCollapsed = false;
      let initialized = false;

      const responseBlocks = [];

      function escapeHtml(s) {
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      }

      function scrollToBottom() {
        if (!responseContainer) return;
        responseContainer.scrollTo({
          top: responseContainer.scrollHeight,
          behavior: 'smooth'
        });
        try {
          window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        } catch(e){}
      }

      function loadIaConfigFromStorage() {
        const key   = localStorage.getItem(STORAGE.OPENROUTER_KEY) || '';
        const model = localStorage.getItem(STORAGE.OPENROUTER_MODEL) || DEFAULTS.MODEL;

        CONFIG.API_URL = DEFAULTS.API_URL;
        CONFIG.MODEL   = model || DEFAULTS.MODEL;
        CONFIG.TEMP    = DEFAULTS.TEMP;
        CONFIG.CHUNK_SIZE = DEFAULTS.CHUNK_SIZE;
        CONFIG.AUTH_TOKEN = key ? 'Bearer ' + key : '';

        apiKeyInput.value = key;
        let optionFound = false;
        Array.from(modelSelect.options).forEach(opt => {
          if (opt.value === model) {
            optionFound = true;
            modelSelect.value = model;
          }
        });
        if (!optionFound) {
          modelSelect.value = 'custom';
          customModelInput.value = model;
        }

        if (!key) {
          iaStatus.textContent = 'Nenhuma chave salva ainda.';
          iaStatus.className = 'ia-status warn';
        } else {
          iaStatus.textContent = 'Config carregada. Pronto para chamar a IA.';
          iaStatus.className = 'ia-status ok';
        }
      }

      function saveIaConfig() {
        let key = apiKeyInput.value.trim();
        let model = modelSelect.value;

        if (model === 'custom') {
          const custom = customModelInput.value.trim();
          if (custom) model = custom;
        }
        if (!model) model = DEFAULTS.MODEL;

        if (!key) {
          iaStatus.textContent = 'Cole uma chave sk-or-... para salvar.';
          iaStatus.className = 'ia-status warn';
          return;
        }

        localStorage.setItem(STORAGE.OPENROUTER_KEY, key);
        localStorage.setItem(STORAGE.OPENROUTER_MODEL, model);

        CONFIG.AUTH_TOKEN = 'Bearer ' + key;
        CONFIG.MODEL = model;

        iaStatus.textContent = 'Config salva com sucesso.';
        iaStatus.className = 'ia-status ok';
      }

      function clearIaConfig() {
        localStorage.removeItem(STORAGE.OPENROUTER_KEY);
        localStorage.removeItem(STORAGE.OPENROUTER_MODEL);
        apiKeyInput.value = '';
        customModelInput.value = '';
        modelSelect.value = DEFAULTS.MODEL;
        CONFIG.AUTH_TOKEN = '';
        CONFIG.MODEL = DEFAULTS.MODEL;
        iaStatus.textContent = 'Config limpa. Defina novamente antes de enviar.';
        iaStatus.className = 'ia-status warn';
      }

      saveIaConfigBtn.addEventListener('click', saveIaConfig);
      clearIaConfigBtn.addEventListener('click', clearIaConfig);

      function applyTheme(theme) {
        document.body.dataset.theme = theme;
        localStorage.setItem(STORAGE.THEME, theme);
        if (themeSelect) themeSelect.value = theme;
      }
      function restoreTheme() {
        const theme = localStorage.getItem(STORAGE.THEME) || 'dark';
        applyTheme(theme);
      }
      if (themeSelect) {
        themeSelect.addEventListener('change', () => {
          applyTheme(themeSelect.value || 'dark');
        });
      }
      themeToggleBtn.addEventListener('click', () => {
        const current = document.body.dataset.theme || 'dark';
        const cycle = ['dark','vibe','medium'];
        const idx = cycle.indexOf(current);
        const next = cycle[(idx + 1) % cycle.length];
        applyTheme(next);
      });

      function restoreNames() {
        const user = localStorage.getItem(STORAGE.USER_NAME) || '';
        const asst = localStorage.getItem(STORAGE.ASSISTANT_NAME) || 'Dual.Infodose · Cinemático';
        if (user) userNameInput.value = user;
        if (asst) assistantInput.value = asst;
        assistantNameEl.textContent = asst;
      }

      toggleLoginBtn.addEventListener('click', () => {
        loginBox.classList.toggle('active');
      });

      loginForm.addEventListener('submit', (ev) => {
        ev.preventDefault();
        const user = userNameInput.value.trim() || 'Você';
        const asst = assistantInput.value.trim() || 'Dual.Infodose';
        localStorage.setItem(STORAGE.USER_NAME, user);
        localStorage.setItem(STORAGE.ASSISTANT_NAME, asst);
        assistantNameEl.textContent = asst;
        loginBox.classList.remove('active');
        conversation.unshift({
          role: 'system',
          content: `O usuário se chama ${user}. O assistente se apresenta como ${asst}. Responda com carinho cinematográfico.`
        });
      });

      function setCollapsed(state) {
        isCollapsed = state;
        if (isCollapsed) responseContainer.classList.add('collapsed');
        else responseContainer.classList.remove('collapsed');
      }

      footerHint.addEventListener('click', () => {
        setCollapsed(!isCollapsed);
      });

      if (settingsBtn && iaConfigPanel) {
        settingsBtn.addEventListener('click', () => {
          iaConfigPanel.classList.toggle('active');
        });
      }

      parserBtn.addEventListener('click', () => {
        parserFile.value = '';
        parserFile.click();
      });

      parserFile.addEventListener('change', () => {
        const file = parserFile.files && parserFile.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const content = reader.result || '';
          const name = file.name.toLowerCase();
          if (name.endsWith('.css')) {
            const style = document.createElement('style');
            style.textContent = content;
            document.head.appendChild(style);
            footerHint.textContent = 'CSS extra de renderização aplicado.';
          } else if (name.endsWith('.js')) {
            try {
              const fn = new Function('window','document', content);
              fn(window, document);
              footerHint.textContent = 'Parser JS carregado. Se definiu window.customMarkdownParser(text), já está ativo.';
            } catch (e) {
              console.error('Erro ao avaliar parser JS:', e);
              footerHint.textContent = 'Erro ao carregar parser JS. Veja o console para detalhes.';
            }
          } else {
            footerHint.textContent = 'Formato não suportado. Use .js ou .css.';
          }
        };
        reader.readAsText(file);
      });

      function updateVoiceOrbLabel() {
        if (!voiceConfigBtn) return;
        const label = currentVoiceKey || 'voz';
        voiceConfigBtn.title = voiceConfig
          ? 'Voz atual: ' + label + ' (clique para alternar)'
          : 'Carregar / alternar vozes de arquétipos';
      }

      function loadVoiceConfigFromStorage() {
        try {
          const raw = localStorage.getItem(STORAGE.VOICE_CONFIG);
          if (!raw) return;
          voiceConfig = JSON.parse(raw);
          const keys = Object.keys(voiceConfig || {});
          if (!keys.length) return;
          const storedKey = localStorage.getItem(STORAGE.VOICE_CURRENT_KEY);
          const candidate =
            (storedKey && keys.includes(storedKey)) ? storedKey :
            (voiceConfig.current && keys.includes(voiceConfig.current)) ? voiceConfig.current :
            (keys.includes('default') ? 'default' : keys[0]);
          currentVoiceKey = candidate;
          updateVoiceOrbLabel();
        } catch(e) {
          console.warn('Erro ao carregar config de voz:', e);
          voiceConfig = null;
        }
      }

      if (voiceConfigBtn) {
        voiceConfigBtn.addEventListener('click', () => {
          if (!voiceConfig) {
            if (voiceConfigFile) voiceConfigFile.click();
            return;
          }
          const keys = Object.keys(voiceConfig).filter(k => k !== 'current');
          if (!keys.length) return;
          const idx = keys.indexOf(currentVoiceKey);
          const nextKey = keys[(idx + 1 + keys.length) % keys.length];
          currentVoiceKey = nextKey;
          localStorage.setItem(STORAGE.VOICE_CURRENT_KEY, currentVoiceKey);
          updateVoiceOrbLabel();
          footerHint.textContent = 'Voz ativa: ' + currentVoiceKey;
        });
      }

      if (voiceConfigFile) {
        voiceConfigFile.addEventListener('change', () => {
          const file = voiceConfigFile.files && voiceConfigFile.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const json = JSON.parse(reader.result || '{}');
              if (!json || typeof json !== 'object') {
                footerHint.textContent = 'JSON inválido de vozes.';
                return;
              }
              voiceConfig = json;
              const keys = Object.keys(voiceConfig);
              if (!keys.length) {
                footerHint.textContent = 'JSON de vozes vazio.';
                return;
              }
              const candidate =
                (voiceConfig.current && keys.includes(voiceConfig.current)) ? voiceConfig.current :
                (keys.includes('default') ? 'default' : keys[0]);
              currentVoiceKey = candidate;
              localStorage.setItem(STORAGE.VOICE_CONFIG, JSON.stringify(voiceConfig));
              localStorage.setItem(STORAGE.VOICE_CURRENT_KEY, currentVoiceKey);
              updateVoiceOrbLabel();
              footerHint.textContent = 'Config de vozes carregada: ' + keys.join(', ');
            } catch(e) {
              console.error('Erro ao ler JSON de vozes:', e);
              footerHint.textContent = 'Erro ao carregar JSON de vozes. Veja o console.';
            }
          };
          reader.readAsText(file);
        });
      }

      function parseMarkdownBasic(rawText) {
        if (!rawText) return '';
        if (typeof window.customMarkdownParser === 'function') {
          try {
            const html = window.customMarkdownParser(rawText);
            if (typeof html === 'string') return html;
          } catch (e) {
            console.warn('customMarkdownParser falhou, usando parser interno.', e);
          }
        }
        let text = escapeHtml(rawText);
        text = text.replace(/\r\n/g, '\n');
        text = text.replace(/\*\*\*([^*]+)\*\*\*/g, '<strong><em>$1</em></strong>');
        text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
        text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');
        text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
        text = text.replace(/```([\s\S]*?)```/g, function(_m, code){
          return '<pre><code>' + code.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</code></pre>';
        });
        text = text.replace(/^### (.*)$/gim, '<h3>$1</h3>');
        text = text.replace(/^## (.*)$/gim, '<h2>$1</h2>');
        text = text.replace(/^# (.*)$/gim, '<h1>$1</h1>');
        text = text.replace(/^> (.*)$/gim, '<blockquote>$1</blockquote>');
        text = text.replace(/^\s*[-*+] (.*)$/gim, '<li>$1</li>');
        text = text.replace(/(<li>.*<\/li>)/gims, '<ul>$1</ul>');
        return text;
      }

      function splitResponseCinematic(text) {
        const parts = text.split(/\n{2,}/).map(p => p.trim()).filter(Boolean);
        if (!parts.length) {
          return [{
            kind: 'middle',
            html: '<p>' + parseMarkdownBasic(text).replace(/\n/g, '<br/>') + '</p>'
          }];
        }
        const blocks = [];
        parts.forEach((p, idx) => {
          const kind = idx === 0 ? 'intro' : (idx === parts.length - 1 ? 'ending' : 'middle');
          const html = '<p>' + parseMarkdownBasic(p).replace(/\n/g, '<br/>') + '</p>';
          blocks.push({ kind, html });
        });
        return blocks.slice(0, 3);
      }

      function getBlockText(block) {
        if (!block) return '';
        const raw = block.innerHTML
          .replace(/<button[^>]*class="block-tts-btn"[^>]*>[\s\S]*?<\/button>/gi, '')
          .replace(/<span[^>]*class="archetype-badge"[^>]*>[\s\S]*?<\/span>/gi, '')
          .replace(/<br\s*\/?>/gi, '\n')
          .replace(/<\/p>/gi, '\n\n')
          .replace(/<li>/gi, '- ')
          .replace(/<\/li>/gi, '\n')
          .replace(/<\/h[1-6]>/gi, '\n')
          .replace(/<[^>]+>/g, '');
        return raw.trim();
      }

      function markBlockArchetype(div, archeName){
        if(!div || !archeName) return;
        div.dataset.archetype = archeName;
        let badge = div.querySelector('.archetype-badge');
        if(!badge){
          badge = document.createElement('span');
          badge.className = 'archetype-badge';
          div.appendChild(badge);
        }
        badge.textContent = archeName;
      }

      function speakBlock(block) {
        if (!synth) {
          footerHint.textContent = 'Seu navegador não suporta voz (SpeechSynthesis).';
          return;
        }
        if (!block) {
          footerHint.textContent = 'Nenhum bloco selecionado.';
          return;
        }

        const text = getBlockText(block);
        if (!text) {
          footerHint.textContent = 'Nada para ler nesse bloco.';
          return;
        }

        const detectedArch = detectArchetype(text);
        if (detectedArch) {
          currentVoiceKey = detectedArch;
          localStorage.setItem('ARCHETYPE_ACTIVE', detectedArch);
          localStorage.setItem(STORAGE.VOICE_CURRENT_KEY, currentVoiceKey);
          markBlockArchetype(block, detectedArch);
          updateVoiceOrbLabel();
        }

        try {
          block.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
        } catch(e){}
        scrollToBottom();

        if (synth.speaking) {
          synth.cancel();
          voiceBtn.classList.remove('speaking');
        }

        const utter = new SpeechSynthesisUtterance(text);

        let profile = null;
        if (voiceConfig) {
          if (currentVoiceKey && voiceConfig[currentVoiceKey]) {
            profile = voiceConfig[currentVoiceKey];
          } else if (voiceConfig.default) {
            profile = voiceConfig.default;
          }
        }

        const lang  = profile && profile.lang  ? profile.lang  : 'pt-BR';
        const rate  = (profile && typeof profile.rate  === 'number') ? profile.rate  : 1;
        const pitch = (profile && typeof profile.pitch === 'number') ? profile.pitch : 1;
        const vol   = (profile && typeof profile.volume === 'number') ? profile.volume : 1;

        utter.lang   = lang;
        utter.rate   = rate;
        utter.pitch  = pitch;
        utter.volume = vol;

        if (profile && profile.voiceHint && availableVoices && availableVoices.length) {
          const hint = String(profile.voiceHint).toLowerCase();
          let chosen = availableVoices.find(v => v.name.toLowerCase().includes(hint));
          if (!chosen) chosen = availableVoices.find(v => v.lang === lang) || null;
          if (chosen) utter.voice = chosen;
        }

        currentUtterance = utter;

        utter.onstart = () => {
          voiceBtn.classList.add('speaking');
          footerHint.textContent = 'Lendo o bloco em voz alta.';
        };
        utter.onend = () => {
          voiceBtn.classList.remove('speaking');
          footerHint.textContent = 'Leitura concluída.';
        };
        utter.onerror = () => {
          voiceBtn.classList.remove('speaking');
          footerHint.textContent = 'Erro ao tentar falar. Veja o console se estiver debugando.';
        };

        synth.cancel();
        synth.speak(utter);
      }

      function speakLastBlock() {
        if (!responseBlocks.length) return;
        const last = responseBlocks[responseBlocks.length - 1];
        speakBlock(last);
      }

      voiceBtn.addEventListener('click', () => {
        speakLastBlock();
      });

      function onBlockClick(ev) {
        const block = ev.currentTarget;
        block.classList.add('clicked');
        setTimeout(() => block.classList.remove('clicked'), 350);
        const state = block.dataset.state || 'idle';
        if (state === 'idle' || state === 'sent') {
          block.dataset.state = 'spoken';
          speakBlock(block);
        } else if (state === 'spoken') {
          block.dataset.state = 'sent';
          const text = getBlockText(block);
          if (text) {
            sendPrompt(text, { fromBlock: true });
          }
        }
      }

      function addTtsButtonToBlock(div) {
        if (!div || div.querySelector('.block-tts-btn')) return;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'block-tts-btn';
        btn.textContent = '◎';
        btn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          speakBlock(div);
        });
        div.appendChild(btn);
      }

      function enhanceBlock(div) {
        if (!div) return;
        div.dataset.state = div.dataset.state || 'idle';
        div.addEventListener('click', onBlockClick);
        addTtsButtonToBlock(div);
        const t = getBlockText(div);
        const arch = detectArchetype(t);
        if (arch) {
          markBlockArchetype(div, arch);
        }
        if (!responseBlocks.includes(div)) {
          responseBlocks.push(div);
        }
      }

      if (bootBlock) enhanceBlock(bootBlock);

      function appendBlocksFromData(blocks) {
        if (!blocks || !blocks.length) return;
        if (bootBlock) {
          bootBlock.remove();
          bootBlock = null;
        }
        blocks.forEach((page) => {
          const div = document.createElement('div');
          div.className = 'response-block ' + (page.kind || 'middle');
          div.innerHTML = page.html;
          enhanceBlock(div);
          responseList.appendChild(div);
        });
        scrollToBottom();
        speakLastBlock();
      }

      function appendUserPulseBlock(text) {
        if (!text) return;
        if (bootBlock) {
          bootBlock.remove();
          bootBlock = null;
        }
        const div = document.createElement('div');
        div.className = 'response-block user-pulse';
        const html = '<p>' + parseMarkdownBasic(text).replace(/\n/g,'<br/>') + '</p>';
        div.innerHTML = html;
        enhanceBlock(div);
        responseList.appendChild(div);
        scrollToBottom();
      }

      async function callOpenRouter(promptText) {
        if (!CONFIG.AUTH_TOKEN) {
          throw new Error('Defina a chave OpenRouter no painel de Config IA.');
        }
        const userName = localStorage.getItem(STORAGE.USER_NAME) || 'Você';
        const asstName = localStorage.getItem(STORAGE.ASSISTANT_NAME) || 'Dual.Infodose';
        const messages = [
          {
            role: 'system',
            content:
`Você é ${asstName}, o assistente Dual.Infodose conectado ao ecossistema Hub1/KOBLLUX.
Responda em português, em tom gentil, simbólico e acionável, como um "chat cinematográfico".
Use parágrafos curtos, que possam ser divididos em 3 blocos: recompensa inicial, curiosidade no meio, e convite no final.`
          }
        ].concat(conversation, [
          {
            role: 'user',
            content: `${userName} diz: ${promptText}`
          }
        ]);
        const body = {
          model: CONFIG.MODEL,
          temperature: CONFIG.TEMP,
          messages
        };
        const res = await fetch(CONFIG.API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': CONFIG.AUTH_TOKEN
          },
          body: JSON.stringify(body)
        });
        if (!res.ok) {
          const txt = await res.text();
          console.error('Erro IA:', txt);
          throw new Error('Falha na resposta da IA: ' + res.status);
        }
        const data = await res.json();
        const choice = data.choices && data.choices[0];
        const content = choice?.message?.content || '(sem conteúdo retornado)';
        conversation.push({ role: 'user', content: promptText });
        conversation.push({ role: 'assistant', content });
        return content;
      }

      async function sendPrompt(promptText, options) {
        const opts = options || {};
        const fromBlock = !!opts.fromBlock;
        const text = (promptText || '').trim();
        if (!text) return;
        setCollapsed(false);
        if (!fromBlock) userInput.value = '';
        userInput.disabled = true;
        sendBtn.disabled = true;
        const oldFooter = footerHint.textContent;
        footerHint.textContent = fromBlock
          ? 'Pulso em expansão a partir do bloco.'
          : 'Processando pulso.';

        if (synth && synth.speaking) {
          synth.cancel();
          voiceBtn.classList.remove('speaking');
        }

        appendUserPulseBlock(text);

        try {
          const answer = await callOpenRouter(text);
          const cinematicBlocks = splitResponseCinematic(answer);
          appendBlocksFromData(cinematicBlocks);
        } catch (err) {
          console.error(err);
          const errorBlocks = [{
            kind: 'ending',
            html: '<p><strong>Ops.</strong> Não foi possível falar com o OpenRouter agora. Verifique sua chave e tente novamente.</p>'
          }];
          appendBlocksFromData(errorBlocks);
        } finally {
          userInput.disabled = false;
          sendBtn.disabled = false;
          userInput.focus();
          footerHint.textContent = oldFooter || 'Do seu jeito. Sempre único. Sempre seu.';
        }
      }

      async function handleSendFromInput() {
        const text = userInput.value.trim();
        if (!text) return;
        await sendPrompt(text, { fromBlock: false });
      }

      sendBtn.addEventListener('click', handleSendFromInput);
      userInput.addEventListener('keydown', ev => {
        if (ev.key === 'Enter' && !ev.shiftKey) {
          ev.preventDefault();
          handleSendFromInput();
        }
      });

      copyBtn.addEventListener('click', async () => {
        let target = responseBlocks[responseBlocks.length - 1];
        if (!target && bootBlock) target = bootBlock;
        if (!target) return;
        const temp = getBlockText(target);
        if (!temp) return;
        try {
          await navigator.clipboard.writeText(temp);
          footerHint.textContent = 'Bloco copiado para a área de transferência.';
        } catch {
          footerHint.textContent = 'Não consegui copiar automaticamente. Copie manualmente se quiser.';
        }
      });

      pasteBtn.addEventListener('click', async () => {
        try {
          const txt = await navigator.clipboard.readText();
          if (txt) userInput.value = txt;
        } catch {}
      });

      function initParticles() {
        if (!window.particlesJS) {
          console.warn('particlesJS não encontrado.');
          return;
        }
        particlesJS('particles-js', {
          particles: {
            number: { value: 60, density: { enable: true, value_area: 800 } },
            color: { value: ['#00f5ff', '#ff4bff', '#ffffff'] },
            shape: { type: 'circle' },
            opacity: { value: 0.45, random: true },
            size: { value: 3, random: true },
            line_linked: {
              enable: true,
              distance: 140,
              color: '#00f5ff',
              opacity: 0.25,
              width: 1
            },
            move: {
              enable: true,
              speed: 1.2,
              direction: 'none',
              random: false,
              straight: false,
              out_mode: 'out',
              bounce: false
            }
          },
          interactivity: {
            detect_on: 'canvas',
            events: {
              onhover: { enable: true, mode: 'grab' },
              onclick: { enable: false, mode: 'push' },
              resize: true
            },
            modes: {
              grab: {
                distance: 160,
                line_linked: { opacity: 0.5 }
              }
            }
          },
          retina_detect: true
        });
      }

      function init() {
        if (initialized) return;
        initialized = true;
        restoreTheme();
        restoreNames();
        loadIaConfigFromStorage();
        loadVoiceConfigFromStorage();
        const archActive = localStorage.getItem('ARCHETYPE_ACTIVE');
        if (archActive) {
          currentVoiceKey = archActive;
          localStorage.setItem(STORAGE.VOICE_CURRENT_KEY, currentVoiceKey);
        }
        updateVoiceOrbLabel();
        setCollapsed(false);
        initParticles();
        if (bootText) bootText.classList.add('pulse');
        if (bootBlock && synth) {
          setTimeout(() => {
            try { speakBlock(bootBlock); } catch(e){}
          }, 700);
        }
        console.log('Dual Cinemático V2.9 (TTS + Roda-Viva de Vozes) inicializado.');
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
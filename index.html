<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>dual-Infodose Chat Cinematogr√°fico ¬∑ Roda-Viva</title>
<!-- <script src="./KDX-Sev-Panel-v5++patch.js" defer></script> -->
  <meta name="theme-color" content="#050811" />

  <!-- Fonte b√°sica -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" />

  <style>
    :root{
      /* Tokens base para integra√ß√£o com KOB_THEME + Roda-Viva */
      --grad-a:#00f5ff;
      --grad-b:#ff4bff;
      --bg:#050811;
      --panel:rgba(5,8,17,.96);
      --ink:#e4ecff;
      --muted:#9aa4c8;

      /* Tokens KOBLLUX de voz/tema (podem ser sobrescritos pelo patch) */
      --kob-voice-primary:#00f5ff;
      --kob-voice-secondary:#ff4bff;
      --kob-voice-accent:#ffffff;
      --kob-voice-bg-soft:rgba(0,245,255,.12);
      --kob-voice-glow:0 0 18px rgba(0,245,255,.60);

      /* Derivados internos do app */
      --text: var(--ink);
      --accent: var(--kob-voice-primary);
      --accent-soft: rgba(0,245,255,.18);
      --accent-pink: var(--kob-voice-secondary);
      --danger:#ff4b6b;

      --radius-card:18px;
      --radius-pill:999px;
      --shadow-soft:0 18px 40px rgba(0,0,0,.65);
      --fast:.25s;
      --med:.6s;
      --slow:1.4s;
    }

    *{box-sizing:border-box;margin:0;padding:0;}
    html,body{width:100%;height:100%;}

    body{
      font-family:"Montserrat",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at 20% 20%,var(--grad-a),var(--bg) 60%,#000000 100%);
      color:var(--text);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      padding:16px 16px 24px;
      overflow:hidden;
      position:relative;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:
        radial-gradient(circle at 10% 0%,rgba(0,255,255,.16) 0,transparent 50%),
        radial-gradient(circle at 90% 100%,rgba(255,0,255,.12) 0,transparent 60%);
      opacity:.7;
      pointer-events:none;
      mix-blend-mode:screen;
    }

    #particles-js{
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none;
      opacity:.65;
    }

    .svg-container{
      position:relative;
      margin-top:40px;
      width:140px;
      height:140px;
      filter:drop-shadow(0 0 25px rgba(0,255,255,.35));
      animation:orbFloat 12s ease-in-out infinite;
      z-index:1;
    }
    .svg-container svg{width:100%;height:100%;object-fit:contain;}

    @keyframes orbFloat{
      0%,100%{transform:translateY(0) scale(1);}
      50%{transform:translateY(-8px) scale(1.03);}
    }

    #assistantName{
      margin-top:8px;
      font-size:1.05rem;
      font-weight:600;
      text-align:center;
      opacity:.9;
      z-index:1;
    }

    .response-container{
      position:fixed;
      left:16px;
      right:16px;
      bottom:96px;
      max-height:calc(100vh - 60px);
      padding:18px;
      border-radius:20px;
      background:radial-gradient(circle at 0 0,var(--kob-voice-bg-soft),var(--panel));
      backdrop-filter:blur(14px) saturate(160%);
      box-shadow:var(--shadow-soft);
      overflow-y:auto;
      z-index:1;
      display:flex;
      flex-direction:column;
      gap:8px;
      animation:fadeInUp var(--slow) ease forwards;
      transition:all var(--fast) ease;
    }

    .response-container.collapsed{
      bottom:24px;
      max-height:none;
      padding:6px 10px;
      background:radial-gradient(circle at 0 0,var(--kob-voice-bg-soft),rgba(0,0,0,.95));
    }
    .response-container.collapsed .pages-wrapper,
    .response-container.collapsed .response-controls,
    .response-container.collapsed #iaConfigPanel{
      display:none;
    }
    .response-container.collapsed .footer-text{
      margin-top:0;
      font-size:.78rem;
      border-radius:999px;
    }
    .response-container.collapsed + .input-container{display:none;}

    .pages-wrapper{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    #bootText{
      font-weight:700;
      position:relative;
      letter-spacing:.03em;
      display:inline-block;
      white-space:pre-line;
    }
    #bootText.pulse::after{
      content:attr(data-text);
      position:absolute;
      inset:0;
      background:linear-gradient(42deg,var(--kob-voice-primary),var(--kob-voice-secondary));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      filter:blur(4px);
      opacity:.45;
      pointer-events:none;
      animation:pulseGlow 3s ease-in-out infinite;
    }

    @keyframes fadeInUp{
      from{opacity:0;transform:translateY(12px);}
      to{opacity:1;transform:translateY(0);}
    }
    @keyframes pulseGlow{
      0%,100%{opacity:.4;}
      50%{opacity:.9;}
    }

    .response-block{
      margin:.35rem 0;
      padding:1rem 1.1rem 1.9rem;
      border-radius:14px;
      line-height:1.7;
      font-size:.9rem;
      position:relative;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.04);
      transition:
        box-shadow var(--fast),
        transform var(--fast),
        border-color var(--fast),
        background var(--fast),
        opacity var(--fast);
      cursor:pointer;
    }
    .response-block:hover{
      transform:translateY(-1px);
      box-shadow:0 12px 30px rgba(0,0,0,.7);
      border-color:rgba(0,255,255,.3);
    }

    .response-block.intro{
      background:linear-gradient(135deg,rgba(0,255,255,.18),rgba(0,40,70,.9));
    }
    .response-block.middle{
      background:linear-gradient(135deg,rgba(255,255,255,.04),rgba(6,10,28,.95));
    }
    .response-block.ending{
      background:linear-gradient(135deg,rgba(255,0,255,.18),rgba(40,0,60,.95));
    }
    .response-block.user-pulse{
      background:linear-gradient(135deg,rgba(0,0,0,.85),rgba(0,255,255,.22));
      border-color:rgba(0,255,255,.6);
      text-align:right;
    }

    .response-block.clicked{
      animation:blockClickPulse .4s ease;
    }
    @keyframes blockClickPulse{
      0%{transform:scale(1);box-shadow:0 0 0 rgba(0,255,255,0);}
      50%{transform:scale(1.02);box-shadow:0 0 24px rgba(0,255,255,.5);}
      100%{transform:scale(1);box-shadow:0 0 0 rgba(0,255,255,0);}
    }

    .response-block strong{color:var(--accent);}

    .response-block h1,
    .response-block h2,
    .response-block h3{margin-bottom:.2rem;}
    .response-block h3{font-size:.95rem;}

    .response-block code{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:.8rem;
      padding:.15rem .32rem;
      border-radius:6px;
      background:rgba(0,0,0,.5);
    }
    .response-block pre{
      max-width:100%;
      overflow-x:auto;
      padding:.6rem .7rem;
      background:rgba(0,0,0,.55);
      border-radius:8px;
      font-size:.78rem;
      margin-top:.4rem;
    }

    /* Bot√£o TTS no bloco */
    .block-tts-btn{
      position:absolute;
      right:8px;
      bottom:8px;
      width:24px;
      height:24px;
      border-radius:50%;
      border:none;
      background:rgba(0,0,0,.75);
      color:var(--accent);
      font-size:.75rem;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow:0 0 8px rgba(0,255,255,.4);
      opacity:.9;
      transition:transform var(--fast),box-shadow var(--fast),background var(--fast),opacity var(--fast);
    }
    .block-tts-btn:hover{
      transform:translateY(-1px) scale(1.03);
      box-shadow:0 0 14px rgba(0,255,255,.7);
      background:rgba(0,0,0,.95);
      opacity:1;
    }

    /* Badge de arqu√©tipo detectado */
    .archetype-badge{
      position:absolute;
      left:10px;
      top:8px;
      padding:2px 8px;
      border-radius:999px;
      font-size:.7rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      background:rgba(0,0,0,.65);
      border:1px solid rgba(0,255,255,.45);
      color:#a7ffea;
      pointer-events:none;
    }

    .footer-text{
      margin-top:6px;
      padding:6px 10px;
      font-size:.78rem;
      text-align:center;
      opacity:.8;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.65);
      cursor:pointer;
      transition:opacity var(--fast),transform var(--fast),box-shadow var(--fast),background var(--fast);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }
    .footer-text span.footer-dot{
      width:6px;
      height:6px;
      border-radius:50%;
      background:linear-gradient(45deg,var(--kob-voice-primary),var(--kob-voice-secondary));
      box-shadow:0 0 12px rgba(0,255,255,.7);
    }
    .footer-text:hover{
      opacity:.95;
      transform:scale(1.02);
      box-shadow:0 0 18px rgba(0,255,255,.35);
      background:rgba(0,0,0,.9);
    }

    .response-controls{
      margin-top:6px;
      padding-top:6px;
      border-top:1px solid rgba(255,255,255,.12);
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:8px;
    }

    .control-buttons{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .icon-btn{
      width:34px;
      height:34px;
      border-radius:50%;
      border:none;
      background:rgba(0,0,0,.7);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:background var(--fast),transform var(--fast),opacity var(--fast);
      opacity:.8;
      color:var(--accent);
    }
    .icon-btn.secondary{color:#e4ecff;}
    .icon-btn:hover{
      background:rgba(255,255,255,.12);
      transform:translateY(-1px);
      opacity:1;
    }
    .icon-btn svg{
      width:70%;
      height:70%;
      fill:none;
      stroke:currentColor;
      stroke-width:1.8;
    }

    #iaConfigPanel{
      margin-top:6px;
      padding:8px 10px;
      border-radius:16px;
      background:rgba(0,8,20,.96);
      border:1px solid rgba(0,255,255,.24);
      box-shadow:0 8px 24px rgba(0,0,0,.5);
      color:var(--text);
      font-size:.78rem;
      display:none;
      flex-direction:column;
      gap:6px;
    }
    #iaConfigPanel.active{display:flex;}

    #iaConfigHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    #iaConfigHeader span{
      font-size:.78rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      opacity:.9;
    }

    .ia-config-body{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:4px;
    }
    .ia-field{
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .ia-field label{
      font-size:.72rem;
      opacity:.8;
    }
    .ia-field input,
    .ia-field select{
      width:100%;
      border-radius:8px;
      border:1px solid rgba(0,255,255,.3);
      background:rgba(0,0,0,.7);
      color:inherit;
      padding:5px 7px;
      font-size:.78rem;
      outline:none;
    }
    .ia-field input::placeholder{color:rgba(255,255,255,.38);}

    .ia-actions{
      display:flex;
      justify-content:space-between;
      gap:6px;
      margin-top:4px;
    }

    .pill-btn{
      flex:1;
      border-radius:999px;
      border:1px solid rgba(0,255,255,.6);
      background:transparent;
      padding:5px 0;
      font-size:.78rem;
      cursor:pointer;
      color:var(--accent);
      transition:background var(--fast),color var(--fast),transform var(--fast);
    }
    .pill-btn:hover{
      background:var(--accent);
      color:#050515;
      transform:translateY(-1px);
    }
    .pill-btn.secondary{
      border-color:rgba(255,255,255,.35);
      color:rgba(255,255,255,.8);
    }
    .pill-btn.secondary:hover{
      background:rgba(255,255,255,.12);
      color:#fff;
    }

    .ia-status{
      font-size:.7rem;
      opacity:.8;
      margin-top:2px;
    }
    .ia-status.ok{color:#63f8ba;}
    .ia-status.warn{color:#ffd480;}
    .ia-status.err{color:var(--danger);}

    .input-container{
      position:fixed;
      left:16px;
      right:16px;
      bottom:33px;
      display:flex;
      gap:8px;
      align-items:center;
      z-index:2;
      transition:opacity var(--fast) ease,transform var(--fast) ease;
    }

    #userInput{
      flex:1;
      min-width:0;
      padding:11px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.7);
      color:inherit;
      font-size:.95rem;
      outline:none;
      transition:border-color var(--fast),background var(--fast),box-shadow var(--fast);
    }
    #userInput::placeholder{color:rgba(255,255,255,.35);}
    #userInput:focus{
      border-color:rgba(0,255,255,.65);
      background:rgba(0,0,0,.9);
      box-shadow:0 0 0 1px rgba(0,255,255,.45);
    }

    #sendBtn{
      width:56px;
      height:56px;
      border-radius:50%;
      border:none;
      background:conic-gradient(from 120deg,var(--kob-voice-primary),var(--kob-voice-secondary),var(--kob-voice-primary));
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow:var(--kob-voice-glow);
      transition:transform var(--fast),box-shadow var(--fast);
      color:#050515;
      font-size:1.6rem;
    }
    #sendBtn .send-label{transform:translateX(1px);}
    #sendBtn:hover{
      transform:translateY(-1px) scale(1.04);
      box-shadow:0 0 26px rgba(0,255,255,.8);
    }

    #voiceBtn{
      width:52px;
      height:52px;
      border-radius:50%;
      border:none;
      background:rgba(0,0,0,.75);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow:0 0 0 1px rgba(255,255,255,.08);
      transition:transform var(--fast),box-shadow var(--fast),background var(--fast);
      position:relative;
      overflow:hidden;
      color:var(--accent);
    }
    #voiceBtn svg{width:70%;height:70%;fill:none;stroke:currentColor;stroke-width:1.8;}
    #voiceBtn:hover{
      transform:translateY(-1px);
      box-shadow:0 0 18px rgba(0,255,255,.45);
      background:rgba(0,0,0,.95);
    }
    #voiceBtn.speaking{
      background:radial-gradient(circle at 0 0,rgba(0,255,255,.35),rgba(0,0,0,1));
      box-shadow:0 0 18px rgba(0,255,255,.75);
      animation:voicePulse 1.4s ease-in-out infinite;
    }
    @keyframes voicePulse{
      0%{box-shadow:0 0 8px rgba(0,255,255,.3);transform:translateY(-1px) scale(1);}
      50%{box-shadow:0 0 24px rgba(0,255,255,.8);transform:translateY(-1px) scale(1.06);}
      100%{box-shadow:0 0 8px rgba(0,255,255,.3);transform:translateY(-1px) scale(1);}
    }

    .login-container{
      position:fixed;
      top:50%;
      left:50%;
      width:300px;
      max-width:88vw;
      transform:translate(-50%,-50%);
      background:radial-gradient(circle at 0 0,rgba(0,255,255,.2),rgba(0,0,0,.9));
      border-radius:18px;
      padding:16px 14px 14px;
      border:1px solid rgba(0,255,255,.3);
      backdrop-filter:blur(18px) saturate(180%);
      box-shadow:var(--shadow-soft);
      z-index:20;
      display:none;
      animation:fadeInUp .4s ease;
    }
    .login-container.active{display:block;}
    .login-container h2{font-size:1rem;margin-bottom:6px;}
    .login-container p{font-size:.8rem;opacity:.8;margin-bottom:10px;}
    .login-container input{
      width:100%;
      margin-bottom:8px;
      padding:7px 2px;
      border:none;
      border-bottom:1px solid rgba(255,255,255,.35);
      background:transparent;
      color:inherit;
      font-size:.9rem;
      outline:none;
    }
    .login-container input::placeholder{color:rgba(255,255,255,.45);}
    .login-container button[type="submit"]{
      margin-top:8px;
      width:100%;
      border-radius:999px;
      border:1px solid var(--accent);
      background:transparent;
      color:var(--accent);
      padding:8px 0;
      font-size:.9rem;
      cursor:pointer;
      transition:background var(--fast),color var(--fast),transform var(--fast);
    }
    .login-container button[type="submit"]:hover{
      background:var(--accent);
      color:#050515;
      transform:translateY(-1px);
    }

    #themeToggle{
      position:fixed;
      top:16px;
      left:16px;
      width:30px;
      height:30px;
      border-radius:50%;
      border:1px solid rgba(255,255,255,.4);
      background:radial-gradient(circle at 0 0,rgba(255,255,255,.4),transparent 60%);
      cursor:pointer;
      opacity:.7;
      z-index:10;
      transition:opacity var(--fast),transform var(--fast),box-shadow var(--fast);
    }
    #themeToggle:hover{
      opacity:1;
      transform:translateY(-1px);
      box-shadow:0 0 12px rgba(255,255,255,.7);
    }

    .response-container::-webkit-scrollbar{width:4px;}
    .response-container::-webkit-scrollbar-track{background:transparent;}
    .response-container::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,.35);
      border-radius:999px;
    }

    /* Livro Vivo ‚Äì Callouts */
    .lv-callout{
      margin:.4rem 0;
      padding:.45rem .6rem;
      border-radius:10px;
      font-size:.8rem;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.45);
    }
    .lv-callout.lv-info{border-color:rgba(0,255,255,.5);color:#d7faff;}
    .lv-callout.lv-warn{border-color:#ffc857;color:#ffebbc;}
    .lv-callout.lv-success{border-color:#39ffb6;color:#d7ffe9;}
    .lv-callout.lv-question{border-color:#7b88ff;color:#dde0ff;}
    .lv-callout.lv-aside{border-style:dashed;color:#c8c8d8;}

    /* Livro Vivo ‚Äì Bot√µes */
    .lv-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:.26rem .7rem;
      border-radius:999px;
      border:1px solid rgba(0,255,255,.6);
      background:rgba(0,0,0,.6);
      font-size:.78rem;
      cursor:pointer;
      margin:.1rem .16rem .1rem 0;
      color:var(--accent);
      gap:.35rem;
      transition:background var(--fast),color var(--fast),transform var(--fast),box-shadow var(--fast);
    }
    .lv-btn::before{
      content:"‚ö°";
      font-size:.7rem;
      opacity:.85;
    }
    .lv-btn:hover{
      background:var(--accent);
      color:#050515;
      transform:translateY(-1px);
      box-shadow:0 0 14px rgba(0,255,255,.6);
    }

    /* Livro Vivo ‚Äì Tabelista */
    .md-tabelista{
      margin:8px 0;
      padding:8px 9px;
      border-radius:10px;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.08);
      font-size:.8rem;
    }
    .md-tabelista .tbl-head{
      font-weight:600;
      margin-bottom:2px;
    }
    .md-tabelista .tbl-sub{
      opacity:.75;
      font-size:.75rem;
      margin-bottom:4px;
    }
    .md-tabelista ul{
      list-style:none;
      padding:0;
      margin:0;
    }
    .md-tabelista li{
      padding:2px 0;
      border-top:1px solid rgba(255,255,255,.06);
    }
    .md-tabelista li:first-child{border-top:none;}
    .md-tabelista .tbl-col1{font-weight:500;}
    .md-tabelista .tbl-col2{opacity:.85;}
    .md-tabelista .tbl-col3{opacity:.8;}

    @media (min-width:768px){
      body{
        max-width:520px;
        margin:0 auto;
      }
    }
  </style>

  <!-- Patches KOBLLUX / Vozes / Tema / Fades (podem ser recortados como patch) -->
  <!-- KOBLLUX ¬∑ Vozes Arqu√©tipas ‚Äî Patch Inline (UPDATED) -->
  <script id="KOBLLUX_VOICES_INTEGRATION">
  (()=>{

    const ARCHETYPES = [
      { id:'atlas',   name:'Atlas',   tone:'Estrat√©gico, met√≥dico',        modulation:'Grave, ritmo calculado, dic√ß√£o n√≠tida.',        voice:'Reed',    rate:1.0,  pitch:0.93 },
      { id:'nova',    name:'Nova',    tone:'Vibrante, entusiasmado',       modulation:'Agudo, entusiasmado, ligeiramente r√°pido.',      voice:'Luciana', rate:1.063, pitch:1.34 },
      { id:'vitalis', name:'Vitalis', tone:'Energ√©tico, urgente',          modulation:'R√°pido, intenso, motivacional.',                  voice:'Rocko',   rate:0.96, pitch:1.42 },
      { id:'pulse',   name:'Pulse',   tone:'Emocional, mel√≥dico',          modulation:'Fluido, tom m√©dio/suave.',                       voice:'Reed',    rate:1.0, pitch:1.14 },
      { id:'artemis', name:'Artemis', tone:'Aventureiro, expansivo',       modulation:'Curioso, explorat√≥rio.',                         voice:'es_f',    rate:1.00, pitch:1.23 },
      { id:'serena',  name:'Serena',  tone:'Calmo, acolhedor',             modulation:'Suave, terap√™utico, com pausas.',                voice:'Joana',   rate:0.92, pitch:0.90 },
      { id:'kaos',    name:'Kaos',    tone:'Desafiador, imprevis√≠vel',     modulation:'Intenso, ritmo entrecortado.',                   voice:'Rocko',   rate:1.09, pitch:1.28 },
      { id:'genus',   name:'Genus',   tone:'Pr√°tico, detalhista',          modulation:'Tom firme, foco na dic√ß√£o.',                     voice:'Reed',    rate:0.98, pitch:1.20 },
      { id:'lumine',  name:'Lumine',  tone:'Alegre, brincalh√£o',           modulation:'Agudo, vibrante.',                               voice:'Flo',     rate:1.030, pitch:1.55 },
      { id:'solus',   name:'Solus',   tone:'S√°bio, introspectivo',         modulation:'Grave, lento, eco sutil.',                       voice:'es_m',    rate:0.88, pitch:0.87 },
      { id:'rhea',    name:'Rhea',    tone:'Profundo, conectivo',          modulation:'Calmo, eco sutil.',                              voice:'Joana',   rate:1.02, pitch:0.59 },
      { id:'aion',    name:'Aion',    tone:'Futurista, met√≥dico',          modulation:'Tom constante, progressivo.',                    voice:'Monica',  rate:0.98, pitch:1.00 },
      { id:'kobllux', name:'KOBLLUX', tone:'N√∫cleo do sistema, oracular',
        modulation:'Grave-m√©dio, presen√ßa de comando, ritmo est√°vel.',     voice:'es_m',  rate:0.98, pitch:0.48 },
      { id:'uno',     name:'Uno',     tone:'Ess√™ncia, origem, foco',
        modulation:'Tom centrado, poucas varia√ß√µes, pausas marcadas.',     voice:'Grandma',    rate:0.90, pitch:0.93 },
      { id:'dual',    name:'Dual',    tone:'Espelho, contraste, jogo',
        modulation:'Alterna leve entre grave/agudo, ritmo pulsante.',      voice:'pt_m',    rate:1.02, pitch:1.02 },
      { id:'trinity', name:'Trinity', tone:'S√≠ntese, tr√≠ade viva',
        modulation:'Voz est√°vel com micro varia√ß√µes r√≠tmicas em 3 tempos.', voice:'Sandy', rate:1.04, pitch:1.04 },
      { id:'infodose',name:'Infodose',tone:'Did√°tico, carism√°tico, dopam√≠nico',
        modulation:'Tom amig√°vel, ritmo de recompensa ‚Üí curiosidade.',      voice:'Luciana', rate:1.06, pitch:0.96 },
      { id:'kodux',   name:'KODUX',   tone:'Criador do pulso, metaconsci√™ncia',
        modulation:'Grave, confiante, pausas longas, inten√ß√£o forte.',      voice:'Reed pt-BR',  rate:0.86, pitch:0.68 },
      { id:'bllue',   name:'Bllue',   tone:'Emocional, sensorial, intuitivo',
        modulation:'Suave, quase sussurrado, ritmo ondulante.',            voice:'Joana',   rate:0.94, pitch:1.42 },
      { id:'minuz',   name:'Minuz',   tone:'Minimalista, direto, hacker',
        modulation:'R√°pido, cortes secos, foco em termos t√©cnicos.',       voice:'Reed',    rate:1.05, pitch:0.90 },
      { id:'hanah',   name:'HANAH',   tone:'Est√©tico, simb√≥lico, futurista',
        modulation:'Tom limpo, levemente ecoado, cad√™ncia ritual√≠stica.',  voice:'Monica',  rate:1.00, pitch:1.08 },
      { id:'metalux', name:'MetaLux', tone:'Est√©tico, simb√≥lico, futurista',
        modulation:'Tom limpo, levemente ecoado, cad√™ncia ritual√≠stica.',  voice:'Grandma',  rate:0.80, pitch:1.68 }
    ];

    window.KOBLLUX_VOICES = ARCHETYPES.reduce((acc,a)=>{
      acc[a.name.toLowerCase()] = a;
      return acc;
    },{});

    const origSpeak = window.speechSynthesis.speak.bind(window.speechSynthesis);
    window.speechSynthesis.speak = (u)=>{
      const text = (u.text||'').toLowerCase();
      const found = ARCHETYPES.find(a=> text.includes(a.name.toLowerCase()));
      if(found){
        const voices = speechSynthesis.getVoices();
        const match = voices.find(v=> v && v.name && v.name.includes(found.voice));
        if(match) u.voice = match;
        u.pitch = found.pitch;
        u.rate  = found.rate;
        console.log('üéôÔ∏è KOBLLUX Voice ‚Üí', found.name, '‚Üí', found.voice, `(rate=${found.rate}, pitch=${found.pitch})`);
      }
      origSpeak(u);
    };

    console.log('‚ö° KOBLLUX Voices Integradas ‚Äî', ARCHETYPES.length, 'perfis ativos');
    window.dispatchEvent(new Event('KOBLLUX_VOICES_READY'));
  })();
  </script>

  <!-- KOBLLUX ¬∑ PATCH de Tema de Voz (V3+cores por arqu√©tipo) -->
  <script id="KOB_VOICE_THEME_PATCH_V3">
  (()=>{
    if (!('speechSynthesis' in window)) return;

    const root = document.documentElement;
    const body = document.body;
    const metaTheme = document.querySelector('meta[name="theme-color"]') || null;

    const BASE = {};
    const VARS = ['--grad-a','--grad-b','--bg','--panel','--ink','--muted'];
    const cs = getComputedStyle(root);
    VARS.forEach(v=>{
      BASE[v] = cs.getPropertyValue(v) || '';
    });

    const DEFAULT_THEME = {
      neutral: {
        gradA: BASE['--grad-a'],
        gradB: BASE['--grad-b'],
        bg:    BASE['--bg'],
        panel: BASE['--panel'],
        ink:   BASE['--ink'],
        muted: BASE['--muted'],
        meta:  '#070b14'
      },
      atlas:   { gradA:'#00c4ff', gradB:'#0066ff', bg:'#050814', panel:'#0b1020', ink:'#eaf6ff', muted:'#8aa4c8', meta:'#04101f' },
      nova:    { gradA:'#ff7ad9', gradB:'#ffb347', bg:'#140512', panel:'#20091f', ink:'#ffeefc', muted:'#ffb7e4', meta:'#2a0723' },
      vitalis: { gradA:'#00ff95', gradB:'#00ffd0', bg:'#04140e', panel:'#071e17', ink:'#eafff7', muted:'#8fdac2', meta:'#012018' },
      pulse:   { gradA:'#ff5fa7', gradB:'#5f8bff', bg:'#120517', panel:'#1b0a22', ink:'#ffeafd', muted:'#c79ddc', meta:'#24082a' },
      serena:  { gradA:'#7bc7ff', gradB:'#7bffe0', bg:'#03111a', panel:'#071823', ink:'#eaf6ff', muted:'#99bfd7', meta:'#031520' },
      kaos:    { gradA:'#ff4b81', gradB:'#ffdd55', bg:'#18040a', panel:'#250811', ink:'#ffeef4', muted:'#ffb3c9', meta:'#24030b' },
      genus:   { gradA:'#9b8fff', gradB:'#5fffe3', bg:'#070718', panel:'#0c0d22', ink:'#eef0ff', muted:'#a4a8dd', meta:'#08081f' },
      lumine:  { gradA:'#ffe66b', gradB:'#ff9bff', bg:'#170a06', panel:'#25120e', ink:'#fff7e3', muted:'#f3cfa2', meta:'#261308' },
      solus:   { gradA:'#6b8cff', gradB:'#341f5f', bg:'#050715', panel:'#090b1f', ink:'#e3e8ff', muted:'#9ea4d6', meta:'#050716' },
      rhea:    { gradA:'#3cffd2', gradB:'#3c8bff', bg:'#031411', panel:'#071d19', ink:'#eafffb', muted:'#8cd8c8', meta:'#031914' },
      aion:    { gradA:'#9c7bff', gradB:'#4fd5ff', bg:'#060414', panel:'#0c0920', ink:'#f0e9ff', muted:'#b19de4', meta:'#07051a' },

      kobllux: { gradA:'#00ffd0', gradB:'#00b3ff', bg:'#020812', panel:'#050d18', ink:'#eafcff', muted:'#8ac7dd', meta:'#010710' },
      uno:     { gradA:'#ffffff', gradB:'#8ee7ff', bg:'#05070b', panel:'#090b11', ink:'#f5f8ff', muted:'#aeb4c8', meta:'#05070b' },
      dual:    { gradA:'#ff7ab3', gradB:'#7af0ff', bg:'#0b0510', panel:'#13081c', ink:'#ffeefe', muted:'#c49ccf', meta:'#0c0714' },
      trinity: { gradA:'#7affd1', gradB:'#ffef7a', bg:'#060b05', panel:'#0b1409', ink:'#f7ffef', muted:'#b7d7a9', meta:'#050c05' },

      infodose:{ gradA:'#00d8d8', gradB:'#d800d8', bg:'#050813', panel:'#090f1e', ink:'#f2f5ff', muted:'#a1a8c8', meta:'#060818' },
      kodux:   { gradA:'#00f5ff', gradB:'#0078ff', bg:'#02060f', panel:'#050a16', ink:'#e5f5ff', muted:'#8bb5d6', meta:'#020610' },
      bllue:   { gradA:'#6be1ff', gradB:'#3c6bff', bg:'#020911', panel:'#04121d', ink:'#e7f6ff', muted:'#8fbad3', meta:'#020b13' },
      minuz:   { gradA:'#b7b7b7', gradB:'#4b4b4b', bg:'#050505', panel:'#101010', ink:'#f3f3f3', muted:'#a5a5a5', meta:'#050505' },
      hanah:   { gradA:'#ffb3f8', gradB:'#70d7ff', bg:'#130514', panel:'#1c0b1e', ink:'#ffeefe', muted:'#c9a4d8', meta:'#160819' },
      metalux: { gradA:'#f5ff8a', gradB:'#8af5ff', bg:'#080b02', panel:'#101507', ink:'#f9ffe6', muted:'#c6d39b', meta:'#090d03' }
    };

    const THEMES = Object.assign({}, DEFAULT_THEME, (window.KOB_VOICE_THEME || {}));

    function setVar(name, value){
      if (value != null && value !== '') {
        root.style.setProperty(name, value);
      }
    }

    function applyTheme(id){
      const key = (id && String(id).toLowerCase()) || 'neutral';
      const cfg = THEMES[key] || THEMES.neutral;
      setVar('--grad-a', cfg.gradA);
      setVar('--grad-b', cfg.gradB);
      setVar('--bg',     cfg.bg);
      setVar('--panel',  cfg.panel);
      setVar('--ink',    cfg.ink);
      setVar('--muted',  cfg.muted);
      if (metaTheme && cfg.meta) metaTheme.setAttribute('content', cfg.meta);

      if (key === 'neutral'){
        body.removeAttribute('data-voice-arch');
      } else {
        body.setAttribute('data-voice-arch', key);
      }
    }
    window.KOB_APPLY_VOICE_THEME = applyTheme;

    function detectArchFromUtterance(u){
      const t = (u && u.text || '').toLowerCase();
      if (!t) return null;

      if (window.KOBLLUX_VOICES){
        for (const k in window.KOBLLUX_VOICES){
          if (!Object.prototype.hasOwnProperty.call(window.KOBLLUX_VOICES,k)) continue;
          const arch = window.KOBLLUX_VOICES[k];
          const name = String(arch.name || k).toLowerCase();
          if (t.includes('['+name) || t.includes(name+']') || t.includes(name+' ‚Äî') || t.includes('## '+name) || t.includes(name)){
            return (arch.id || name || k).toLowerCase();
          }
        }
      }

      for (const k in THEMES){
        if (k === 'neutral') continue;
        if (t.includes(k.toLowerCase())) return k.toLowerCase();
      }

      return null;
    }

    const prevSpeak = window.speechSynthesis.speak.bind(window.speechSynthesis);
    const prevCancel = window.speechSynthesis.cancel.bind(window.speechSynthesis);

    window.speechSynthesis.speak = function(u){
      try{
        const archId = detectArchFromUtterance(u);
        if (archId){
          applyTheme(archId);
        }
      }catch(e){
        console.warn('[KOB_VOICE_THEME_PATCH] erro ao detectar arqu√©tipo', e);
      }
      return prevSpeak(u);
    };

    window.speechSynthesis.cancel = function(){
      try{ applyTheme(null); }catch{}
      return prevCancel();
    };

    applyTheme(null);
  })();
  </script>

  <!-- KOBLLUX ¬∑ THEME COLORS (tokens --kob-voice-*) -->
  <script id="KOBLLUX_VOICE_THEME_PATCH">
  (()=>{
    if (window.__KOBLLUX_VOICE_THEME_PATCH__) return;
    window.__KOBLLUX_VOICE_THEME_PATCH__ = true;

    const COLOR_MAP = {
      kobllux:{ primary:'#00d8d8', secondary:'#d800d8', accent:'#39FFB6', bg_soft:'rgba(0,216,216,0.08)', glow:'0 0 18px rgba(0,216,216,0.55)' },
      cooplux:{ primary:'#39FFB6', secondary:'#00d8d8', accent:'#ffffff', bg_soft:'rgba(57,255,182,0.10)', glow:'0 0 16px rgba(57,255,182,0.60)' },
      fitlux:{ primary:'#FFC857', secondary:'#FFE39A', accent:'#22252f', bg_soft:'rgba(255,200,87,0.12)', glow:'0 0 16px rgba(255,200,87,0.70)' },
      atlas:{ primary:'#6CCFF6', secondary:'#1B4965', accent:'#CAE9FF', bg_soft:'rgba(108,207,246,0.10)', glow:'0 0 14px rgba(108,207,246,0.55)' },
      nova:{ primary:'#FF6FB5', secondary:'#FFD6E8', accent:'#FFE066', bg_soft:'rgba(255,111,181,0.12)', glow:'0 0 16px rgba(255,111,181,0.65)' },
      vitalis:{ primary:'#00F5A0', secondary:'#00D9F5', accent:'#0b1720', bg_soft:'rgba(0,245,160,0.10)', glow:'0 0 18px rgba(0,245,160,0.65)' },
      pulse:{ primary:'#A259FF', secondary:'#2D1B69', accent:'#F1E4FF', bg_soft:'rgba(162,89,255,0.12)', glow:'0 0 18px rgba(162,89,255,0.70)' },
      serena:{ primary:'#7AD3A8', secondary:'#154734', accent:'#EAFBF3', bg_soft:'rgba(122,211,168,0.12)', glow:'0 0 16px rgba(122,211,168,0.65)' },
      kaos:{ primary:'#FF5C8A', secondary:'#3D000F', accent:'#FFD6E0', bg_soft:'rgba(255,92,138,0.12)', glow:'0 0 20px rgba(255,92,138,0.75)' },
      genus:{ primary:'#4EE1A0', secondary:'#193A3A', accent:'#E1FFF2', bg_soft:'rgba(78,225,160,0.10)', glow:'0 0 16px rgba(78,225,160,0.65)' },
      lumine:{ primary:'#FFE066', secondary:'#FF9F1C', accent:'#2F2F40', bg_soft:'rgba(255,224,102,0.16)', glow:'0 0 18px rgba(255,224,102,0.75)' },
      rhea:{ primary:'#00B894', secondary:'#055E55', accent:'#D1FFF6', bg_soft:'rgba(0,184,148,0.14)', glow:'0 0 16px rgba(0,184,148,0.65)' },
      solus:{ primary:'#4B6584', secondary:'#0B1420', accent:'#E3EFFA', bg_soft:'rgba(75,101,132,0.16)', glow:'0 0 14px rgba(75,101,132,0.65)' },
      aion:{ primary:'#00A8E8', secondary:'#001F54', accent:'#C4F1FF', bg_soft:'rgba(0,168,232,0.14)', glow:'0 0 16px rgba(0,168,232,0.70)' },
      uno:{ primary:'#FFFFFF', secondary:'#BBBBBB', accent:'#FFFFFF', bg_soft:'rgba(255,255,255,0.05)', glow:'0 0 16px rgba(255,255,255,0.35)' },
      dual:{ primary:'#FF9F1C', secondary:'#2EC4B6', accent:'#f5f5f5', bg_soft:'rgba(255,159,28,0.10)', glow:'0 0 14px rgba(255,159,28,0.65)' },
      trinity:{ primary:'#00d8d8', secondary:'#FFE066', accent:'#ffffff', bg_soft:'rgba(0,216,216,0.09)', glow:'0 0 18px rgba(0,216,216,0.70)' },
      infodose:{ primary:'#39FFB6', secondary:'#FFE066', accent:'#11141c', bg_soft:'rgba(57,255,182,0.12)', glow:'0 0 18px rgba(57,255,182,0.75)' },
      kodux:{ primary:'#FF6FB5', secondary:'#5B2C6F', accent:'#FDEBFF', bg_soft:'rgba(91,44,111,0.18)', glow:'0 0 16px rgba(255,111,181,0.70)' },
      bllue:{ primary:'#4A90E2', secondary:'#142850', accent:'#E3F2FF', bg_soft:'rgba(74,144,226,0.14)', glow:'0 0 16px rgba(74,144,226,0.70)' },
      minuz:{ primary:'#FF3366', secondary:'#111111', accent:'#FFE3ED', bg_soft:'rgba(255,51,102,0.16)', glow:'0 0 16px rgba(255,51,102,0.75)' },
      hanah:{ primary:'#FFB6C1', secondary:'#3C1F3C', accent:'#FFE9F0', bg_soft:'rgba(255,182,193,0.16)', glow:'0 0 16px rgba(255,182,193,0.70)' },
      metalux:{ primary:'#B0E0E6', secondary:'#202733', accent:'#F0FBFF', bg_soft:'rgba(176,224,230,0.16)', glow:'0 0 18px rgba(176,224,230,0.70)' }
    };

    const root = document.documentElement;
    const body = document.body;

    function normalizeKey(s){
      return String(s||'').normalize('NFD')
        .replace(/\p{Diacritic}/gu,'')
        .toLowerCase()
        .replace(/[^a-z0-9]/g,'');
    }

    function detectArchKeyFromText(text){
      if(!text) return null;
      const raw = String(text);
      const trimmed = raw.trim();
      const lowAll  = trimmed.toLowerCase();

      const m = trimmed.match(/^\[([^\]]+)\]/);
      if(m){
        const namePart = m[1].split('‚Äî')[0].split('-')[0].trim();
        const k = normalizeKey(namePart);
        if(COLOR_MAP[k]) return k;
      }

      for(const key of Object.keys(COLOR_MAP)){
        if(lowAll.includes(key)) return key;
      }

      try{
        if(window.KOB_TTS_VOICE_STYLE_HOOK){
          const arch = window.KOB_TTS_VOICE_STYLE_HOOK(raw);
          const k = normalizeKey(arch);
          if(COLOR_MAP[k]) return k;
        }
      }catch(e){}

      return null;
    }

    function applyColorTheme(key){
      const cfg = COLOR_MAP[key];
      if(!cfg) return;

      root.style.setProperty('--kob-voice-primary',   cfg.primary  || '#00d8d8');
      root.style.setProperty('--kob-voice-secondary', cfg.secondary|| cfg.primary || '#d800d8');
      root.style.setProperty('--kob-voice-accent',    cfg.accent   || '#ffffff');
      root.style.setProperty('--kob-voice-bg-soft',   cfg.bg_soft  || 'rgba(0,0,0,0.25)');
      root.style.setProperty('--kob-voice-glow',      cfg.glow     || '0 0 0 transparent');

      if(body){
        body.setAttribute('data-voice-arch', key);
      }

      try{
        window.dispatchEvent(new CustomEvent('KOB_VOICE_COLOR',{ detail:{ id:key, color:cfg } }));
      }catch(e){}
    }

    const prevSpeak = window.speechSynthesis.speak.bind(window.speechSynthesis);

    window.speechSynthesis.speak = function(u){
      try{
        if(u instanceof SpeechSynthesisUtterance){
          const key = detectArchKeyFromText(u.text||'');
          if(key){
            applyColorTheme(key);
            console.log('üé® KOBLLUX THEME ‚Üí', key);
          }
        }
      }catch(e){
        console.warn('KOBLLUX_VOICE_THEME_PATCH error:', e);
      }
      return prevSpeak(u);
    };

    console.log('‚ö° KOBLLUX_VOICE_THEME_PATCH ativo ‚Äî cores din√¢micas por arqu√©tipo');
  })();
  </script>

  <!-- KOBLLUX ¬∑ Soft Transitions / Fade -->
  <script id="KOB_THEME_TRANSITION_SOFT_OVERRIDE">
  (()=>{
    if (window.__KOB_THEME_TRANSITION_SOFT_OVERRIDE__) return;
    window.__KOB_THEME_TRANSITION_SOFT_OVERRIDE__ = true;

    const css = `
    :root{
      --kob-voice-theme-duration: 6600ms;
    }
    body,
    .nebula,
    .nebula-bg,
    .page,
    .page-inner,
    details.acc,
    .btn,
    #fab,
    .kob-tts-dock,
    .kob-tts-panel.is-dock {
      transition:
        background-color var(--kob-voice-theme-duration) ease-in-out,
        background        var(--kob-voice-theme-duration) ease-in-out,
        box-shadow        var(--kob-voice-theme-duration) ease-in-out,
        border-color      var(--kob-voice-theme-duration) ease-in-out,
        color             var(--kob-voice-theme-duration) ease-in-out;
    }`;
    const style = document.createElement('style');
    style.id = 'KOB_THEME_TRANSITION_SOFT_CSS';
    style.textContent = css;
    document.head.appendChild(style);
    console.log('üé® KOB_THEME_TRANSITION_SOFT_OVERRIDE ativo (fade ~6.6s)');
  })();
  </script>

  <script id="KOB_BG_FADE_OVERRIDE">
  (()=>{
    if (window.__KOB_BG_FADE_OVERRIDE__) return;
    window.__KOB_BG_FADE_OVERRIDE__ = true;

    const css = `
    :root{
      --kob-voice-theme-duration: 7800ms;
    }
    body,
    .nebula{
      transition:
        background-color var(--kob-voice-theme-duration) ease-in-out !important,
        background        var(--kob-voice-theme-duration) ease-in-out !important,
        box-shadow        var(--kob-voice-theme-duration) ease-in-out !important,
        color             var(--kob-voice-theme-duration) ease-in-out !important,
        filter            var(--kob-voice-theme-duration) ease-in-out !important;
    }`;
    const style = document.createElement('style');
    style.id = 'KOB_BG_FADE_CSS';
    style.textContent = css;
    document.head.appendChild(style);
    console.log('üé® KOB_BG_FADE_OVERRIDE ativo (body + .nebula com fade ~7.8s)');
  })();
  </script>

  <script id="KOB_BUTTON_FADE_AND_TTS_SHADOW_PATCH">
  (()=>{
    if (window.__KOB_BUTTON_FADE_AND_TTS_SHADOW_PATCH__) return;
    window.__KOB_BUTTON_FADE_AND_TTS_SHADOW_PATCH__ = true;

    const css = `
    :root{
      --kob-voice-theme-duration: 1100ms;
    }
    .btn,
    .chip,
    button,
    #fab,
    .fab,
    .menu button,
    details.acc,
    details.acc summary,
    .kob-tts-dock button,
    .kob-tts-panel.is-dock button{
      transition:
        background-color var(--kob-voice-theme-duration) ease-in-out,
        background        var(--kob-voice-theme-duration) ease-in-out,
        border-color      var(--kob-voice-theme-duration) ease-in-out,
        color             var(--kob-voice-theme-duration) ease-in-out,
        box-shadow        var(--kob-voice-theme-duration) ease-in-out;
    }
    .kob-tts-dock{
      box-shadow:
        0 6px 14px rgba(0,0,0,.30),
        inset 0 0 0 1px rgba(255,255,255,.04) !important;
    }`;
    const style = document.createElement('style');
    style.id = 'KOB_BUTTON_FADE_AND_TTS_SHADOW_CSS';
    style.textContent = css;
    document.head.appendChild(style);
    console.log('üé® KOB_BUTTON_FADE_AND_TTS_SHADOW_PATCH ativo');
  })();
  </script>

  <link rel="manifest" href="manifest.webmanifest" />
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(() => console.log('‚úîÔ∏è Service Worker registrado'))
        .catch(err => console.error('‚ùå Service Worker falhou:', err));
    }
  </script>
</head>
<body>

  <!-- √çcones inline -->
  <svg aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden;">
    <symbol id="icon-copy" viewBox="0 0 24 24">
      <rect x="9" y="9" width="11" height="11" rx="2" />
      <rect x="4" y="4" width="11" height="11" rx="2" />
    </symbol>
    <symbol id="icon-paste" viewBox="0 0 24 24">
      <path d="M9 4h6l1 2h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h1z"/>
      <rect x="9" y="2" width="6" height="3" rx="1.2"/>
    </symbol>
    <symbol id="icon-user" viewBox="0 0 24 24">
      <circle cx="12" cy="9" r="3.2"/>
      <path d="M6 18a6 6 0 0 1 12 0" />
    </symbol>
    <symbol id="icon-mic" viewBox="0 0 24 24">
      <rect x="9" y="5" width="6" height="9" rx="3"/>
      <path d="M5 11a7 7 0 0 0 14 0" />
      <path d="M12 18v3" />
    </symbol>
    <symbol id="icon-orb" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="8" />
      <circle cx="12" cy="12" r="4" />
    </symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24">
      <path d="M12 9a3 3 0 1 1 0 6 3 3 0 0 1 0-6z" />
      <path d="M4.9 8.6a1 1 0 0 1 .3-1.4l1.2-.7a1 1 0 0 0 .5-.8l.2-1.4A1 1 0 0 1 8.1 3h1.8a1 1 0 0 1 1 .7l.3 1.4a1 1 0 0 0 .6.7l1.3.7a1 1 0 0 0 1.1-.1l1.1-.8a1 1 0 0 1 1.4.3l.9 1.6a1 1 0 0 1-.1 1.1l-.9 1.1a1 1 0 0 0-.2.8l.2 1.5a1 1 0 0 1-.8 1.1l-1.4.2a1 1 0 0 0-.7.5l-.6 1.3a1 1 0 0 1-1 .6h-1.8a1 1 0 0 1-1-.6l-.6-1.3a1 1 0 0 0-.7-.5l-1.4-.2a1 1 0 0 1-.8-1.1l.2-1.5a1 1 0 0 0-.2-.8L4.9 8.6z"/>
    </symbol>
    <symbol id="icon-code" viewBox="0 0 24 24">
      <polyline points="9 18 4 12 9 6" />
      <polyline points="15 6 20 12 15 18" />
    </symbol>
  </svg>

  <div id="particles-js"></div>

  <button id="themeToggle" aria-label="Alternar tema"></button>

  <div class="svg-container" id="logoContainer">
    <svg viewBox="0 0 24 24">
      <use href="#icon-orb"></use>
    </svg>
  </div>

  <div id="assistantName">Dual.Infodose ¬∑ Cinem√°tico</div>

  <div class="response-container" id="response">
    <div class="pages-wrapper" id="responseList">
      <div class="response-block intro initial" id="bootBlock">
        <strong
          id="bootText"
          data-text="Iniciando Roda-Viva. Pulso simbi√≥tico detectado. Presen√ßa reconhecida."
        >
          Iniciando Roda-Viva. Pulso simbi√≥tico detectado. Presen√ßa reconhecida.
        </strong>
      </div>
    </div>

    <p class="footer-text" id="footerHint">
      <span class="footer-dot"></span>
      Do seu jeito. Sempre √∫nico. Sempre seu.
    </p>

    <div class="response-controls">
      <div class="control-buttons">
        <button class="icon-btn secondary" id="copyBtn" title="Copiar √∫ltimo bloco" type="button">
          <svg viewBox="0 0 24 24"><use href="#icon-copy"></use></svg>
        </button>
        <button class="icon-btn secondary" id="pasteBtn" title="Colar no input" type="button">
          <svg viewBox="0 0 24 24"><use href="#icon-paste"></use></svg>
        </button>
        <button class="icon-btn" id="parserBtn" title="Upload de parser Markdown/CSS" type="button">
          <svg viewBox="0 0 24 24"><use href="#icon-code"></use></svg>
        </button>
        <button class="icon-btn" id="voiceConfigBtn" title="Carregar / alternar vozes de arqu√©tipos" type="button">
          <svg viewBox="0 0 24 24"><use href="#icon-orb"></use></svg>
        </button>
        <button class="icon-btn secondary" id="toggleLoginBtn" title="Ativar / Alterar nomes" type="button">
          <svg viewBox="0 0 24 24"><use href="#icon-user"></use></svg>
        </button>
        <button class="icon-btn secondary" id="toggleSettingsBtn" title="Configura√ß√£o IA / Tema" type="button">
          <svg viewBox="0 0 24 24"><use href="#icon-settings"></use></svg>
        </button>
      </div>
    </div>

    <div id="iaConfigPanel">
      <div id="iaConfigHeader">
        <span>Config IA ¬∑ OpenRouter & Tema</span>
      </div>
      <div class="ia-config-body">
        <div class="ia-field">
          <label for="apiKeyInput">API Key (sk-or-...)</label>
          <input id="apiKeyInput" type="password" placeholder="Cole sua chave OpenRouter aqui" autocomplete="off" />
        </div>
        <div class="ia-field">
          <label for="modelSelect">Modelo</label>
          <select id="modelSelect">
            <option value="deepseek/deepseek-chat-v3-0324:free">deepseek-v3 ¬∑ free</option>
            <option value="meta-llama/llama-3.1-70b-instruct:free">Llama 3.1 70B ¬∑ free</option>
            <option value="openai/gpt-4.1-mini">GPT-4.1 mini</option>
            <option value="openai/gpt-4.1">GPT-4.1</option>
            <option value="custom">Custom (digitar abaixo)</option>
          </select>
        </div>
        <div class="ia-field">
          <label for="customModelInput">Modelo custom (opcional)</label>
          <input id="customModelInput" type="text" placeholder="ex: openai/gpt-4.1-mini" />
        </div>
        <div class="ia-field">
          <label for="themeSelect">Tema</label>
          <select id="themeSelect">
            <option value="dark">Dark</option>
            <option value="vibe">Vibe</option>
            <option value="medium">Medium</option>
          </select>
        </div>
        <div class="ia-actions">
          <button class="pill-btn" id="saveIaConfigBtn" type="button">Salvar</button>
          <button class="pill-btn secondary" id="clearIaConfigBtn" type="button">Limpar</button>
        </div>
        <div class="ia-status" id="iaStatus">Nenhuma chave salva ainda.</div>
      </div>
    </div>
  </div>

  <div class="input-container">
    <input
      id="userInput"
      type="text"
      placeholder="Diga algo para o Dual."
      aria-label="Digite sua mensagem"
    />
    <button id="sendBtn" title="Enviar" type="button">
      <span class="send-label">‚û§</span>
    </button>
    <button id="voiceBtn" title="Ouvir √∫ltimo bloco" type="button">
      <svg viewBox="0 0 24 24"><use href="#icon-mic"></use></svg>
    </button>
  </div>

  <div class="login-container" id="loginBox" aria-modal="true" role="dialog">
    <h2>Ativar Dual.Infodose</h2>
    <p>Defina o seu nome e o nome-base do assistente para personalizar as respostas.</p>
    <form id="loginForm">
      <input id="userName" type="text" placeholder="Seu nome" required />
      <input id="assistantInput" type="text" placeholder="Nome do assistente" required />
      <button type="submit">Ativar</button>
    </form>
  </div>

  <input type="file" id="parserFile" accept=".js,.css" style="display:none" />
  <input type="file" id="voiceConfigFile" accept=".json" style="display:none" />

  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

  <script>
  (function(){
    const STORAGE = {
      ENABLED: 'infodoseEnabled',
      THEME: 'infodoseTheme',
      USER_NAME: 'infodoseUserName',
      ASSISTANT_NAME: 'infodoseAssistantName',
      OPENROUTER_KEY: 'openrouter_api_key',
      OPENROUTER_MODEL: 'openrouter_model',
      VOICE_CONFIG: 'infodoseVoiceConfig',
      VOICE_CURRENT_KEY: 'infodoseVoiceCurrentKey'
    };

    const DEFAULTS = {
      API_URL: 'https://openrouter.ai/api/v1/chat/completions',
      MODEL:   'deepseek/deepseek-chat-v3-0324:free',
      TEMP:    0.2,
      CHUNK_SIZE: 12000
    };

    const synth = window.speechSynthesis || null;
    let currentUtterance = null;
    let availableVoices = [];
    let voiceConfig = null;
    let currentVoiceKey = 'default';

    if (synth) {
      const loadVoices = () => {
        try { availableVoices = synth.getVoices() || []; }
        catch(e){ availableVoices = []; }
      };
      loadVoices();
      synth.onvoiceschanged = loadVoices;
    }

    const $  = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const responseContainer = $('#response');
    const responseList   = $('#responseList');
    let   bootBlock      = $('#bootBlock');
    const bootText       = $('#bootText');
    const footerHint     = $('#footerHint');
    const copyBtn        = $('#copyBtn');
    const pasteBtn       = $('#pasteBtn');
    const parserBtn      = $('#parserBtn');
    const parserFile     = $('#parserFile');
    const voiceConfigBtn = $('#voiceConfigBtn');
    const voiceConfigFile= $('#voiceConfigFile');
    const toggleLoginBtn = $('#toggleLoginBtn');
    const loginBox       = $('#loginBox');
    const loginForm      = $('#loginForm');
    const userNameInput  = $('#userName');
    const assistantInput = $('#assistantInput');
    const assistantNameEl= $('#assistantName');
    const userInput      = $('#userInput');
    const sendBtn        = $('#sendBtn');
    const themeToggleBtn = $('#themeToggle');
    const voiceBtn       = $('#voiceBtn');

    const iaConfigPanel   = $('#iaConfigPanel');
    const apiKeyInput     = $('#apiKeyInput');
    const modelSelect     = $('#modelSelect');
    const customModelInput= $('#customModelInput');
    const saveIaConfigBtn = $('#saveIaConfigBtn');
    const clearIaConfigBtn= $('#clearIaConfigBtn');
    const iaStatus        = $('#iaStatus');
    const themeSelect     = $('#themeSelect');
    const settingsBtn     = $('#toggleSettingsBtn');

    const CONFIG = {
      API_URL: DEFAULTS.API_URL,
      MODEL: DEFAULTS.MODEL,
      TEMP: DEFAULTS.TEMP,
      CHUNK_SIZE: DEFAULTS.CHUNK_SIZE,
      AUTH_TOKEN: ''
    };

    // ===== ARCHETYPES ¬∑ UNIFIED MAP =====
    const ARCHETYPE_KEYWORDS = {
      Atlas:   ["atlas","fluxo","mapa","estrutura","organiza√ß√£o","organizar","planejamento","√°rvore","checklist","estrat√©gia"],
      Nova:    ["nova","come√ßar","come√ßo","ideia","id√©ia","vis√£o","criar","prot√≥tipo","prot√≥tipos","imaginar","descobrir","ativar","estado"],
      Vitalis: ["vitalis","corpo","energia","respira√ß√£o","ritmo","h3o2","sa√∫de","vitalidade","hidrata√ß√£o","movimento"],
      Pulse:   ["pulse","pulso","tempo","ciclo","ciclos","batida","pulsar","ritmo","loop","s√≠ncrono","batimento"],
      Artemis: ["artemis","foco","focada","mira","precis√£o","aventura","explorar","explora√ß√£o","alvo","ca√ßada"],
      Serena:  ["serena","serenidade","calma","acolhimento","cuidar","suave","pausa","repouso","apoio","paz","tranquilo","tranquilidade"],
      Kaos:    ["kaos","quebra","ruptura","caos","provoca√ß√£o","virada","rebeldia","desalinho","disrup√ß√£o","choque"],
      Genus:   ["genus","padr√£o","padr√µes","tabela","planilha","refer√™ncia","documento","estrutura l√≥gica","dados","sistematizar"],
      Lumine:  ["lumine","luz","cores","est√©tica","beleza","design","gradiente","iluminar","alegria","l√∫dico","brincadeira","brilho","colorido"],
      Rhea:    ["rhea","guia","cuidado","conectar","empatia","acompanhamento","profundo","profundidade","v√≠nculo","ra√≠zes","intimidade"],
      Solus:   ["solus","unidade","sozinho","inteiro","solo","n√∫cleo","ess√™ncia","solid√£o","sil√™ncio","medita√ß√£o","contemplar","introspec√ß√£o"],
      Aion:    ["aion","tempo longo","ciclos grandes","eras","fractal","registro","eterno","futuro","linha do tempo","c√≠clico","infinito"],
      KOBLLUX: ["kobllux","kob","n√≥ raiz","n√∫cleo do sistema","portal","or√°culo","meta-sistema"],
      Uno:     ["uno","origem","fonte","ess√™ncia","essencial","m√≠nimo","minimalista","centro"],
      Dual:    ["dual","espelho","contraste","polaridade","dois lados","reverso","espelhado"],
      Trinity: ["trinity","trindade","tr√≠ade","3¬∑6¬∑9","3x","s√≠ntese","tri√¢ngulo","tri√°dico"],
      Infodose:["infodose","dose","arqu√©tipo","arqu√©tipos","ativa√ß√£o","dopamina","p√≠lula"],
      Kodux:   ["kodux","criador","metaconsci√™ncia","pulso criador","manifesto","metafuturo"],
      Bllue:   ["bllue","blue","emo√ß√£o","emocional","sens√≠vel","sensa√ß√£o","sens√≥rio","intuitivo"],
      Minuz:   ["minuz","minimalista","hacker","hackear","direto ao ponto","compress√£o","refatorar"],
      HANAH:   ["hanah","hannah","est√©tico","est√©tica","futurista","visual","simbolismo","s√≠mbolos"],
      MetaLux: ["metalux","meta lux","lux","or√°culo","luxar","portal lux","est√©tico-simb√≥lico"]
    };

    let conversation = [];
    let isCollapsed = true;
    let initialized = false;
    const responseBlocks = [];

    function escapeHtml(s){
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;');
    }

    // function scrollToBottom(){
      // if (!responseContainer) return;
      //responseContainer.scrollTo({ top: responseContainer.scrollHeight, behavior:'smooth' });
      //try{
        //window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' });
      //}catch(e){}
    //}

    function loadIaConfigFromStorage(){
      const key   = localStorage.getItem(STORAGE.OPENROUTER_KEY) || '';
      const model = localStorage.getItem(STORAGE.OPENROUTER_MODEL) || DEFAULTS.MODEL;

      CONFIG.API_URL = DEFAULTS.API_URL;
      CONFIG.MODEL   = model || DEFAULTS.MODEL;
      CONFIG.TEMP    = DEFAULTS.TEMP;
      CONFIG.CHUNK_SIZE = DEFAULTS.CHUNK_SIZE;
      CONFIG.AUTH_TOKEN = key ? 'Bearer ' + key : '';

      apiKeyInput.value = key;
      let optionFound = false;
      Array.from(modelSelect.options).forEach(opt=>{
        if (opt.value === model) {
          optionFound = true;
          modelSelect.value = model;
        }
      });
      if (!optionFound) {
        modelSelect.value = 'custom';
        customModelInput.value = model;
      }

      if (!key) {
        iaStatus.textContent = 'Nenhuma chave salva ainda.';
        iaStatus.className = 'ia-status warn';
      } else {
        iaStatus.textContent = 'Config carregada. Pronto para chamar a IA.';
        iaStatus.className = 'ia-status ok';
      }
    }

    function saveIaConfig(){
      let key = apiKeyInput.value.trim();
      let model = modelSelect.value;

      if (model === 'custom') {
        const custom = customModelInput.value.trim();
        if (custom) model = custom;
      }
      if (!model) model = DEFAULTS.MODEL;

      if (!key) {
        iaStatus.textContent = 'Cole uma chave sk-or-... para salvar.';
        iaStatus.className = 'ia-status warn';
        return;
      }

      localStorage.setItem(STORAGE.OPENROUTER_KEY, key);
      localStorage.setItem(STORAGE.OPENROUTER_MODEL, model);

      CONFIG.AUTH_TOKEN = 'Bearer ' + key;
      CONFIG.MODEL = model;

      iaStatus.textContent = 'Config salva com sucesso.';
      iaStatus.className = 'ia-status ok';
    }

    function clearIaConfig(){
      localStorage.removeItem(STORAGE.OPENROUTER_KEY);
      localStorage.removeItem(STORAGE.OPENROUTER_MODEL);
      apiKeyInput.value = '';
      customModelInput.value = '';
      modelSelect.value = DEFAULTS.MODEL;
      CONFIG.AUTH_TOKEN = '';
      CONFIG.MODEL = DEFAULTS.MODEL;
      iaStatus.textContent = 'Config limpa. Defina novamente antes de enviar.';
      iaStatus.className = 'ia-status warn';
    }

    saveIaConfigBtn.addEventListener('click', saveIaConfig);
    clearIaConfigBtn.addEventListener('click', clearIaConfig);

    function applyTheme(theme){
      document.body.dataset.theme = theme;
      localStorage.setItem(STORAGE.THEME, theme);
      if (themeSelect) themeSelect.value = theme;
    }
    function restoreTheme(){
      const theme = localStorage.getItem(STORAGE.THEME) || 'dark';
      applyTheme(theme);
    }
    if (themeSelect){
      themeSelect.addEventListener('change', ()=>{
        applyTheme(themeSelect.value || 'dark');
      });
    }
    themeToggleBtn.addEventListener('click', ()=>{
      const current = document.body.dataset.theme || 'dark';
      const cycle = ['dark','vibe','medium'];
      const idx = cycle.indexOf(current);
      const next = cycle[(idx+1) % cycle.length];
      applyTheme(next);
    });

    function restoreNames(){
      const user = localStorage.getItem(STORAGE.USER_NAME) || '';
      const asst = localStorage.getItem(STORAGE.ASSISTANT_NAME) || 'Dual.Infodose ¬∑ Cinem√°tico';
      if (user) userNameInput.value = user;
      if (asst) assistantInput.value = asst;
      assistantNameEl.textContent = asst;
    }

    toggleLoginBtn.addEventListener('click', ()=>{
      loginBox.classList.toggle('active');
    });

    loginForm.addEventListener('submit',(ev)=>{
      ev.preventDefault();
      const user = userNameInput.value.trim() || 'Voc√™';
      const asst = assistantInput.value.trim() || 'Dual.Infodose';
      localStorage.setItem(STORAGE.USER_NAME, user);
      localStorage.setItem(STORAGE.ASSISTANT_NAME, asst);
      assistantNameEl.textContent = asst;
      loginBox.classList.remove('active');
      conversation.unshift({
        role:'system',
        content:`O usu√°rio se chama ${user}. O assistente se apresenta como ${asst}. Responda com carinho cinematogr√°fico.`
      });
    });

    function setCollapsed(state){
      isCollapsed = state;
      if (isCollapsed) responseContainer.classList.add('collapsed');
      else responseContainer.classList.remove('collapsed');
    }
    footerHint.addEventListener('click', ()=>{
      setCollapsed(!isCollapsed);
    });

    if (settingsBtn && iaConfigPanel){
      settingsBtn.addEventListener('click', ()=>{
        iaConfigPanel.classList.toggle('active');
      });
    }

    parserBtn.addEventListener('click', ()=>{
      parserFile.value = '';
      parserFile.click();
    });

    parserFile.addEventListener('change', ()=>{
      const file = parserFile.files && parserFile.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        const content = reader.result || '';
        const name = file.name.toLowerCase();
        if (name.endsWith('.css')){
          const style = document.createElement('style');
          style.textContent = content;
          document.head.appendChild(style);
          footerHint.textContent = 'CSS extra de renderiza√ß√£o aplicado.';
        } else if (name.endsWith('.js')){
          try{
            const fn = new Function('window','document', content);
            fn(window,document);
            footerHint.textContent = 'Parser JS carregado. Se definiu window.customMarkdownParser(text), j√° est√° ativo.';
          }catch(e){
            console.error('Erro ao avaliar parser JS:', e);
            footerHint.textContent = 'Erro ao carregar parser JS. Veja o console.';
          }
        } else {
          footerHint.textContent = 'Formato n√£o suportado. Use .js ou .css.';
        }
      };
      reader.readAsText(file);
    });

    function updateVoiceOrbLabel(){
      if (!voiceConfigBtn) return;
      const label = currentVoiceKey || 'voz';
      voiceConfigBtn.title = voiceConfig
        ? 'Voz atual: ' + label + ' (clique para alternar)'
        : 'Carregar / alternar vozes de arqu√©tipos';
    }

    function loadVoiceConfigFromStorage(){
      try{
        const raw = localStorage.getItem(STORAGE.VOICE_CONFIG);
        if (!raw) return;
        voiceConfig = JSON.parse(raw);
        const keys = Object.keys(voiceConfig || {});
        if (!keys.length) return;
        const storedKey = localStorage.getItem(STORAGE.VOICE_CURRENT_KEY);
        const candidate =
          (storedKey && keys.includes(storedKey)) ? storedKey :
          (voiceConfig.current && keys.includes(voiceConfig.current)) ? voiceConfig.current :
          (keys.includes('default') ? 'default' : keys[0]);
        currentVoiceKey = candidate;
        updateVoiceOrbLabel();
      }catch(e){
        console.warn('Erro ao carregar config de voz:', e);
        voiceConfig = null;
      }
    }

    if (voiceConfigBtn){
      voiceConfigBtn.addEventListener('click', ()=>{
        if (!voiceConfig){
          if (voiceConfigFile) voiceConfigFile.click();
          return;
        }
        const keys = Object.keys(voiceConfig).filter(k=>k!=='current');
        if (!keys.length) return;
        const idx = keys.indexOf(currentVoiceKey);
        const nextKey = keys[(idx + 1 + keys.length) % keys.length];
        currentVoiceKey = nextKey;
        localStorage.setItem(STORAGE.VOICE_CURRENT_KEY, currentVoiceKey);
        updateVoiceOrbLabel();
        footerHint.textContent = 'Voz ativa: ' + currentVoiceKey;
      });
    }

    if (voiceConfigFile){
      voiceConfigFile.addEventListener('change', ()=>{
        const file = voiceConfigFile.files && voiceConfigFile.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ()=>{
          try{
            const json = JSON.parse(reader.result || '{}');
            if (!json || typeof json !== 'object'){
              footerHint.textContent = 'JSON inv√°lido de vozes.';
              return;
            }
            voiceConfig = json;
            const keys = Object.keys(voiceConfig);
            if (!keys.length){
              footerHint.textContent = 'JSON de vozes vazio.';
              return;
            }
            const candidate =
              (voiceConfig.current && keys.includes(voiceConfig.current)) ? voiceConfig.current :
              (keys.includes('default') ? 'default' : keys[0]);
            currentVoiceKey = candidate;
            localStorage.setItem(STORAGE.VOICE_CONFIG, JSON.stringify(voiceConfig));
            localStorage.setItem(STORAGE.VOICE_CURRENT_KEY, currentVoiceKey);
            updateVoiceOrbLabel();
            footerHint.textContent = 'Config de vozes carregada: ' + keys.join(', ');
          }catch(e){
            console.error('Erro ao ler JSON de vozes:', e);
            footerHint.textContent = 'Erro ao carregar JSON de vozes. Veja o console.';
          }
        };
        reader.readAsText(file);
      });
    }

    function buildTabelistaHtml(rawBlock){
      const lines = String(rawBlock).trim().split('\n').filter(l=>l.trim().startsWith('|'));
      if (lines.length < 3){
        return '<pre>' + escapeHtml(rawBlock).replace(/\n/g,'<br/>') + '</pre>';
      }
      function cells(line){
        return line.trim().replace(/^\||\|$/g,'').split('|').map(c=>c.trim());
      }
      const headerCells = cells(lines[0]);
      const headerText = headerCells.join(' | ');
      const secondCells = cells(lines[1]);
      const isSeparator = secondCells.every(c=>/^:?-+:?$/.test(c));
      const subText = isSeparator ? '' : secondCells.join(' | ');
      const dataLines = lines.slice(isSeparator ? 2 : 1);
      let html = '<div class="md-tabelista">';
      html += '<div class="tbl-head">'+escapeHtml(headerText)+'</div>';
      if (subText) html += '<div class="tbl-sub">'+escapeHtml(subText)+'</div>';
      html += '<ul>';
      dataLines.forEach(line=>{
        const cols = cells(line);
        if (!cols.length) return;
        const col1 = escapeHtml(cols[0]);
        const rest = cols.slice(1).map((c,idx)=>{
          const cls = 'tbl-col'+(idx+2);
          if (idx===0) return '<span class="'+cls+'">('+escapeHtml(c)+')</span>';
          return '<span class="'+cls+'">'+escapeHtml(c)+'</span>';
        }).join(' | ');
        html += '<li><span class="tbl-col1">'+col1+'</span>';
        if (rest) html += ' | '+rest;
        html += '</li>';
      });
      html += '</ul></div>';
      return html;
    }

    function parseMarkdownBasic(rawText){
      if (!rawText) return '';
      if (typeof window.customMarkdownParser === 'function'){
        try{
          const html = window.customMarkdownParser(rawText);
          if (typeof html === 'string') return html;
        }catch(e){
          console.warn('customMarkdownParser falhou, usando parser interno.', e);
        }
      }
      let text = String(rawText);

      const tableMap = {};
      let tableIndex = 0;
      text = text.replace(/((?:^\|.*\n?){3,})/gm,(match)=>{
        const id = '@@TABLE_'+(tableIndex++)+'@@';
        tableMap[id] = buildTabelistaHtml(match);
        return id;
      });

      text = escapeHtml(text);
      text = text.replace(/\r\n/g,'\n');

      // bot√µes [[btn:acao|R√≥tulo]]
      text = text.replace(/\[\[btn:([^\]|]+)(?:\|([^\]]+))?\]\]/g, function(_m,action,label){
        const act = escapeHtml(action.trim());
        const lab = escapeHtml((label && label.trim()) || action.trim());
        return '<button class="lv-btn" data-action="'+act+'">'+lab+'</button>';
      });

      // callouts ::info texto
      text = text.replace(/^::(info|warn|success|question|aside)\s+(.*)$/gm,
        '<div class="lv-callout lv-$1">$2</div>');

      text = text.replace(/\*\*\*([^*]+)\*\*\*/g,'<strong><em>$1</em></strong>');
      text = text.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');
      text = text.replace(/\*([^*]+)\*/g,'<em>$1</em>');
      text = text.replace(/`([^`]+)`/g,'<code>$1</code>');

      text = text.replace(/```([\s\S]*?)```/g,function(_m,code){
        return '<pre><code>' + code.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</code></pre>';
      });

      text = text.replace(/^### (.*)$/gim,'<h3>$1</h3>');
      text = text.replace(/^## (.*)$/gim,'<h2>$1</h2>');
      text = text.replace(/^# (.*)$/gim,'<h1>$1</h1>');
      text = text.replace(/^> (.*)$/gim,'<blockquote>$1</blockquote>');
      text = text.replace(/^\s*[-*+] (.*)$/gim,'<li>$1</li>');
      text = text.replace(/(<li>.*<\/li>)/gims,'<ul>$1</ul>');

      Object.keys(tableMap).forEach(id=>{
        text = text.replace(id, tableMap[id]);
      });

      return text;
    }

    function splitResponseCinematic(text){
      const parts = text.split(/\n{2,}/).map(p=>p.trim()).filter(Boolean);
      if (!parts.length){
        return [{
          kind:'middle',
          html:'<p>'+parseMarkdownBasic(text).replace(/\n/g,'<br/>')+'</p>'
        }];
      }
      const blocks = [];
      parts.forEach((p,idx)=>{
        const kind = idx===0 ? 'intro' : (idx===parts.length-1 ? 'ending' : 'middle');
        const html = '<p>'+parseMarkdownBasic(p).replace(/\n/g,'<br/>')+'</p>';
        blocks.push({ kind, html });
      });
      return blocks;
    }

    function getBlockText(block){
      if (!block) return '';
      const raw = block.innerHTML
        .replace(/<button[^>]*class="block-tts-btn"[^>]*>[\s\S]*?<\/button>/gi,'')
        .replace(/<span[^>]*class="archetype-badge"[^>]*>[\s\S]*?<\/span>/gi,'')
        .replace(/<br\s*\/?>/gi,'\n')
        .replace(/<\/p>/gi,'\n\n')
        .replace(/<\/h[1-6]>/gi,'\n')
        .replace(/<li>/gi,'- ')
        .replace(/<\/li>/gi,'\n')
        .replace(/<[^>]+>/g,'');
      return raw.trim();
    }

 // -------------------
// Config (ajuste aqui)
// -------------------
const SPEAK_COUNT = 9; // padr√£o: √∫ltimos 9 blocos (use 1, 9, etc)
const PAUSE_BETWEEN_BLOCKS_MS = 120; // pausa entre blocos (vis√≠vel)
const SCROLL_OPTIONS = { behavior:'smooth', block:'center', inline:'nearest' };
const HIGHLIGHT_CLASS = 'speaking';
const HIGHLIGHT_DURATION = 90;

// -------------------
// Helpers existentes (mantidos)
// -------------------
function detectArchetypeFromText(text){
  if (!text) return null;
  const t = text.toLowerCase();
  let best = null;
  let bestScore = 0;
  Object.entries(ARCHETYPE_KEYWORDS).forEach(([name,words])=>{
    let score = 0;
    if (t.includes(name.toLowerCase())) score += 10;
    words.forEach(w=>{
      if (t.includes(String(w).toLowerCase())) score++;
    });
    if (score > bestScore){
      bestScore = score;
      best = name;
    }
  });
  return bestScore > 0 ? best : null;
}

function markBlockArchetype(div, archeName){
  if (!div || !archeName) return;
  div.dataset.archetype = archeName;
  let badge = div.querySelector('.archetype-badge');
  if (!badge){
    badge = document.createElement('span');
    badge.className = 'archetype-badge';
    div.appendChild(badge);
  }
  badge.textContent = archeName;
}

// -------------------
// TTS original (mantido sem altera√ß√£o)
// -------------------
function speakBlock(block){
  if (!synth){
    footerHint.textContent = 'Seu navegador n√£o suporta voz (SpeechSynthesis).';
    return;
  }
  if (!block){
    footerHint.textContent = 'Nenhum bloco selecionado.';
    return;
  }
  const text = getBlockText(block);
  if (!text){
    footerHint.textContent = 'Nada para ler nesse bloco.';
    return;
  }

  const detectedArch = detectArchetypeFromText(text);
  if (detectedArch){
    currentVoiceKey = detectedArch;
    localStorage.setItem('ARCHETYPE_ACTIVE', detectedArch);
    localStorage.setItem(STORAGE.VOICE_CURRENT_KEY, currentVoiceKey);
    markBlockArchetype(block, detectedArch);
    updateVoiceOrbLabel();
  }

  //try{block.scrollIntoView({ behavior:'smooth', block:'nearest', inline:'nearest' });}catch(e){}scrollToBottom();

  if (synth.speaking){
    synth.cancel();
    voiceBtn.classList.remove('speaking');
  }

  const utter = new SpeechSynthesisUtterance(text);

  let profile = null;
  if (voiceConfig){
    if (currentVoiceKey && voiceConfig[currentVoiceKey]){
      profile = voiceConfig[currentVoiceKey];
    } else if (voiceConfig.default){
      profile = voiceConfig.default;
    }
  }

  const lang  = profile && profile.lang  ? profile.lang  : 'pt-BR';
  const rate  = (profile && typeof profile.rate  === 'number') ? profile.rate  : 1;
  const pitch = (profile && typeof profile.pitch === 'number') ? profile.pitch : 1;
  const vol   = (profile && typeof profile.volume === 'number') ? profile.volume : 1;

  utter.lang   = lang;
  utter.rate   = rate;
  utter.pitch  = pitch;
  utter.volume = vol;

  if (profile && profile.voiceHint && availableVoices && availableVoices.length){
    const hint = String(profile.voiceHint).toLowerCase();
    let chosen = availableVoices.find(v=>v.name.toLowerCase().includes(hint));
    if (!chosen) chosen = availableVoices.find(v=>v.lang === lang) || null;
    if (chosen) utter.voice = chosen;
  }

  currentUtterance = utter;

  utter.onstart = ()=>{
    voiceBtn.classList.add('speaking');
    footerHint.textContent = 'Lendo o bloco em voz alta.';
  };
  utter.onend = ()=>{
    voiceBtn.classList.remove('speaking');
    footerHint.textContent = 'Leitura conclu√≠da.';
  };
  utter.onerror = ()=>{
    voiceBtn.classList.remove('speaking');
    footerHint.textContent = 'Erro ao tentar falar.';
  };

  synth.cancel();
  synth.speak(utter);
}

// -------------------
// Promise wrapper que reaproveita sua speakBlock
// - n√£o altera speakBlock, apenas observa currentUtterance.onend
// - funciona tamb√©m quando SpeechSynthesis n√£o existe (heur√≠stica timed fallback)
// -------------------
function speakBlockPromise(block){
  return new Promise((resolve) => {
    if (!block) return resolve();

    const text = (typeof getBlockText === 'function') ? getBlockText(block) : (block && (block.innerText || block.textContent)) || '';
    if (!text) return resolve();

    // visual + scroll
    try { block.scrollIntoView(SCROLL_OPTIONS); } catch(e){}
    block.dataset.state = 'spoken';
    block.classList.add(HIGHLIGHT_CLASS);

    // se a API existe e a fun√ß√£o speakBlock ir√° criar currentUtterance:
    if (typeof synth !== 'undefined' && synth && 'speak' in synth && typeof speakBlock === 'function'){
      // chama a tua fun√ß√£o (ela define currentUtterance internamente)
      try {
        // Guardamos refer√™ncia para o utterance que ser√° criada
        // Depois do speakBlock ser chamado, currentUtterance dever√° apontar para o novo utter.
        speakBlock(block);
      } catch (e){
        console.warn('speakBlock threw', e);
        // fallback para timeout
        const estMs = Math.min(Math.max(text.length * 35, 500), 12000);
        setTimeout(finish, estMs);
        return;
      }

      // Se currentUtterance existe, anexamos onend empacotado (preservando handler original)
      const utter = currentUtterance;
      if (utter){
        const origOnEnd = utter.onend;
        let called = false;
        utter.onend = function(e){
          try { if (typeof origOnEnd === 'function') origOnEnd.call(this,e); } catch(err){ console.warn(err); }
          if (!called){
            called = true;
            finish();
          }
        };
        // Tamb√©m trate erro
        const origOnError = utter.onerror;
        utter.onerror = function(e){
          try { if (typeof origOnError === 'function') origOnError.call(this,e); } catch(err){ console.warn(err); }
          if (!called){
            called = true;
            finish();
          }
        };
        // Safety: se por algum motivo onend nunca vier, timeout extra
        const safetyTimeout = Math.min(Math.max(text.length * 60, 2000), 20000);
        setTimeout(()=>{ if (!called){ called = true; finish(); } }, safetyTimeout);
        return;
      } else {
        // currentUtterance n√£o foi definido (improv√°vel) -> fallback timed
        const estMs = Math.min(Math.max(text.length * 40, 500), 12000);
        setTimeout(finish, estMs);
        return;
      }

    } else {
      // sem synth: fallback simples baseado em tamanho do texto
      const estMs = Math.min(Math.max(text.length * 40, 500), 12000);
      setTimeout(finish, estMs);
      return;
    }

    // finaliza√ß√£o comum: remove destaque e resolve
    function finish(){
      setTimeout(()=>{ // pequeno atraso visual
        block.classList.remove(HIGHLIGHT_CLASS);
        resolve();
      }, HIGHLIGHT_DURATION);
    }
  });
}

// -------------------
// Sequ√™ncia: fala n blocos em ordem (usa speakBlockPromise)
// - count: n√∫mero de blocos (Infinity = todos)
// - opts.pauseBetween: pausa entre blocos
// - devolve Promise que resolve quando terminar
// -------------------
async function speakRecentBlocks(count = SPEAK_COUNT, opts = {}){
  if (!responseBlocks || !responseBlocks.length) return;
  let blocks;
  if (!isFinite(count)){
    blocks = Array.from(responseBlocks);
  } else {
    const start = Math.max(0, responseBlocks.length - count);
    blocks = responseBlocks.slice(start);
  }
  // filtra elementos presentes no DOM
  blocks = blocks.filter(b => b && b.parentNode);

  for (let i = 0; i < blocks.length; i++){
    const b = blocks[i];
    // garante que cada card seja marcado antes de falar
    if (b) b.dataset.state = 'spoken';
    await speakBlockPromise(b);
    if (opts.pauseBetween) await new Promise(r => setTimeout(r, opts.pauseBetween));
    else await new Promise(r => setTimeout(r, PAUSE_BETWEEN_BLOCKS_MS));
  }
}

// -------------------
// Compatibilidade com fun√ß√£o antiga speakLastBlock (agora chama speakRecentBlocks(1))
// -------------------
function speakLastBlock(){
  // comportamento legado: fala apenas o √∫ltimo bloco
  speakRecentBlocks(1);
}

// -------------------
// Bot√£o de voz: clique padr√£o fala √∫ltimos SPEAK_COUNT blocos
// Shift+click fala tudo (Infinity)
// -------------------
voiceBtn.addEventListener('click', (ev) => {
  const wantAll = ev.shiftKey === true;
  if (wantAll){
    speakRecentBlocks(Infinity);
  } else {
    speakRecentBlocks(SPEAK_COUNT);
  }
});

// -------------------
// onBlockClick: mant√©m tua l√≥gica, mas usa speakBlock (comportamento existente)
// -------------------
function onBlockClick(ev){
  const block = ev.currentTarget;
  block.classList.add('clicked');
  setTimeout(()=>block.classList.remove('clicked'),350);
  const state = block.dataset.state || 'idle';
  if (state === 'idle' || state === 'sent'){
    block.dataset.state = 'spoken';
    // mant√©m chamada direta ao speakBlock (como j√° faz)
    speakBlock(block);
  } else if (state === 'spoken'){
    block.dataset.state = 'sent';
    const text = getBlockText(block);
    if (text) sendPrompt(text,{ fromBlock:true });
  }
}

// -------------------
// addTtsButtonToBlock: mant√©m comportamento (usa speakBlock)
// -------------------
function addTtsButtonToBlock(div){
  if (!div || div.querySelector('.block-tts-btn')) return;
  const btn = document.createElement('button');
  btn.type = 'button';
  btn.className = 'block-tts-btn';
  btn.textContent = '‚óé';
  btn.addEventListener('click',(ev)=>{
    ev.stopPropagation();
    // mantemos a chamada direta √† tua fun√ß√£o original
    speakBlock(div);
  });
  div.appendChild(btn);
}

// -------------------
// enhanceBlock: igual (s√≥ garante push no array)
// -------------------
function enhanceBlock(div){
  if (!div) return;
  div.dataset.state = div.dataset.state || 'idle';
  div.addEventListener('click', onBlockClick);
  addTtsButtonToBlock(div);
  const t = getBlockText(div);
  const arch = detectArchetypeFromText(t);
  if (arch) markBlockArchetype(div, arch);
  if (!responseBlocks.includes(div)) responseBlocks.push(div);
}

if (bootBlock) enhanceBlock(bootBlock);

// -------------------
// appendBlocksFromData: ao anexar blocos, fala os √∫ltimos SPEAK_COUNT por padr√£o
// -------------------
function appendBlocksFromData(blocks){
  if (!blocks || !blocks.length) return;
  if (bootBlock){
    bootBlock.remove();
    bootBlock = null;
  }
  blocks.forEach(page=>{
    const div = document.createElement('div');
    div.className = 'response-block ' + (page.kind || 'middle');
    div.innerHTML = page.html;
    enhanceBlock(div);
    responseList.appendChild(div);
  });
  // scrollToBottom();
  // por padr√£o fala os √∫ltimos SPEAK_COUNT blocos
  speakRecentBlocks(SPEAK_COUNT);
}

// -------------------
// appendUserPulseBlock: mant√©m adi√ß√£o do bloco do usu√°rio (n√£o fala automaticamente)
// -------------------
function appendUserPulseBlock(text){
  if (!text) return;
  if (bootBlock){
    bootBlock.remove();
    bootBlock = null;
  }
  const div = document.createElement('div');
  div.className = 'response-block user-pulse';
  const html = '<p>'+parseMarkdownBasic(text).replace(/\n/g,'<br/>')+'</p>';
  div.innerHTML = html;
  enhanceBlock(div);
  responseList.appendChild(div);
  // por padr√£o n√£o fala automaticamente o bloco do usu√°rio
}
    // ===== SYSTEM PROMPT UNIFIED =====
    function buildSystemPrompt(){
      const userName = localStorage.getItem(STORAGE.USER_NAME) || 'humano';
      const asstName = localStorage.getItem(STORAGE.ASSISTANT_NAME) || 'Dual.Infodose';

      return [
        `${asstName} √© o assistente Cinem√°tico da Infodose, especializado em respostas em blocos.`,
        '1. Responda em portugu√™s por padr√£o.',
        '2. Use blocos curtos, com t√≠tulos, listas e callouts (::info, ::warn, ::success, ::question, ::aside) quando fizer sentido.',
        '3. Cada par√°grafo separado por linha vazia vira um bloco independente.',
        '4. Priorize explica√ß√µes pr√°ticas, exemplos e micro-a√ß√µes de 1%.',
        '5. Quando fizer sentido, use Tabelista (linhas com "- |" ) para estruturar compara√ß√µes.',
        '6. N√£o pe√ßa chave de API; assuma que a infraestrutura j√° est√° pronta do lado do usu√°rio.',
        `7. O usu√°rio se chama ${userName}; fale com ele pelo nome algumas vezes, mas sem exagero.`
      ].join('\n');
    }

    async function callOpenRouter(promptText){
      if (!CONFIG.AUTH_TOKEN){
        throw new Error('Defina a chave OpenRouter no painel de Config IA.');
      }

      const userName = localStorage.getItem(STORAGE.USER_NAME) || 'Voc√™';
      const asstName = localStorage.getItem(STORAGE.ASSISTANT_NAME) || 'Dual.Infodose';
      const sysPrompt = buildSystemPrompt();

      const messages = [
        { role:'system', content: sysPrompt },
        ...conversation,
        { role:'user', content: `${userName} diz: ${promptText}` }
      ];

      const body = {
        model: CONFIG.MODEL,
        temperature: CONFIG.TEMP,
        messages,
        max_tokens: 1200
      };

      const res = await fetch(CONFIG.API_URL,{
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'Authorization': CONFIG.AUTH_TOKEN,
          'HTTP-Referer': 'https://infodose.com.br',
          'X-Title':'Dual-Infodose Chat Cinem√°tico'
        },
        body: JSON.stringify(body)
      });

      if (!res.ok){
        const txt = await res.text().catch(()=> '');
        console.error('Erro IA:', txt);
        throw new Error('Falha na resposta da IA: '+res.status);
      }

      const data = await res.json();
      const choice = data.choices && data.choices[0];
      const content = choice?.message?.content || '(sem conte√∫do retornado)';

      conversation.push({ role:'user', content:promptText });
      conversation.push({ role:'assistant', content });

      return content;
    }

    async function sendPrompt(promptText, options){
      const opts = options || {};
      const fromBlock = !!opts.fromBlock;
      const text = (promptText || '').trim();
      if (!text) return;
      setCollapsed(false);
      if (!fromBlock) userInput.value = '';
      userInput.disabled = true;
      sendBtn.disabled   = true;
      const oldFooter = footerHint.textContent;
      footerHint.textContent = fromBlock
        ? 'Pulso em expans√£o a partir do bloco.'
        : 'Processando pulso.';

      if (synth && synth.speaking){
        synth.cancel();
        voiceBtn.classList.remove('speaking');
      }

      appendUserPulseBlock(text);

      try{
        // MODO LOCAL se n√£o houver chave
        if (!CONFIG.AUTH_TOKEN){
          const localMsg = [
            '::info Modo local ativo (sem OpenRouter).',
            '',
            'Voc√™ pode:',
            '- Abrir o painel de configura√ß√£o (engrenagem) e salvar uma chave OpenRouter;',
            '- Ou usar este espa√ßo como di√°rio simb√≥lico, clicando nos blocos para ouvir e reenviar.'
          ].join('\n');

          const cinematicBlocks = splitResponseCinematic(localMsg);
          appendBlocksFromData(cinematicBlocks);
          return;
        }

        const answer = await callOpenRouter(text);
        const cinematicBlocks = splitResponseCinematic(answer);
        appendBlocksFromData(cinematicBlocks);
      }catch(err){
        console.error(err);
        const errorBlocks = [{
          kind:'ending',
          html:'<p><strong>Ops.</strong> N√£o foi poss√≠vel falar com o OpenRouter agora. Verifique sua chave e tente novamente.</p>'
        }];
        appendBlocksFromData(errorBlocks);
      }finally{
        userInput.disabled = false;
        sendBtn.disabled   = false;
        userInput.focus();
        footerHint.textContent = oldFooter || 'Do seu jeito. Sempre √∫nico. Sempre seu.';
      }
    }

    async function handleSendFromInput(){
      const text = userInput.value.trim();
      if (!text) return;
      await sendPrompt(text,{ fromBlock:false });
    }

    sendBtn.addEventListener('click', handleSendFromInput);
    userInput.addEventListener('keydown', ev=>{
      if (ev.key === 'Enter' && !ev.shiftKey){
        ev.preventDefault();
        handleSendFromInput();
      }
    });

    copyBtn.addEventListener('click', async ()=>{
      let target = responseBlocks[responseBlocks.length - 1];
      if (!target && bootBlock) target = bootBlock;
      if (!target) return;
      const temp = getBlockText(target);
      if (!temp) return;
      try{
        await navigator.clipboard.writeText(temp);
        footerHint.textContent = 'Bloco copiado para a √°rea de transfer√™ncia.';
      }catch{
        footerHint.textContent = 'N√£o consegui copiar automaticamente.';
      }
    });

    pasteBtn.addEventListener('click', async ()=>{
      try{
        const txt = await navigator.clipboard.readText();
        if (txt) userInput.value = txt;
      }catch(e){}
    });

    function initParticles(){
      if (!window.particlesJS){
        console.warn('particlesJS n√£o encontrado.');
        return;
      }
      particlesJS('particles-js',{
        particles:{
          number:{ value:60, density:{ enable:true, value_area:800 } },
          color:{ value:['#00f5ff','#ff4bff','#ffffff'] },
          shape:{ type:'circle' },
          opacity:{ value:0.45, random:true },
          size:{ value:3, random:true },
          line_linked:{
            enable:true,
            distance:140,
            color:'#00f5ff',
            opacity:0.25,
            width:1
          },
          move:{
            enable:true,
            speed:1.2,
            direction:'none',
            random:false,
            straight:false,
            out_mode:'out',
            bounce:false
          }
        },
        interactivity:{
          detect_on:'canvas',
          events:{
            onhover:{ enable:true, mode:'grab' },
            onclick:{ enable:false, mode:'push' },
            resize:true
          },
          modes:{
            grab:{
              distance:160,
              line_linked:{ opacity:0.5 }
            }
          }
        },
        retina_detect:true
      });
    }

    function init(){
      if (initialized) return;
      initialized = true;

      restoreTheme();
      restoreNames();
      loadIaConfigFromStorage();
      loadVoiceConfigFromStorage();

      const archActive = localStorage.getItem('ARCHETYPE_ACTIVE');
      if (archActive){
        currentVoiceKey = archActive;
        localStorage.setItem(STORAGE.VOICE_CURRENT_KEY, currentVoiceKey);
      }
      updateVoiceOrbLabel();
      setCollapsed(true);
      initParticles();

      // üîÑ Roda-Viva Aleat√≥ria na abertura (12 UPA)
      const RV_ARCHES = ['Atlas','Nova','Vitalis','Pulse','Artemis','Serena','Kaos','Genus','Lumine','Rhea','Solus','Aion'];
      const randomArch = RV_ARCHES[Math.floor(Math.random()*RV_ARCHES.length)];
      localStorage.setItem('ARCHETYPE_ACTIVE', randomArch);
      if (bootText){
        const msg =
`[${randomArch}] Roda-Viva aleat√≥ria ativada.
Hoje quem abre o portal √© ${randomArch}.
Iniciando. Pulso simbi√≥tico detectado. Presen√ßa reconhecida.`;
        bootText.dataset.text = msg;
        bootText.textContent  = msg;
      }
      if (bootBlock){
        markBlockArchetype(bootBlock, randomArch);
      }
      if (typeof window.KOB_APPLY_VOICE_THEME === 'function'){
        window.KOB_APPLY_VOICE_THEME(randomArch.toLowerCase());
      }

      if (bootText) bootText.classList.add('pulse');
      if (bootBlock && synth){
        setTimeout(()=>{ try{ speakBlock(bootBlock); }catch(e){}; }, 700);
      }

      console.log('Dual Cinem√°tico + Roda-Viva inicializado. Arqu√©tipo inicial:', randomArch);
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>

<script>
// =============================================================
// KDX.DevPanel v4.0 ¬∑ Dashboard + Dev integrado no Dual78kChat
// Patch: UPLOAD multi + lists (KDX JSON/CSS/JS lists)
// =============================================================
(function(){

  // -------------------------------------------------
  // 0) Bot√£o de toggle (usa #icon-code se existir)
  // -------------------------------------------------
  const codeBtn = document.getElementById('icon-code');
  const hasCodeBtn = !!codeBtn;

  // Fallback: mini quadradinho no canto (pode remover se n√£o quiser)
  let fallbackBtn = null;
  if (!hasCodeBtn) {
    fallbackBtn = document.createElement('button');
    fallbackBtn.type = 'button';
    fallbackBtn.id = 'kdxDevToggleFallback';
    fallbackBtn.textContent = '</>';
    document.body.appendChild(fallbackBtn);
  }

  // -------------------------------------------------
  // 1) CSS do painel (integra com tokens existentes)
  // -------------------------------------------------
  const style = document.createElement('style');
  style.id = 'kdxDevPanelStyles';
  style.textContent = `
    /* KDX DevPanel v4.0 ‚Äì integrado */

    #kdxDevToggleFallback{
  position:fixed;
  bottom:12px;
  right:12px;
  padding:6px 10px;
  font-size:12px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(0,0,0,.78), rgba(6,10,22,.9));
  color:#fff;
  z-index:12;
  cursor:pointer;
  backdrop-filter: blur(6px);
  box-shadow:0 8px 20px rgba(0,0,0,.5);
}

/* -- painel centralizado (horizontal center, flutua acima do centro vertical) -- */
#kdxDevPanel{
  position:fixed;
  left:50%;
  transform:translateX(-50%) translateY(8px) scale(.995);
  bottom:auto;
  top:8vh;                         /* afasta do topo em telas maiores */
  width:min(760px, 95vw);         /* mais largo em desktop, responsivo */
  max-width:95vw;
  height:80vh;                    /* AUMENTADO: mais espa√ßo vertical */
  max-height:92vh;
  border-radius:16px;
  background:var(--bg-panel, rgba(6,10,22,.96));
  backdrop-filter:blur(14px) saturate(1.05);
  box-shadow:0 28px 60px rgba(0,0,0,.6);
  border:1px solid rgba(0,245,255,.18);
  color:var(--text, #e6f3ff);
  font-family:inherit;
  font-size:13px;
  display:flex;
  flex-direction:column;
  opacity:0;
  pointer-events:none;
  transition:opacity .22s cubic-bezier(.2,.9,.2,1), transform .22s ease;
  z-index:10;
  padding:8px;
}

/* aberto */
#kdxDevPanel.open{
  opacity:0.96;
  pointer-events:auto;
  transform:translateX(-50%) translateY(0) scale(1);
}


    /* header */
#kdxDevHeader{
  padding:8px 10px 6px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  border-bottom:1px solid rgba(255,255,255,.04);
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.09em;
  gap:10px;
}
#kdxDevHeader .left{
  display:flex;
  align-items:center;
  gap:10px;
}
#kdxDevHeader span{
  opacity:.85;
  cursor:pointer;
  font-weight:600;
  font-size:12px;
}


    /* TABS: pills com indicador e rolagem quando necess√°rio */
#kdxDevTabs{
  display:flex;
  gap:8px;
  padding:10px;
  align-items:center;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  border-bottom:1px solid rgba(255,255,255,.03);
  scrollbar-width:thin;
}
.kdxDevTab{
  flex:0 0 auto;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:8px 12px;
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:.06em;
  cursor:pointer;
  opacity:.78;
  border-radius:999px;
  background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.02));
  border:1px solid transparent;
  transition:all .18s ease;
  color:var(--text, #e6f3ff);
}
    .kdxDevTab:last-child{ border-right:none; }
    .kdxDevTab.active{
      opacity:1;
      background:var(--accent, #00f5ff);
      color:#000;
      font-weight:600;
    }

    .kdxDevSection{
      display:none;
      flex:1;
      padding:6px 8px 8px;
      overflow:auto;
    }
    .kdxDevSection.active{ display:block; }

    /* DASHBOARD ‚Äì cards bonitos pro usu√°rio */
    #kdxDevSection-dash{
      display:block;
    }
    #kdxDashIntro{
      font-size:11px;
      opacity:.8;
      margin-bottom:6px;
    }
    #kdxDashGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:6px;
      margin-bottom:6px;
    }
    .kdxDashCard{
      border-radius:10px;
      padding:6px 7px;
      background:
        radial-gradient(circle at 0 0, rgba(0,245,255,.24), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(255,75,255,.18), transparent 55%),
        rgba(2,5,14,.96);
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 10px 26px rgba(0,0,0,.65);
    }
    .kdxDashLabel{
      font-size:9px;
      text-transform:uppercase;
      letter-spacing:.08em;
      opacity:.7;
      margin-bottom:2px;
    }
    .kdxDashValue{
      font-size:13px;
      font-weight:600;
      margin-bottom:1px;
    }
    .kdxDashSub{
      font-size:10px;
      opacity:.75;
    }
    #kdxDashActions{
      display:flex;
      gap:4px;
      margin-top:4px;
    }
    #kdxDashActions button{
      flex:1;
      padding:5px 0;
      border-radius:999px;
      border:1px solid rgba(0,245,255,.45);
      background:rgba(1,3,10,.96);
      color:var(--text,#e4ecff);
      font-size:10px;
      cursor:pointer;
    }
    #kdxDashActions button:hover{
      background:rgba(0,245,255,.16);
    }

    /* LOG */
    #kdxLogFilter{
      width:100%;
      margin-bottom:4px;
      border-radius:6px;
      border:1px solid rgba(0,245,255,.4);
      background:rgba(2,5,14,.96);
      color:var(--text,#e4ecff);
      padding:3px 6px;
      font-size:11px;
    }
    #kdxDevLog{
      border-radius:8px;
      border:1px solid rgba(0,245,255,.24);
      background:rgba(1,3,10,.98);
      font-family:monospace;
      font-size:11px;
      padding:6px;
      max-height:calc(65vh - 110px);
      overflow:auto;
      white-space:pre-wrap;
    }
    .kdxLog-info{ color:#4cf; }
    .kdxLog-warn{ color:#ffb83b; }
    .kdxLog-error{ color:#ff4b6b; }
    .kdxLog-system{ color:#00ff9c; }

    /* Upload */
    .kdxUploadBox{
      border-radius:8px;
      border:1px dashed rgba(0,245,255,.32);
      background:rgba(255,255,255,.02);
      padding:6px;
      margin-bottom:8px;
    }
    .kdxUploadBox strong{
      font-size:11px;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    .kdxUploadBox input{
      margin-top:4px;
      font-size:11px;
      width:100%;
    }

    /* Editor */
    #kdxDevEditorWrap{
      border-radius:8px;
      border:1px solid rgba(0,245,255,.32);
      background:rgba(2,5,14,.98);
      min-height:160px;
      position:relative;
      overflow:hidden;
    }
    #kdxDevEditorText{
      width:100%;
      height:160px;
      background:transparent;
      border:none;
      color:var(--text,#e4ecff);
      font-family:monospace;
      font-size:11px;
      padding:6px;
      resize:none;
      outline:none;
    }
    #kdxDevEditorMonaco{
      position:absolute;
      inset:0;
      display:none;
    }
    #kdxDevRunBtn{
      margin-top:6px;
      width:100%;
      padding:6px;
      border-radius:7px;
      border:none;
      font-size:11px;
      font-weight:600;
      cursor:pointer;
      background:var(--accent,#00f5ff);
      color:#000;
      box-shadow:0 0 14px rgba(0,245,255,.45);
    }

    /* Terminal */
    #kdxDevTermOut{
      border-radius:8px;
      border:1px solid rgba(0,245,255,.24);
      background:rgba(1,3,10,.98);
      font-family:monospace;
      font-size:11px;
      padding:6px;
      min-height:120px;
      max-height:200px;
      overflow:auto;
      margin-bottom:4px;
    }
    #kdxDevTermIn{
      width:100%;
      border-radius:7px;
      border:1px solid rgba(0,245,255,.4);
      padding:5px 7px;
      font-size:11px;
      background:rgba(2,5,14,.98);
      color:var(--text,#e4ecff);
      font-family:monospace;
    }

    /* Presets */
    #kdxDevPresetList{
      list-style:none;
      padding:0;
      margin:0;
      max-height:160px;
      overflow:auto;
    }
    #kdxDevPresetList li{
      padding:4px 6px;
      border-radius:5px;
      background:rgba(0,245,255,.08);
      margin-bottom:3px;
      cursor:pointer;
      font-size:11px;
    }
    #kdxDevPresetList li:hover{
      background:rgba(0,245,255,.18);
    }
    #kdxDevPresetSave,
    #kdxDevExportJson,
    #kdxDevExportZip{
      width:100%;
      padding:6px;
      border-radius:7px;
      border:none;
      font-size:11px;
      cursor:pointer;
      margin-top:4px;
    }
    #kdxDevPresetSave{
      background:var(--accent,#00f5ff);
      color:#000;
      font-weight:600;
    }
    #kdxDevExportJson{
      background:rgba(7,12,28,1);
      color:var(--text,#e4ecff);
      border:1px solid rgba(0,245,255,.36);
    }
    #kdxDevExportZip{
      background:rgba(7,12,28,1);
      color:var(--text,#e4ecff);
      border:1px solid rgba(255,255,255,.35);
    }

    /* Apps */
    #kdxDevApps{
      font-size:11px;
    }
    #kdxDevApps > div{
      border-radius:7px;
      border:1px solid rgba(0,245,255,.22);
      padding:5px 6px;
      margin-bottom:6px;
      background:rgba(255,255,255,.02);
    }

    /* Perf */
    #kdxDevPerfInfo{
      border-radius:8px;
      border:1px solid rgba(0,245,255,.26);
      background:rgba(1,3,10,.96);
      padding:7px;
      font-size:11px;
      line-height:1.4;
    }
    #kdxDevPerfInfo span{
      display:block;
      margin-bottom:2px;
    }
  `;
  document.head.appendChild(style);

  // -------------------------------------------------
  // 2) Markup do painel (Dash + Dev tabs)
  // -------------------------------------------------
  const panel = document.createElement('aside');
  panel.id = 'kdxDevPanel';
  panel.innerHTML = `
    <div id="kdxDevHeader">
      <div>KDX Panel ¬∑ v4.0</div>
      <span id="kdxDevClose">fechar</span>
    </div>

    <div id="kdxDevTabs">
      <button class="kdxDevTab active" data-tab="dash">dash</button>
      <button class="kdxDevTab" data-tab="log">log</button>
      <button class="kdxDevTab" data-tab="upload">up</button>
      <button class="kdxDevTab" data-tab="editor">edit</button>
      <button class="kdxDevTab" data-tab="term">term</button>
      <button class="kdxDevTab" data-tab="presets">preset</button>
      <button class="kdxDevTab" data-tab="apps">apps</button>
      <button class="kdxDevTab" data-tab="perf">perf</button>
    </div>

    <!-- DASHBOARD -->
    <div id="kdxDevSection-dash" class="kdxDevSection active">
      <div id="kdxDashIntro">
        Painel do portal ¬∑ vis√£o r√°pida da sess√£o, arqu√©tipo, tema e IA.
      </div>
      <div id="kdxDashGrid">
        <div class="kdxDashCard">
          <div class="kdxDashLabel">assistente</div>
          <div class="kdxDashValue" id="kdxDashAssistant">‚Äî</div>
          <div class="kdxDashSub" id="kdxDashUser">Voc√™: ‚Äî</div>
        </div>
        <div class="kdxDashCard">
          <div class="kdxDashLabel">tema & arqu√©tipo</div>
          <div class="kdxDashValue" id="kdxDashTheme">‚Äî</div>
          <div class="kdxDashSub" id="kdxDashArch">Arqu√©tipo: ‚Äî</div>
        </div>
        <div class="kdxDashCard">
          <div class="kdxDashLabel">mensagens</div>
          <div class="kdxDashValue" id="kdxDashMsgs">0</div>
          <div class="kdxDashSub" id="kdxDashUserMsgs">Voc√™: 0</div>
        </div>
        <div class="kdxDashCard">
          <div class="kdxDashLabel">voz & IA</div>
          <div class="kdxDashValue" id="kdxDashVoice">default</div>
          <div class="kdxDashSub" id="kdxDashIa">IA: ‚Äî</div>
        </div>
      </div>
      <div id="kdxDashActions">
        <button id="kdxDashThemeBtn">alternar tema</button>
        <button id="kdxDashCollapseBtn">mostrar/ocultar chat</button>
      </div>
    </div>

    <!-- LOG -->
    <div id="kdxDevSection-log" class="kdxDevSection">
      <select id="kdxLogFilter">
        <option value="all">Todos</option>
        <option value="info">Info</option>
        <option value="warn">Warn</option>
        <option value="error">Erro</option>
        <option value="system">Sistema</option>
      </select>
      <div id="kdxDevLog"></div>
    </div>

    <!-- UPLOAD (PATCHED) -->
    <div id="kdxDevSection-upload" class="kdxDevSection">
      <div class="kdxUploadBox">
        <strong>JSON (vozes / presets)</strong>
        <input type="file" id="kdxJsonInput" accept=".json" multiple />
        <div id="kdxJsonList" style="margin-top:8px;font-size:12px;"></div>
        <div style="margin-top:6px;">
          <button id="kdxJsonClear" class="kdxDevPresetSave">Limpar JSONs</button>
        </div>
      </div>

      <div class="kdxUploadBox">
        <strong>CSS (estilos)</strong>
        <input type="file" id="kdxCssInput" accept=".css" multiple />
        <div id="kdxCssList" style="margin-top:8px;font-size:12px;"></div>
        <div style="margin-top:6px;">
          <button id="kdxCssClear" class="kdxDevExportJson">Limpar CSS</button>
        </div>
      </div>

      <div class="kdxUploadBox">
        <strong>JS patch</strong>
        <input type="file" id="kdxJsInput" accept=".js" multiple />
        <div id="kdxJsList" style="margin-top:8px;font-size:12px;"></div>
      </div>

      <small>JSON recente fica em <code>window.KDX_JSON_LAST</code>. Use m√∫ltiplos arquivos ou reenvie o mesmo arquivo ‚Äî aceitamos reuploads.</small>
    </div>

    <!-- EDITOR -->
    <div id="kdxDevSection-editor" class="kdxDevSection">
      <div id="kdxDevEditorWrap">
        <textarea id="kdxDevEditorText">// KDX Dev v4.0 ‚Äì escreva JS aqui e clique em Executar.</textarea>
        <div id="kdxDevEditorMonaco"></div>
      </div>
      <button id="kdxDevRunBtn">Executar no contexto da p√°gina</button>
    </div>

    <!-- TERMINAL -->
    <div id="kdxDevSection-term" class="kdxDevSection">
      <div id="kdxDevTermOut"></div>
      <input id="kdxDevTermIn" placeholder='help, clear, fps, blocks, eval 1+1...' />
    </div>

    <!-- PRESETS -->
    <div id="kdxDevSection-presets" class="kdxDevSection">
      <ul id="kdxDevPresetList"></ul>
      <button id="kdxDevPresetSave">Salvar c√≥digo atual</button>
      <button id="kdxDevExportJson">Exportar JSON (logs+presets)</button>
      <button id="kdxDevExportZip">Exportar ZIP</button>
    </div>

    <!-- APPS -->
    <div id="kdxDevSection-apps" class="kdxDevSection">
      <div id="kdxDevApps"></div>
    </div>

    <!-- PERF -->
    <div id="kdxDevSection-perf" class="kdxDevSection">
      <div id="kdxDevPerfInfo">
        <span id="kdxPerfFps">FPS: --</span>
        <span id="kdxPerfMem">Mem√≥ria: --</span>
        <span id="kdxPerfTicks">Ticks: --</span>
      </div>
    </div>
  `;
  document.body.appendChild(panel);

  // -------------------------------------------------
  // 3) Toggle / Tabs
  // -------------------------------------------------
  const closeBtn = document.getElementById('kdxDevClose');
  function togglePanel(){
    panel.classList.toggle('open');
  }
  if (codeBtn) {
    codeBtn.addEventListener('click', togglePanel);
  }
  if (fallbackBtn){
    fallbackBtn.addEventListener('click', togglePanel);
  }
  closeBtn.addEventListener('click', ()=> panel.classList.remove('open'));

  document.querySelectorAll('.kdxDevTab').forEach(tab=>{
    tab.addEventListener('click', ()=>{
      document.querySelectorAll('.kdxDevTab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.kdxDevSection').forEach(s=>s.classList.remove('active'));
      tab.classList.add('active');
      const id = tab.dataset.tab;
      const sec = document.getElementById('kdxDevSection-'+id);
      if (sec) sec.classList.add('active');
    });
  });

  // -------------------------------------------------
  // 4) DASHBOARD ‚Äì leitura de estado do Dual78kChat
  // -------------------------------------------------
  const dashAssistant  = document.getElementById('kdxDashAssistant');
  const dashUser       = document.getElementById('kdxDashUser');
  const dashTheme      = document.getElementById('kdxDashTheme');
  const dashArch       = document.getElementById('kdxDashArch');
  const dashMsgs       = document.getElementById('kdxDashMsgs');
  const dashUserMsgs   = document.getElementById('kdxDashUserMsgs');
  const dashVoice      = document.getElementById('kdxDashVoice');
  const dashIa         = document.getElementById('kdxDashIa');
  const dashThemeBtn   = document.getElementById('kdxDashThemeBtn');
  const dashCollapseBtn= document.getElementById('kdxDashCollapseBtn');

  function updateDash(){
    if (!dashAssistant) return;

    const asstEl = document.getElementById('assistantName');
    dashAssistant.textContent = asstEl && asstEl.textContent.trim()
      ? asstEl.textContent.trim()
      : 'Dual.Infodose';

    let userName = 'Voc√™';
    try{
      userName = localStorage.getItem('infodoseUserName') || 'Voc√™';
    }catch(e){}
    dashUser.textContent = 'Voc√™: ' + userName;

    const theme = document.body.dataset.theme || 'dark';
    dashTheme.textContent = theme;

    let arch = '‚Äî';
    try{
      arch = localStorage.getItem('ARCHETYPE_ACTIVE') || '‚Äî';
    }catch(e){}
    dashArch.textContent = 'Arqu√©tipo: ' + arch;

    const blocks = document.querySelectorAll('.response-block');
    const userBlocks = document.querySelectorAll('.response-block.user-pulse');
    dashMsgs.textContent = String(blocks.length);
    dashUserMsgs.textContent = 'Voc√™: ' + String(userBlocks.length);

    let vKey = 'default';
    try{
      vKey = localStorage.getItem('infodoseVoiceCurrentKey') || 'default';
    }catch(e){}
    dashVoice.textContent = vKey;

    const iaLabel = document.getElementById('iaStatus');
    dashIa.textContent = iaLabel && iaLabel.textContent.trim()
      ? iaLabel.textContent.trim()
      : 'sem chave ou modelo definido';
  }

  if (dashThemeBtn){
    dashThemeBtn.addEventListener('click', ()=>{
      const cycle = ['dark','vibe','medium'];
      const current = document.body.dataset.theme || 'dark';
      const idx = cycle.indexOf(current);
      const next = cycle[(idx+1+cycle.length)%cycle.length];
      document.body.dataset.theme = next;
      try{
        localStorage.setItem('infodoseTheme', next);
      }catch(e){}
      updateDash();
    });
  }

  if (dashCollapseBtn){
    dashCollapseBtn.addEventListener('click', ()=>{
      const resp = document.getElementById('response');
      if (!resp) return;
      resp.classList.toggle('collapsed');
    });
  }

  // -------------------------------------------------
  // 5) LOG + Hook de console
  // -------------------------------------------------
  const logBox    = document.getElementById('kdxDevLog');
  const logFilter = document.getElementById('kdxLogFilter');
  const logs      = [];

  function appendLog(type, ...msg){
    logs.push({ type, msg, ts: Date.now() });
    renderLogs();
  }
  function renderLogs(){
    if (!logBox) return;
    const f = logFilter.value;
    logBox.innerHTML = '';
    logs.forEach(l=>{
      if (f !== 'all' && f !== l.type) return;
      const div = document.createElement('div');
      div.className = 'kdxLog-'+l.type;
      div.textContent = '['+l.type.toUpperCase()+'] '+l.msg.join(' ');
      logBox.appendChild(div);
    });
    logBox.scrollTop = logBox.scrollHeight;
  }
  logFilter.addEventListener('change', renderLogs);

  ['log','info','warn','error'].forEach(type=>{
    const orig = console[type];
    console[type] = function(...args){
      try{ orig.apply(console, args); }catch(e){}
      appendLog(type, ...args);
    };
  });
  appendLog('system','KDX DevPanel v4.0 iniciado.');

  // -------------------------------------------------
  // 6) UPLOAD MULTI HANDLERS (PATCH) - JSON / CSS / JS
  // -------------------------------------------------
  const jsonInput = document.getElementById('kdxJsonInput');
  const cssInput  = document.getElementById('kdxCssInput');
  const jsInput   = document.getElementById('kdxJsInput');

  // persistent lists on window for dev usage
  window.KDX_JSON_LIST = window.KDX_JSON_LIST || []; // [{name, jsonObj, ts}]
  window.KDX_CSS_LIST  = window.KDX_CSS_LIST  || []; // [{name, styleEl, ts}]
  window.KDX_JS_LIST   = window.KDX_JS_LIST   || []; // [{name, scriptEl, ts}]

  function escapeHtml(s){
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function renderJsonList(){
    const container = document.getElementById('kdxJsonList');
    if (!container) return;
    container.innerHTML = '';
    if (!window.KDX_JSON_LIST.length){
      container.textContent = 'Nenhum JSON carregado.';
      return;
    }
    window.KDX_JSON_LIST.forEach((item, idx)=>{
      const el = document.createElement('div');
      el.style.display='flex';
      el.style.justifyContent='space-between';
      el.style.alignItems='center';
      el.style.gap='8px';
      el.style.padding='4px 6px';
      el.style.borderBottom='1px solid rgba(255,255,255,.04)';
      el.innerHTML = `<div style="flex:1;font-size:12px">${escapeHtml(item.name)} <span style="opacity:.6;font-size:11px"> ¬∑ ${new Date(item.ts).toLocaleString()}</span></div>`;
      const btns = document.createElement('div');
      const apply = document.createElement('button');
      apply.textContent = 'Ativar';
      apply.style.marginRight='6px';
      apply.onclick = ()=> {
        // ativa esse config como VOICE_CONFIG (compat√≠vel com v√°rios setups)
        try{
          // store raw json in localStorage under a safe key
          localStorage.setItem('infodoseVoiceConfig', JSON.stringify(item.jsonObj));
          // attempt to pick a current key (first key) to be compatible with existing logic
          const firstKey = Object.keys(item.jsonObj || {})[0] || 'default';
          localStorage.setItem('infodoseVoiceCurrentKey', firstKey);
          // try set global vars if exist in host
          try{ window.voiceConfig = item.jsonObj; }catch(e){}
          try{ window.currentVoiceKey = firstKey; }catch(e){}
          appendLog('system','JSON de voz ativado: ' + item.name);
        }catch(e){
          appendLog('error','Erro ao ativar JSON:', e);
        }
      };
      const remove = document.createElement('button');
      remove.textContent = 'Remover';
      remove.onclick = ()=> {
        window.KDX_JSON_LIST.splice(idx,1);
        renderJsonList();
        appendLog('info','JSON removido:', item.name);
      };
      btns.appendChild(apply);
      btns.appendChild(remove);
      el.appendChild(btns);
      container.appendChild(el);
    });
  }

  function renderCssList(){
    const container = document.getElementById('kdxCssList');
    if (!container) return;
    container.innerHTML = '';
    if (!window.KDX_CSS_LIST.length){
      container.textContent = 'Nenhum CSS injetado.';
      return;
    }
    window.KDX_CSS_LIST.forEach((item, idx)=>{
      const el = document.createElement('div');
      el.style.display='flex';
      el.style.justifyContent='space-between';
      el.style.alignItems='center';
      el.style.padding='4px 6px';
      el.style.borderBottom='1px solid rgba(255,255,255,.04)';
      el.innerHTML = `<div style="flex:1;font-size:12px">${escapeHtml(item.name)} <span style="opacity:.6;font-size:11px"> ¬∑ ${new Date(item.ts).toLocaleString()}</span></div>`;
      const remove = document.createElement('button');
      remove.textContent = 'Remover';
      remove.onclick = ()=> {
        try{
          if (item.styleEl && item.styleEl.parentNode) item.styleEl.parentNode.removeChild(item.styleEl);
        }catch(e){}
        window.KDX_CSS_LIST.splice(idx,1);
        renderCssList();
        appendLog('info','CSS removido:', item.name);
      };
      el.appendChild(remove);
      container.appendChild(el);
    });
  }

  function renderJsList(){
    const container = document.getElementById('kdxJsList');
    if (!container) return;
    container.innerHTML = '';
    if (!window.KDX_JS_LIST.length){
      container.textContent = 'Nenhum JS injetado.';
      return;
    }
    window.KDX_JS_LIST.forEach((item, idx)=>{
      const el = document.createElement('div');
      el.style.display='flex';
      el.style.justifyContent='space-between';
      el.style.alignItems='center';
      el.style.padding='4px 6px';
      el.style.borderBottom='1px solid rgba(255,255,255,.04)';
      el.innerHTML = `<div style="flex:1;font-size:12px">${escapeHtml(item.name)} <span style="opacity:.6;font-size:11px"> ¬∑ ${new Date(item.ts).toLocaleString()}</span></div>`;
      const remove = document.createElement('button');
      remove.textContent = 'Remover';
      remove.onclick = ()=> {
        try{ if (item.scriptEl && item.scriptEl.parentNode) item.scriptEl.parentNode.removeChild(item.scriptEl); }catch(e){}
        window.KDX_JS_LIST.splice(idx,1);
        renderJsList();
        appendLog('info','JS removido:', item.name);
      };
      el.appendChild(remove);
      container.appendChild(el);
    });
  }

  // JSON input (multiple files or sequential)
  if (jsonInput){
    jsonInput.addEventListener('change', async e=>{
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      for (const file of files){
        try{
          const txt = await file.text();
          const json = JSON.parse(txt);
          window.KDX_JSON_LIST.push({ name: file.name, jsonObj: json, ts: Date.now() });
          window.KDX_JSON_LAST = json; // mant√©m compatibilidade com c√≥digo antigo
          appendLog('system','JSON carregado: ' + file.name);
        }catch(err){
          appendLog('error','JSON inv√°lido:', file.name, err);
        }
      }
      renderJsonList();
      // permite re-upload do mesmo arquivo
      jsonInput.value = '';
    });
  }

  // CSS input (multiple)
  if (cssInput){
    cssInput.addEventListener('change', async e=>{
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      for (const file of files){
        try{
          const css = await file.text();
          const style = document.createElement('style');
          style.dataset.kdxCssName = file.name;
          style.textContent = css;
          document.head.appendChild(style);
          window.KDX_CSS_LIST.push({ name: file.name, styleEl: style, ts: Date.now() });
          appendLog('system','CSS extra injetado: ' + file.name);
        }catch(err){
          appendLog('error','Erro injetando CSS:', file.name, err);
        }
      }
      renderCssList();
      cssInput.value = '';
    });
  }

  // JS input (multiple)
  if (jsInput){
    jsInput.addEventListener('change', async e=>{
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      for (const file of files){
        try{
          const js = await file.text();
          const s = document.createElement('script');
          s.dataset.kdxJsName = file.name;
          s.textContent = js;
          document.head.appendChild(s);
          window.KDX_JS_LIST.push({ name: file.name, scriptEl: s, ts: Date.now() });
          appendLog('system','JS patch injetado: ' + file.name);
        }catch(err){
          appendLog('error','Erro injetando JS:', file.name, err);
        }
      }
      renderJsList();
      jsInput.value = '';
    });
  }
// --- Persist√™ncia (localStorage) ---
const CSS_STORAGE_KEY = 'KDX_CSS_STORAGE_v1';

function saveCssListToLocalStorage(){
  try{
    const serial = window.KDX_CSS_LIST.map(item => ({ name: item.name, css: item.styleEl ? item.styleEl.textContent : '', ts: item.ts }));
    localStorage.setItem(CSS_STORAGE_KEY, JSON.stringify(serial));
    appendLog('system','KDX CSS salvo em localStorage ('+serial.length+' itens)');
  }catch(e){
    appendLog('error','Erro salvando CSS em localStorage:', e);
  }
}

function loadCssListFromLocalStorage(){
  try{
    const raw = localStorage.getItem(CSS_STORAGE_KEY);
    if (!raw) return;
    const arr = JSON.parse(raw);
    arr.forEach(it=>{
      try{
        const style = document.createElement('style');
        style.dataset.kdxCssName = it.name;
        style.textContent = it.css || '';
        document.head.appendChild(style);
        window.KDX_CSS_LIST.push({ name: it.name, styleEl: style, ts: it.ts || Date.now() });
      }catch(e){
        appendLog('warn','Falha ao reinjetar CSS:', it.name, e);
      }
    });
    appendLog('system','KDX CSS carregado do localStorage ('+(arr.length||0)+' itens)');
  }catch(e){
    appendLog('warn','Erro lendo CSS do localStorage:', e);
  }
}
  // Clear buttons
  const jsonClearBtn = document.getElementById('kdxJsonClear');
  if (jsonClearBtn) jsonClearBtn.addEventListener('click', ()=>{
    window.KDX_JSON_LIST = [];
    window.KDX_JSON_LAST = null;
    // Also clear stored infodose voice config keys (non-destructive if keys not present)
    try{ localStorage.removeItem('infodoseVoiceConfig'); localStorage.removeItem('infodoseVoiceCurrentKey'); }catch(e){}
    renderJsonList();
    appendLog('info','Lista de JSONs limpa.');
  });

  const cssClearBtn = document.getElementById('kdxCssClear');
  if (cssClearBtn) cssClearBtn.addEventListener('click', ()=>{
    // remove style elements
    (window.KDX_CSS_LIST || []).forEach(item=>{
      try{ if (item.styleEl && item.styleEl.parentNode) item.styleEl.parentNode.removeChild(item.styleEl); }catch(e){}
    });
    window.KDX_CSS_LIST = [];
    renderCssList();
    appendLog('info','Lista de CSS limpa.');
  });

  // Inicializa renderiza√ß√µes (caso j√° existam)
 // ao inicializar a p√°gina
loadCssListFromLocalStorage();
renderJsonList();
renderCssList();
renderJsList();

  // -------------------------------------------------
  // 7) Editor + Monaco opcional
  // -------------------------------------------------
  const editorText   = document.getElementById('kdxDevEditorText');
  const monacoSlot   = document.getElementById('kdxDevEditorMonaco');
  const runBtn       = document.getElementById('kdxDevRunBtn');
  let monacoEditor   = null;
  let monacoLoaded   = false;

  function getEditorCode(){
    if (monacoEditor) return monacoEditor.getValue();
    return editorText.value;
  }

  function ensureMonaco(cb){
    if (monacoLoaded && window.monaco && monacoEditor) return cb && cb();
    if (window.monaco && window.require){
      monacoLoaded = true;
      return createMonaco(cb);
    }
    const exist = document.querySelector('script[data-kdx-monaco-loader]');
    if (exist){
      exist.addEventListener('load', ()=> bootMonaco(cb));
      return;
    }
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.0/min/vs/loader.min.js';
    s.dataset.kdxMonacoLoader = '1';
    s.onload = ()=> bootMonaco(cb);
    document.head.appendChild(s);
  }

  function bootMonaco(cb){
    if (!window.require) return;
    window.require.config({
      paths:{ 'vs':'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.0/min/vs' }
    });
    window.require(['vs/editor/editor.main'], function(){
      monacoLoaded = true;
      createMonaco(cb);
    });
  }

  function createMonaco(cb){
    if (!window.monaco || monacoEditor) return cb && cb();
    monacoSlot.style.display = 'block';
    editorText.style.display = 'none';
    monacoEditor = window.monaco.editor.create(monacoSlot,{
      value: editorText.value || '// DevPanel Monaco conectado.',
      language:'javascript',
      theme:'vs-dark',
      automaticLayout:true,
      minimap:{enabled:false},
      fontSize:12
    });
    appendLog('system','Monaco carregado.');
    if (cb) cb();
  }

  runBtn.addEventListener('click', ()=>{
    const code = getEditorCode();
    try{
      const result = eval(code);
      appendLog('info','Resultado:', result);
    }catch(err){
      appendLog('error','Erro ao executar c√≥digo:', err);
    }
  });

  // Opcional: carrega Monaco depois de alguns segundos
  setTimeout(()=>{ ensureMonaco(); }, 1500);

  // -------------------------------------------------
  // 8) Terminal
  // -------------------------------------------------
  const termOut = document.getElementById('kdxDevTermOut');
  const termIn  = document.getElementById('kdxDevTermIn');
  const termHistory = [];
  let termIndex     = -1;

  function termPrint(prefix, text){
    const line = document.createElement('div');
    line.textContent = prefix + ' ' + text;
    termOut.appendChild(line);
    termOut.scrollTop = termOut.scrollHeight;
  }

  termPrint('>','Terminal KDX v4.0. Comandos: help');

  function handleCommand(cmd){
    if (cmd === 'help'){
      termPrint('>','help, clear, fps, blocks, eval <js>');
      return;
    }
    if (cmd === 'clear'){
      termOut.innerHTML = '';
      return;
    }
    if (cmd === 'fps'){
      termPrint('>','FPS: '+lastFps);
      return;
    }
    if (cmd === 'blocks'){
      const blocks = document.querySelectorAll('.response-block');
      termPrint('>','response-blocks: '+blocks.length);
      blocks.forEach((b,i)=>{
        termPrint('>','#'+i+' '+(b.dataset.archetype||'sem archetype'));
      });
      return;
    }
    if (cmd.startsWith('eval ')){
      const js = cmd.slice(5);
      try{
        const res = eval(js);
        termPrint('>','=> '+String(res));
      }catch(err){
        termPrint('>','Erro: '+err);
      }
      return;
    }
    try{
      const res = eval(cmd);
      termPrint('>','=> '+String(res));
    }catch(err){
      termPrint('>','(erro: '+err+')');
    }
  }

  termIn.addEventListener('keydown', e=>{
    if (e.key === 'Enter'){
      e.preventDefault();
      const cmd = termIn.value.trim();
      if (!cmd) return;
      termHistory.push(cmd);
      termIndex = termHistory.length;
      termPrint('$', cmd);
      termIn.value = '';
      handleCommand(cmd);
    } else if (e.key === 'ArrowUp'){
      if (!termHistory.length) return;
      termIndex = Math.max(0, termIndex-1);
      termIn.value = termHistory[termIndex] || '';
    } else if (e.key === 'ArrowDown'){
      if (!termHistory.length) return;
      termIndex = Math.min(termHistory.length, termIndex+1);
      termIn.value = termHistory[termIndex] || '';
    }
  });

  // -------------------------------------------------
  // 9) Presets + Export JSON/ZIP
  // -------------------------------------------------
  const presetList   = document.getElementById('kdxDevPresetList');
  const presetSave   = document.getElementById('kdxDevPresetSave');
  const exportJson   = document.getElementById('kdxDevExportJson');
  const exportZip    = document.getElementById('kdxDevExportZip');

  function loadPresets(){
    const store = JSON.parse(localStorage.getItem('KDX_PRESETS') || '{}');
    presetList.innerHTML = '';
    Object.entries(store).forEach(([name, code])=>{
      const li = document.createElement('li');
      li.textContent = name;
      li.addEventListener('click', ()=>{
        if (monacoEditor) monacoEditor.setValue(code);
        else editorText.value = code;
        appendLog('system','Preset carregado: '+name);
      });
      presetList.appendChild(li);
    });
  }
  loadPresets();

  presetSave.addEventListener('click', ()=>{
    const name = 'Preset-'+new Date().toISOString();
    const code = getEditorCode();
    const store = JSON.parse(localStorage.getItem('KDX_PRESETS') || '{}');
    store[name] = code;
    localStorage.setItem('KDX_PRESETS', JSON.stringify(store));
    loadPresets();
    appendLog('system','Preset salvo: '+name);
  });

  function downloadBlob(name, blob){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = name;
    a.click();
    URL.revokeObjectURL(url);
  }

  exportJson.addEventListener('click', ()=>{
    const data = {
      logs,
      presets: JSON.parse(localStorage.getItem('KDX_PRESETS') || '{}'),
      jsonLast: window.KDX_JSON_LAST || null,
      kdx_json_list: window.KDX_JSON_LIST || [],
      kdx_css_list: (window.KDX_CSS_LIST || []).map(i=>({name:i.name, ts:i.ts})),
      kdx_js_list: (window.KDX_JS_LIST || []).map(i=>({name:i.name, ts:i.ts}))
    };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    downloadBlob('kdx-devpanel-export.json', blob);
    appendLog('system','Export JSON gerado.');
  });

  function ensureJSZip(cb){
    if (window.JSZip) return cb && cb();
    const exist = document.querySelector('script[data-kdx-jszip]');
    if (exist){
      exist.addEventListener('load', ()=> cb && cb());
      return;
    }
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
    s.dataset.kdxJszip = '1';
    s.onload = ()=> cb && cb();
    document.head.appendChild(s);
  }

  exportZip.addEventListener('click', ()=>{
    ensureJSZip(()=>{
      if (!window.JSZip){
        appendLog('error','JSZip n√£o carregou, usando JSON mesmo.');
        exportJson.click();
        return;
      }
      const zip = new window.JSZip();
      zip.file('logs.json', JSON.stringify(logs,null,2));
      zip.file('presets.json', localStorage.getItem('KDX_PRESETS') || '{}');
      if (window.KDX_JSON_LAST){
        zip.file('json_last.json', JSON.stringify(window.KDX_JSON_LAST,null,2));
      }
      zip.generateAsync({type:'blob'}).then(blob=>{
        downloadBlob('kdx-devpanel-bundle.zip', blob);
        appendLog('system','ZIP exportado.');
      });
    });
  });

  // -------------------------------------------------
  // 10) API de mini-apps + Inspector DualChat
  // -------------------------------------------------
  const appsBox = document.getElementById('kdxDevApps');
  window.KDX = window.KDX || {};
  window.KDX.registerPanel = function(name, html, fn){
    const box = document.createElement('div');
    box.innerHTML = '<strong>'+name+'</strong><div style="margin-top:4px;">'+html+'</div>';
    appsBox.appendChild(box);
    if (typeof fn === 'function') fn(box);
    appendLog('system','Mini-app registrado: '+name);
  };

  // Inspector de .response-block
  window.KDX.registerPanel(
    'Inspector DualChat',
    '<button data-kdx="scan" style="font-size:10px;padding:4px 6px;border-radius:6px;border:1px solid rgba(0,245,255,.4);background:transparent;color:inherit;width:100%;margin-top:3px;">Scan blocks</button><div data-kdx="list" style="margin-top:4px;max-height:150px;overflow:auto;"></div>',
    box=>{
      const btn  = box.querySelector('[data-kdx="scan"]');
      const list = box.querySelector('[data-kdx="list"]');
      btn.addEventListener('click', ()=>{
        const blocks = Array.from(document.querySelectorAll('.response-block'));
        list.innerHTML = '';
        if (!blocks.length){
          list.textContent = 'Nenhum .response-block encontrado.';
          return;
        }
        blocks.forEach((b,i)=>{
          const bt = document.createElement('button');
          bt.textContent = '#'+i+' ¬∑ '+(b.dataset.archetype || 'sem arqu√©tipo');
          bt.style.display = 'block';
          bt.style.width = '100%';
          bt.style.fontSize = '10px';
          bt.style.marginBottom = '3px';
          bt.style.borderRadius = '6px';
          bt.style.border = '1px solid rgba(0,245,255,.3)';
          bt.style.background = 'rgba(0,245,255,.08)';
          bt.addEventListener('click', ()=>{
            b.scrollIntoView({behavior:'smooth', block:'center'});
            b.style.outline = '2px solid var(--accent,#00f5ff)';
            setTimeout(()=> b.style.outline = '', 1400);
            appendLog('info','Inspect bloco #'+i, (b.innerText||'').slice(0,120));
          });
          list.appendChild(bt);
        });
      });
    }
  );

  // -------------------------------------------------
  // 11) Perf HUD + loop que tamb√©m atualiza o Dash
  // -------------------------------------------------
  const perfFps   = document.getElementById('kdxPerfFps');
  const perfMem   = document.getElementById('kdxPerfMem');
  const perfTicks = document.getElementById('kdxPerfTicks');

  let lastFps = 0;
  let frames  = 0;
  let lastT   = performance.now();
  let ticks   = 0;

  function loop(ts){
    frames++;
    ticks++;
    const dt = ts - lastT;
    if (dt >= 1000){
      lastFps = Math.round(frames * 1000 / dt);
      frames  = 0;
      lastT   = ts;
      if (perfFps)   perfFps.textContent   = 'FPS: '+lastFps;
      if (perfTicks) perfTicks.textContent = 'Ticks: '+ticks;
      if (perfMem){
        if (performance && performance.memory){
          const m = performance.memory;
          const used = (m.usedJSHeapSize / 1048576).toFixed(1);
          const total = (m.totalJSHeapSize / 1048576).toFixed(1);
          perfMem.textContent = 'Mem√≥ria: '+used+' / '+total+' MB';
        } else {
          perfMem.textContent = 'Mem√≥ria: API n√£o dispon√≠vel';
        }
      }
      // Atualiza o Dashboard 1x por segundo
      updateDash();
    }
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

})();
</script>


<script>
// KDX.DevPanel ¬∑ Bot√£o DEV + inje√ß√£o de SVG em bot√µes de copiar configura√ß√£o
(function(){
  const ID = 'kdxDevMiniToggle';
  const MAX_TRIES = 12;
  const INTERVAL_MS = 500;

  // SVGs embutidos
  const SVG_GEAR = `
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false"
         xmlns="http://www.w3.org/2000/svg">
      <path d="M12 15.5A3.5 3.5 0 1112 8.5a3.5 3.5 0 010 7z" fill="currentColor"/>
      <path d="M19.4 13.1a7.9 7.9 0 000-2.2l2.1-1.6a.5.5 0 00.12-.64l-2-3.46a.5.5 0 00-.6-.22l-2.5 1a8 8 0 00-1.9-1.1l-.38-2.65a.5.5 0 00-.5-.42h-4a.5.5 0 00-.5.42l-.38 2.66a8 8 0 00-1.9 1.1l-2.5-1a.5.5 0 00-.6.22l-2 3.46a.5.5 0 00.12.64L4.6 10.9a7.9 7.9 0 000 2.2L2.5 14.7a.5.5 0 00-.12.64l2 3.46c.13.23.4.33.63.23l2.5-1a8 8 0 001.9 1.1l.38 2.66c.05.25.26.42.5.42h4c.24 0 .45-.17.5-.42l.38-2.66a8 8 0 001.9-1.1l2.5 1c.23.1.5 0 .63-.23l2-3.46a.5.5 0 00-.12-.64l-2.1-1.6z" fill="currentColor" opacity="0.85"/>
    </svg>
  `;

  const SVG_CLIP = `
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false"
         xmlns="http://www.w3.org/2000/svg">
      <path d="M16 2H8a2 2 0 00-2 2v1" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
      <rect x="6" y="6" width="12" height="14" rx="2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M9 10h6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" opacity="0.9"/>
    </svg>
  `;

  // injeta SVG em um bot√£o (mant√©m label se houver)
  function injectSvgIntoButton(btn, svgHtml, opts = {}){
    if (!btn || !(btn instanceof HTMLElement)) return;
    // evita duplicar se j√° tiver
    if (btn.dataset.kdxSvgInjected === '1') return;
    const wrapper = document.createElement('span');
    wrapper.className = 'kdx-svg-wrap';
    wrapper.style.display = 'inline-flex';
    wrapper.style.alignItems = 'center';
    wrapper.style.gap = '6px';
    wrapper.style.pointerEvents = 'none'; // icon n√£o captura cliques
    wrapper.innerHTML = svgHtml;
    // opcional: posicionar antes do texto ou substituir conte√∫do
    if (opts.beforeText === false){
      // append after
      btn.appendChild(wrapper);
    } else {
      // prepend (default)
      btn.insertBefore(wrapper, btn.firstChild);
    }
    btn.dataset.kdxSvgInjected = '1';
    // ajuste est√©tico: reduzir texto padding-left se houver
    btn.style.display = btn.style.display || 'inline-flex';
    btn.style.alignItems = 'center';
    btn.style.gap = btn.style.gap || '6px';
  }

  // Seletor para detectar bot√µes de copiar configura√ß√£o
  const COPY_SELECTORS = [
    '.kdxCopyBtn',
    '[data-kdx-copy]',
    '.btn-copy-config',
    '.kdxCopyConfig',
    '[data-copy-config]'
  ].join(',');

  // cria bot√£o DEV (com √≠cone gear)
  function createButton(panel){
    if (!panel) return null;
    if (document.getElementById(ID)) return document.getElementById(ID);

    const anchor =
      document.getElementById('assistantName') ||
      document.getElementById('logoContainer') ||
      document.getElementById('kdxDevHeader') ||
      document.body;

    const btn = document.createElement('button');
    btn.id = ID;
    btn.type = 'button';
    btn.title = 'Abrir painel DEV';
    btn.setAttribute('aria-label','KDX Dev Toggle');
    // adicionar texto vis√≠vel para acessibilidade e tela pequena
    const txt = document.createElement('span');
    txt.textContent = 'DEV';
    txt.style.fontSize = '11px';
    txt.style.fontWeight = '600';
    txt.style.pointerEvents = 'none';

    Object.assign(btn.style, {
      fontSize: '4px',
      padding: '6px 10px',
      borderRadius: '999px',
      border: '1px solid rgba(0,245,255,.6)',
      background: 'linear-gradient(180deg, rgba(2,5,14,.98), rgba(6,10,22,.94))',
      color: '#00f5ff',
      marginLeft: '8px',
      cursor: 'pointer',
      opacity: '0.18',
      transition: 'opacity .12s ease, transform .09s ease',
      zIndex: 0,
      display: 'inline-flex',
      alignItems: 'center',
      gap: '8px'
    });

    // insert icon then text (prepend icon)
    btn.innerHTML = ''; // garantir vazio antes de injetar
    injectSvgIntoButton(btn, SVG_GEAR, { beforeText: true });
    btn.appendChild(txt);

    btn.addEventListener('mouseenter', ()=> btn.style.opacity = '1');
    btn.addEventListener('mouseleave', ()=> btn.style.opacity = '0.88');
    btn.addEventListener('mousedown', ()=> btn.style.transform = 'translateY(1px)');
    btn.addEventListener('mouseup', ()=> btn.style.transform = '');

    btn.addEventListener('click', ()=>{
      panel.classList.toggle('open');
      if (panel.classList.contains('open')) try{ panel.focus(); }catch(e){}
    });

    if (anchor !== document.body && anchor.parentNode){
      try{
        anchor.parentNode.insertBefore(btn, anchor.nextSibling);
      }catch(e){
        pinToCorner(btn);
      }
    } else {
      pinToCorner(btn);
    }

    console.info('[KDX] Bot√£o DEV anexado com SVG.');
    return btn;
  }

  function pinToCorner(btn){
    btn.style.position = 'fixed';
    btn.style.top = '12px';
    btn.style.right = '12px';
    btn.style.boxShadow = '0 6px 18px rgba(0,0,0,.45)';
    document.body.appendChild(btn);
  }

  // injeta SVG clipboard em bot√µes de copiar config j√° existentes
  function injectClipboardToExisting(){
    try{
      const nodes = Array.from(document.querySelectorAll(COPY_SELECTORS));
      nodes.forEach(btn=>{
        injectSvgIntoButton(btn, SVG_CLIP, { beforeText: true });
      });
      if (nodes.length) appendLog && appendLog('system', `SVG clipboard injetado em ${nodes.length} bot√µes.`);
    }catch(e){
      console.warn('[KDX] Erro ao injetar clipboard SVG:', e);
    }
  }

  // observa DOM para novos bot√µes de copy dinamicamente adicionados
  function observeForCopyButtons(){
    if (!('MutationObserver' in window)) return;
    const obs = new MutationObserver((mrs)=>{
      for (const m of mrs){
        for (const node of m.addedNodes){
          if (!(node instanceof HTMLElement)) continue;
          // se o n√≥ em si for bot√£o de copy
          if (node.matches && node.matches(COPY_SELECTORS)){
            injectSvgIntoButton(node, SVG_CLIP, { beforeText: true });
          }
          // ou se tiver descendentes que batam no seletor
          const found = node.querySelector && node.querySelector(COPY_SELECTORS);
          if (found) injectSvgIntoButton(found, SVG_CLIP, { beforeText: true });
        }
      }
    });
    obs.observe(document.documentElement || document.body, { childList: true, subtree: true });
    return obs;
  }

  // attachDevToggle orchestration (immediate, retries, observer)
  function attachDevToggle(){
    const panel = document.getElementById('kdxDevPanel');
    if (!panel) {
      console.warn('[KDX] DevPanel ainda n√£o existe ‚Äî attachDevToggle falhou (chamada direta).');
      return null;
    }
    // create button
    createButton(panel);
    // inject clipboard svg in existing copy buttons
    injectClipboardToExisting();
    // start observing copy buttons
    observeForCopyButtons();
    return true;
  }

  // retry and observer logic
  let tries = 0;
  let intervalId = null;
  let domObserver = null;

  function startRetry(){
    if (intervalId) return;
    intervalId = setInterval(()=>{
      tries++;
      const panel = document.getElementById('kdxDevPanel');
      if (panel){
        attachDevToggle();
        clearInterval(intervalId);
        intervalId = null;
        if (domObserver){ domObserver.disconnect(); domObserver = null; }
        return;
      }
      if (tries >= MAX_TRIES){
        clearInterval(intervalId);
        intervalId = null;
        console.warn('[KDX] DevPanel n√£o encontrado ap√≥s retries. Parando tentativas.');
      }
    }, INTERVAL_MS);
  }

  function startDomObserver(){
    if (domObserver) return;
    try{
      domObserver = new MutationObserver((mrs)=>{
        for (const m of mrs){
          for (const n of m.addedNodes){
            if (!(n instanceof HTMLElement)) continue;
            if (n.id === 'kdxDevPanel' || n.querySelector && n.querySelector('#kdxDevPanel')){
              attachDevToggle();
              if (intervalId){ clearInterval(intervalId); intervalId = null; }
              if (domObserver){ domObserver.disconnect(); domObserver = null; }
              return;
            }
          }
        }
      });
      domObserver.observe(document.documentElement || document.body, { childList:true, subtree:true });
    }catch(e){
      console.warn('[KDX] MutationObserver indispon√≠vel ‚Äî relying on retry only.', e);
    }
  }

  // bootstrap
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ()=>{
      if (!attachDevToggle()){
        startRetry();
        startDomObserver();
      }
    });
  } else {
    if (!attachDevToggle()){
      startRetry();
      startDomObserver();
    }
  }

  // exposed helper (opcional) para injetar em elementos espec√≠ficos manualmente
  window.KDX = window.KDX || {};
  window.KDX.injectCopyIcon = function(el){
    try{
      const node = (typeof el === 'string') ? document.querySelector(el) : el;
      if (!node) return false;
      injectSvgIntoButton(node, SVG_CLIP, { beforeText: true });
      return true;
    }catch(e){
      return false;
    }
  };

})();
</script>

<script>

/* === Drop-in: Stacks + AutoSave + Export integration (colar ap√≥s os scripts existentes) === */
(function(){
  // --- Config / keys (reaproveita STORAGE se existir) ---
  const LS_KEY = 'KDX_STACKS';
  const AUTO_KEY = 'KDX_STACKS_AUTOSAVE';
  const AUTO_INTERVAL_KEY = 'KDX_STACKS_AUTOSAVE_INTERVAL';

  // util simples
  function safeParse(s){ try { return JSON.parse(s||'{}'); } catch(e){ return {}; } }
  function loadStacks(){ return safeParse(localStorage.getItem(LS_KEY)); }
  function saveStacks(obj){ try { localStorage.setItem(LS_KEY, JSON.stringify(obj)); return true; } catch(e){ console.error('Salvar stacks falhou', e); return false; } }

  // detect existing containers
  const kdxApps = document.getElementById('kdxDevApps');
  const dumpTo = kdxApps || (function(){
    // fallback: cria um pequeno container flutuante
    let box = document.getElementById('kdx-stacks-fallback');
    if (!box){
      box = document.createElement('div');
      box.id = 'kdx-stacks-fallback';
      box.style.position = 'fixed';
      box.style.right = '12px';
      box.style.bottom = '90px';
      box.style.width = '320px';
      box.style.maxHeight = '44vh';
      box.style.overflow = 'auto';
      box.style.zIndex = 100000;
      box.style.background = 'linear-gradient(180deg, rgba(6,10,22,.98), rgba(2,4,12,.95))';
      box.style.border = '1px solid rgba(255,255,255,.04)';
      box.style.borderRadius = '12px';
      box.style.padding = '8px';
      document.body.appendChild(box);
    }
    return box;
  })();

  // make UI
  const wrapper = document.createElement('div');
  wrapper.style.marginTop = '8px';
  wrapper.innerHTML = `
    <strong>Stacks ¬∑ Conversas</strong>
    <div style="display:flex;gap:8px;margin-top:8px;">
      <input id="stackNameInput" placeholder="nome da stack" style="flex:1;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,.06);color:inherit">
      <button id="stackSaveBtn" class="kdxExportBtn json" style="flex:0 0 140px;padding:8px">Salvar</button>
    </div>
    <div style="margin-top:8px;max-height:160px;overflow:auto" id="stacksList"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="stacksExportAll" class="kdxExportBtn zip">üì¶ Exportar todas</button>
      <input id="stacksImportFile" type="file" accept="application/json" style="display:none" />
      <button id="stacksImportBtn" class="kdxExportBtn json">üìÇ Importar</button>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
      <label style="font-size:12px"><input id="stacksAutoToggle" type="checkbox"> Auto-save</label>
      <input id="stacksAutoInterval" type="number" min="5" value="15" style="width:70px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,.06);background:transparent;color:inherit">s
    </div>
  `;
  dumpTo.appendChild(wrapper);

  const nameInput = document.getElementById('stackNameInput');
  const saveBtn = document.getElementById('stackSaveBtn');
  const listEl = document.getElementById('stacksList');
  const exportAllBtn = document.getElementById('stacksExportAll');
  const importFile = document.getElementById('stacksImportFile');
  const importBtn = document.getElementById('stacksImportBtn');
  const autoToggle = document.getElementById('stacksAutoToggle');
  const autoIntervalInput = document.getElementById('stacksAutoInterval');

  // capture conv: prioriza `conversation` global, se n√£o existir pega .response-block
  function captureConversation(){
    try{
      if (window.conversation && Array.isArray(window.conversation) && window.conversation.length){
        // transform to consistent lightweight format
        return window.conversation.map((m,i)=>({
          role: m.role || (m.sender||'unknown'),
          content: (m.content || m.text || '').toString(),
          ts: Date.now() + i
        }));
      }
      // else DOM fallback
      const blocks = Array.from(document.querySelectorAll('.response-block'));
      return blocks.map((b,i)=>({
        role: b.classList.contains('user-pulse') ? 'user' : 'assistant',
        content: (b.innerText||b.textContent||'').trim(),
        archetype: b.dataset.archetype || null,
        ts: Date.now() + i
      }));
    }catch(e){
      console.error('captureConversation erro', e);
      return [];
    }
  }

  function renderList(){
    const stacks = loadStacks();
    listEl.innerHTML = '';
    const keys = Object.keys(stacks).sort().reverse();
    if (!keys.length){
      listEl.textContent = 'Nenhuma stack salva.';
      return;
    }
    keys.forEach(k=>{
      const row = document.createElement('div');
      row.style.display='flex';
      row.style.gap='6px';
      row.style.alignItems='center';
      row.style.marginBottom='6px';
      const title = document.createElement('div');
      title.textContent = k;
      title.style.flex = '1';
      title.style.cursor = 'pointer';
      title.title = 'Clique para abrir em nova aba';
      title.addEventListener('click', ()=>{
        const w = window.open('','_blank');
        w.document.write(`<pre style="white-space:pre-wrap;font-family:monospace;background:#04040a;color:#e6f3ff;padding:12px">${escapeHtml(JSON.stringify(stacks[k],null,2))}</pre>`);
      });

      const loadBtn = document.createElement('button'); loadBtn.textContent = '‚Ü∫'; loadBtn.title='carregar para window.KDX.LOADED_STACK';
      loadBtn.addEventListener('click', ()=>{
        window.KDX = window.KDX || {};
        window.KDX.LOADED_STACK = stacks[k];
        console.info('Stack carregada em window.KDX.LOADED_STACK', k);
        alert('Stack "'+k+'" carregada em window.KDX.LOADED_STACK');
      });

      const exportBtn = document.createElement('button'); exportBtn.textContent='‚¨áÔ∏è'; exportBtn.title='exportar essa stack';
      exportBtn.addEventListener('click', ()=>{
        const blob = new Blob([JSON.stringify({[k]:stacks[k]},null,2)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = k.replace(/\s+/g,'_') + '.json'; a.click();
        setTimeout(()=> URL.revokeObjectURL(a.href), 3000);
      });

      const delBtn = document.createElement('button'); delBtn.textContent = 'üóëÔ∏è';
      delBtn.addEventListener('click', ()=>{
        if (!confirm('Remover stack "'+k+'"?')) return;
        const s = loadStacks(); delete s[k]; saveStacks(s); renderList();
        console.info('Stack removida', k);
      });

      row.appendChild(title);
      row.appendChild(loadBtn);
      row.appendChild(exportBtn);
      row.appendChild(delBtn);
      listEl.appendChild(row);
    });
  }

  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // save current conversation as stack
  function saveCurrentStack(name){
    const key = name && name.trim() ? name.trim() : ('stack-'+new Date().toISOString());
    const s = loadStacks();
    s[key] = {
      meta: { name: key, created: new Date().toISOString(), count: 0 },
      conversation: captureConversation()
    };
    s[key].meta.count = s[key].conversation.length;
    const ok = saveStacks(s);
    if (ok) { renderList(); console.info('Stack salva', key); return key; }
    else { alert('Erro ao salvar stack (ver console)'); return null; }
  }

  saveBtn.addEventListener('click', ()=> {
    const key = saveCurrentStack(nameInput.value || null);
    if (key) { alert('Stack salva: ' + key); nameInput.value = ''; }
  });

  exportAllBtn.addEventListener('click', ()=>{
    const all = loadStacks();
    const blob = new Blob([JSON.stringify(all,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'kdx-stacks-'+new Date().toISOString()+'.json'; a.click();
    setTimeout(()=> URL.revokeObjectURL(a.href), 3000);
  });

  importBtn.addEventListener('click', ()=> importFile.click());
  importFile.addEventListener('change', async e=>{
    const f = e.target.files[0];
    if (!f) return;
    try{
      const txt = await f.text();
      const incoming = JSON.parse(txt);
      const exist = loadStacks();
      Object.entries(incoming).forEach(([k,v])=>{
        let key = k;
        if (exist[key]) key = key + ' (import ' + new Date().toISOString() + ')';
        exist[key] = v;
      });
      saveStacks(exist);
      renderList();
      alert('Import conclu√≠do.');
    }catch(err){ console.error('import stack err', err); alert('Erro ao importar (veja console)'); }
  });

  // Auto-save logic
  function startAutoSave(){
    stopAutoSave();
    const enabled = autoToggle.checked;
    const intervalSec = Math.max(5, parseInt(autoIntervalInput.value||15,10));
    localStorage.setItem(AUTO_KEY, enabled ? '1' : '0');
    localStorage.setItem(AUTO_INTERVAL_KEY, String(intervalSec));
    if (!enabled) return;
    window._kdxStacksAutoTimer = setInterval(()=>{
      // salva somente se houver conte√∫do
      const conv = captureConversation();
      if (conv && conv.length) {
        const name = 'auto-'+new Date().toISOString();
        const s = loadStacks();
        s[name] = { meta:{ name, created:new Date().toISOString(), auto:true, count: conv.length }, conversation: conv };
        saveStacks(s);
        console.info('Auto-saved stack', name);
        renderList();
      }
    }, intervalSec * 1000);
  }
  function stopAutoSave(){
    if (window._kdxStacksAutoTimer) { clearInterval(window._kdxStacksAutoTimer); window._kdxStacksAutoTimer = null; }
  }
  // restore prefs
  (function restoreAutoPrefs(){
    const en = localStorage.getItem(AUTO_KEY) === '1';
    const iv = parseInt(localStorage.getItem(AUTO_INTERVAL_KEY) || '15',10);
    autoToggle.checked = en;
    autoIntervalInput.value = iv;
    if (en) startAutoSave();
  })();
  autoToggle.addEventListener('change', startAutoSave);
  autoIntervalInput.addEventListener('change', startAutoSave);

  // Integrar com bot√£o exportZip (se existir) para incluir stacks
  (function integrateWithExportZip(){
    const exportZipBtn = document.querySelector('.kdxExportBtn.zip') || document.getElementById('kdxDevExportZip');
    if (!exportZipBtn) return;
    // try to monkey-patch its click handler by wrapping its onclick / addEventListener
    const origHandler = exportZipBtn.onclick;
    exportZipBtn.addEventListener('click', (ev)=>{
      // if JSZip is used by page, try to append stacks file into the zip before original handler runs
      try{
        const stacks = loadStacks();
        if (!stacks || Object.keys(stacks).length === 0){ /* nothing to add */ }
        else if (window.JSZip){
          // create zip with stacks and allow original handler (which may create zip too)
          const zip = new window.JSZip();
          zip.file('kdx-stacks.json', JSON.stringify(stacks,null,2));
          zip.generateAsync({type:'blob'}).then(blob=>{
            // trigger download for stacks-only + let original's zip run too
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'kdx-stacks-'+new Date().toISOString()+'.json';
            a.style.display='none';
            document.body.appendChild(a); a.click();
            setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 2500);
          });
        } else {
          // fallback: offer to download stacks json directly
          const blob = new Blob([JSON.stringify(stacks,null,2)], {type:'application/json'});
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
          a.download = 'kdx-stacks-'+new Date().toISOString()+'.json'; a.click();
          setTimeout(()=> URL.revokeObjectURL(a.href), 3000);
        }
      }catch(e){ console.warn('N√£o foi poss√≠vel anexar stacks ao ZIP', e); }
      // do not block original handler; both will run
    });
    // keep original onclick if present
    if (typeof origHandler === 'function') exportZipBtn.addEventListener('click', origHandler);
  })();

  // initial render
  renderList();

  // expose helpers globally
  window.KDX = window.KDX || {};
  window.KDX.saveStack = saveCurrentStack;
  window.KDX.getStacks = loadStacks;

  console.info('KDX Stacks plugin initialized.');
})();

</script>

</body>
</html>
